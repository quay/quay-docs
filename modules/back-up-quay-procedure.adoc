== Backing up Red Hat Quay

This procedure is exclusively for OpenShift Container Platform and NooBaa deployments.

.Procedure

[NOTE]
====
The procedure in this documents uses the following namespace: `quay-enterprise`.
====

. Obtain a list of your deployed pods in your Quay namespace:
+
----
$ oc get pods -n quay-enterprise
----
+
Example output:
+
----
NAME                                                   READY   STATUS      RESTARTS   AGE
example-registry-clair-app-7dccddc6fd-fwckp            1/1     Running     0          69m
example-registry-clair-postgres-558d7cc9c-xgk2m        1/1     Running     0          68m
example-registry-quay-app-5677cb59b7-fpxcg             1/1     Running     0          69m
example-registry-quay-app-upgrade-zstr4                0/1     Completed   0          69m
example-registry-quay-config-editor-67c769f669-dp5gf   1/1     Running     0          69m
example-registry-quay-database-6d58c4c545-99s2g        1/1     Running     0          69m
example-registry-quay-mirror-d4bc9c99c-rmk4f           1/1     Running     0          68m
example-registry-quay-postgres-init-rwbsq              0/1     Completed   0          69m
example-registry-quay-redis-577776d494-k48zv           1/1     Running     0          69m
quay-operator.{productminv}-798d5c8b69-q6x88                  1/1     Running     0          79m
----

. Scale down the Quay Operator deployment:
+
[subs="verbatim,attributes"]
----
$ oc scale deployment quay-operator.{productminv} --replicas=0 -n quay-enterprise
----

. Scale down the Quay App deployment:
+
[subs="verbatim,attributes"]
----
$ oc scale deployment example-registry-quay-app --replicas=0 -n quay-enterprise
----

. Scale down the Quay Mirror deployment:
+
[subs="verbatim,attributes"]
----
$ oc scale deployment example-registry-quay-mirror --replicas=0 -n quay-enterprise
----

. You can ensure that the Quay Operator, Quay App, and Quay Mirror deployments have successfully scaled down by running the following command:
+
----
$ oc get deployment -n quay-enterprise
----
+
Example output:
+
----
NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE
example-registry-clair-app            1/1     1            1           56m
example-registry-clair-postgres       1/1     1            1           56m
example-registry-quay-app             0/0     0            0           56m
example-registry-quay-config-editor   1/1     1            1           56m
example-registry-quay-database        1/1     1            1           56m
example-registry-quay-mirror          0/0     0            0           56m
example-registry-quay-redis           1/1     1            1           56m
quay-operator.v3.5.7                  0/0     0            0           57m
----

. Display your Quay registry object in JSON format:
+
----
$ oc get quayregistries.quay.redhat.com -o json -n quay-enterprise
----
+
Example output:
+
[source,yaml]
+
----
  {
      "apiVersion": "v1",
      "items": [
          {
              "apiVersion": "quay.redhat.com/v1",
              "kind": "QuayRegistry",
              "metadata": {
                  "creationTimestamp": "2021-11-24T17:41:59Z",
                  "finalizers": [
                      "quay-operator/finalizer"
                  ],
                  "generation": 4,
                  "managedFields": [
  ...
                  ],
                  "name": "example-registry",
                  "namespace": "quay-enterprise",
                  "resourceVersion": "94514",
                  "selfLink": "/apis/quay.redhat.com/v1/namespaces/quay-enterprise/quayregistries/example-registry",
                  "uid": "03ee01da-615a-41e5-8840-e09d1fad0824"
              },
              "spec": {
                  "components": [
                      {
                          "kind": "postgres",
                          "managed": true
                      },
                      {
                          "kind": "objectstorage",
                          "managed": true
                      },
                      {
                          "kind": "redis",
                          "managed": true
                      },
                      {
                          "kind": "horizontalpodautoscaler",
                          "managed": true
                      },
                      {
                          "kind": "route",
                          "managed": true
                      },
                      {
                          "kind": "mirror",
                          "managed": true
                      },
                      {
                          "kind": "monitoring",
                          "managed": true
                      },
                      {
                          "kind": "tls",
                          "managed": true
                      },
                      {
                          "kind": "clair",
                          "managed": true
                      }
                  ],
                  "configBundleSecret": "example-registry-quay-config-bundle-z4gx8"
              }
----

. Obtain the `configBundleSecret`:
+
----
$ oc get quayregistries.quay.redhat.com -o jsonpath="{.items[0].spec.configBundleSecret}{'\n'}"  -n quay-enterprise
----
+
Example output:
+
----
example-registry-quay-config-bundle-z4gx8
----

. Set your Quay config bundle secret:
+
----
$ QUAY_CURR_CONFIG_BUNDLE=$( oc get quayregistries.quay.redhat.com -n quay-enterprise -o jsonpath="{.items[0].spec.configBundleSecret}{'\n'}" )
----

. Assign your backup directory:
+
----
$ QUAY_BACKUP_DIR="/var/tmp/quay-backup"
----

. Create a parent directory where you can store your config.yaml:
+
----
$ mkdir -pv "$QUAY_BACKUP_DIR/config"
----

. Set the name of your registry namespace to match the name of your Red Hat Quay on OpenShift namespace:
+
----
QUAY_NAMESPACE=quay-enterprise
----

. Extract the config bundle secret to your backup directory:
+
----
$ oc extract secret/"$QUAY_CURR_CONFIG_BUNDLE" -n "$QUAY_NAMESPACE" --to="${QUAY_BACKUP_DIR}/config/"
----
+
Example output:
+
----
/var/tmp/quay-backup/config/config.yaml
/var/tmp/quay-backup/config/extra_ca_cert_service-ca.crt
/var/tmp/quay-backup/config/ocp-cluster-wildcard.cert
----

. Obtain the full secret of your Quay deployment, including database, storage, Redis, etc.:
+
----
$ oc get deployment -n quay-enterprise example-registry-quay-app -o json | jq
----
+
Example output:
+
----
{
  "apiVersion": "apps/v1",
  "kind": "Deployment",
  "metadata": {
    "annotations": {
      "deployment.kubernetes.io/revision": "4",
      "quay-buildmanager-hostname": "",
      "quay-managed-fieldgroups": "Database,DistributedStorage,Redis,RepoMirror,SecurityScanner",
      "quay-operator-service-endpoint": "http://quay-operator.quay-enterprise:7071",
      "quay-registry-hostname": "example-registry-quay-quay-enterprise.apps.ci-ln-0956t32-76ef8.origin-ci-int-aws.dev.rhcloud.com"
    },
    "creationTimestamp": "2021-12-14T16:51:25Z",
    "generation": 5,
    "labels": {
      "app": "quay",
      "quay-component": "quay-app",
      "quay-operator/quayregistry": "example-registry"
    },
    "name": "example-registry-quay-app",
    "namespace": "quay-enterprise",
    "ownerReferences": [
      {
        "apiVersion": "quay.redhat.com/v1",
        "kind": "QuayRegistry",
        "name": "example-registry",
        "uid": "86f40e7b-7cda-48f8-b944-9417c1c686d8"
      }
    ],
    "resourceVersion": "54179",
    "selfLink": "/apis/apps/v1/namespaces/quay-enterprise/deployments/example-registry-quay-app",
    "uid": "114659e3-7034-496c-8479-7629035e16ce"
  },
  "spec": {
    "progressDeadlineSeconds": 600,
    "replicas": 0,
    "revisionHistoryLimit": 10,
    "selector": {
      "matchLabels": {
        "app": "quay",
        "quay-component": "quay-app",
        "quay-operator/quayregistry": "example-registry"
      }
    },
    "strategy": {
      "rollingUpdate": {
        "maxSurge": "25%",
        "maxUnavailable": "25%"
      },
      "type": "RollingUpdate"
    },
    "template": {
      "metadata": {
        "annotations": {
          "quay-buildmanager-hostname": "",
          "quay-managed-fieldgroups": "Database,DistributedStorage,Redis,RepoMirror,SecurityScanner",
          "quay-operator-service-endpoint": "http://quay-operator.quay-enterprise:7071",
          "quay-registry-hostname": "example-registry-quay-quay-enterprise.apps.ci-ln-0956t32-76ef8.origin-ci-int-aws.dev.rhcloud.com"
        },
        "creationTimestamp": null,
        "labels": {
          "app": "quay",
          "quay-component": "quay-app",
          "quay-operator/quayregistry": "example-registry"
        }
      },
      "spec": {
        "containers": [
          {
            "args": [
              "registry-nomigrate"
            ],
            "env": [
              {
                "name": "QE_K8S_CONFIG_SECRET",
                "value": "example-registry-quay-config-secret-b55666bckb"
              },
              {
                "name": "QE_K8S_NAMESPACE",
                "valueFrom": {
                  "fieldRef": {
                    "apiVersion": "v1",
                    "fieldPath": "metadata.namespace"
                  }
                }
              },
              {
                "name": "DEBUGLOG",
                "value": "false"
              },
              {
                "name": "WORKER_COUNT_WEB",
                "value": "4"
              },
              {
                "name": "WORKER_COUNT_SECSCAN",
                "value": "2"
              },
              {
                "name": "WORKER_COUNT_REGISTRY",
                "value": "8"
              }
            ],
            "image": "registry.redhat.io/quay/quay-rhel8@sha256:c599892160ac20c744d833603d9375923af7aec1edfd86982b7513e02fb6d463",
            "imagePullPolicy": "IfNotPresent",
            "name": "quay-app",
            "ports": [
              {
                "containerPort": 8443,
                "protocol": "TCP"
              },
              {
                "containerPort": 8080,
                "protocol": "TCP"
              },
              {
                "containerPort": 8081,
                "protocol": "TCP"
              },
              {
                "containerPort": 9091,
                "protocol": "TCP"
              }
            ],
            "readinessProbe": {
              "exec": {
                "command": [
                  "curl",
                  "-k",
                  "https://localhost:8443/health/instance"
                ]
              },
              "failureThreshold": 3,
              "initialDelaySeconds": 30,
              "periodSeconds": 15,
              "successThreshold": 1,
              "timeoutSeconds": 20
            },
            "resources": {
              "limits": {
                "cpu": "2",
                "memory": "8Gi"
              },
              "requests": {
                "cpu": "2",
                "memory": "8Gi"
              }
            },
            "terminationMessagePath": "/dev/termination-log",
            "terminationMessagePolicy": "File",
            "volumeMounts": [
              {
                "mountPath": "/conf/stack",
                "name": "configvolume"
              },
              {
                "mountPath": "/conf/stack/extra_ca_certs",
                "name": "extra-ca-certs",
                "readOnly": true
              }
            ]
          }
        ],
        "dnsPolicy": "ClusterFirst",
        "restartPolicy": "Always",
        "schedulerName": "default-scheduler",
        "securityContext": {},
        "terminationGracePeriodSeconds": 30,
        "volumes": [
          {
            "name": "configvolume",
            "secret": {
              "defaultMode": 420,
              "secretName": "example-registry-quay-config-secret-b55666bckb"
            }
          },
          {
            "configMap": {
              "defaultMode": 420,
              "name": "example-registry-cluster-service-ca"
            },
            "name": "extra-ca-certs"
          }
        ]
      }
    }
  },
  "status": {
    "conditions": [
      {
        "lastTransitionTime": "2021-12-14T16:54:23Z",
        "lastUpdateTime": "2021-12-14T16:54:23Z",
        "message": "Deployment has minimum availability.",
        "reason": "MinimumReplicasAvailable",
        "status": "True",
        "type": "Available"
      },
      {
        "lastTransitionTime": "2021-12-14T16:51:25Z",
        "lastUpdateTime": "2021-12-14T17:00:39Z",
        "message": "ReplicaSet \"example-registry-quay-app-7fc65dcbc5\" has successfully progressed.",
        "reason": "NewReplicaSetAvailable",
        "status": "True",
        "type": "Progressing"
      }
    ],
    "observedGeneration": 5
  }
}
----

. Extract your Quay registry secrets to your backup Quay directory:
+
----
$  oc extract secret/example-registry-quay-config-secret-b55666bckb -n quay-enterprise --keys=config.yaml --to=- > "${QUAY_BACKUP_DIR}/quay-config-secret.yaml"
----

. Ensure that your secrets are stored in the backup directory by running the following command:
+
----
$ cat $QUAY_BACKUP_DIR/quay-config-secret.yaml
----
+
Example output:
+
[source,yaml]
----
ALLOW_PULLS_WITHOUT_STRICT_LOGGING: false
AUTHENTICATION_TYPE: Database
AVATAR_KIND: local
BUILDLOGS_REDIS:
  host: example-registry-quay-redis
  port: 6379
DATABASE_SECRET_KEY: l0YkKJNXw494VeL6qxwJrN6HoecFDiylAR8-zgjbK1LvUInVatGYZINWSgAMX5vkIJLYCQGh7OckBuf0
DB_CONNECTION_ARGS:
  autorollback: true
  threadlocals: true
DB_URI: postgresql://example-registry-quay-database:OyC4zGhJMbi3yUzW1aIgOLQNW18r14nAcuJfbsjtrAXUVInj2JgwLskQPOutPCXMtlKr1UPTsIPqOEjV@example-registry-quay-database:5432/example-registry-quay-database
DEFAULT_TAG_EXPIRATION: 2w
DISTRIBUTED_STORAGE_CONFIG:
  local_us:
  - RHOCSStorage
  - access_key: VvoFhVFp8BqcOgQ9LczE
    bucket_name: quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf
    hostname: s3.openshift-storage.svc.cluster.local
    is_secure: true
    port: 443
    secret_key: XyThQKm6lMWh4O7dKdmRwMUHB9ktxPPVSRIePOY2
    storage_path: /datastorage/registry
DISTRIBUTED_STORAGE_DEFAULT_LOCATIONS:
- local_us
DISTRIBUTED_STORAGE_PREFERENCE:
- local_us
ENTERPRISE_LOGO_URL: /static/img/quay-horizontal-color.svg
...
----
+
[NOTE]
====
You will use `access_key`, `bucket_name`, `hostname`, and `secret_key` throughout the reset of this procedure.
====

. Gather the debugging information for your backup Quay directory:
+
----
$ oc adm inspect --dest-dir="${QUAY_BACKUP_DIR}/inspect-ns-quay-enterprise$(date +%Y%m%d%H%M)" ns/quay-enterprise
----
+
Example output:
+
----
Gathering data for ns/quay-enterprise...
Wrote inspect data to /var/tmp/quay-backup/inspect-ns-quay-enterprise202112141307.
----

. Create a backup directory for your Quay database:
+
----
$ mkdir -pv $QUAY_BACKUP_DIR/db
----

. Set your quay-enterprise database deployment:
+
----
$ DB_DEPLOYMENT="$(oc get deployment -n quay-enterprise | awk '/quay-database/ { print $1 }')"
----

. Obtain the PostgreSQL secret of your database deployment in JSON format:
+
----
$ oc get deployment/$DB_DEPLOYMENT -n quay-enterprise -o jsonpath="{.spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name}{'\n'}"
----
+
Example output:
+
----
example-registry-postgres-config-secret-59mhh799t8
----

. Apply the PostgreSQL secret to your database deployment:
+
----
$ DB_SECRET=$(oc get deployment/$DB_DEPLOYMENT -n quay-enterprise -o jsonpath="{.spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name}{'\n'}")
----

. Set a PostgreSQL database user name:
+
----
$ PSQL_USER="$(oc get secret/"$DB_SECRET" -n quay-enterprise -o template='{{ index .data "database-username" | base64decode }}')"
----

. Set the PostgreSQL database name:
+
----
$ PSQL_DB="$(oc get secret/"$DB_SECRET" -n quay-enterprise -o template='{{ index .data "database-name" | base64decode }}')"
----

. Set the Quay database pod name:
+
----
$ DB_POD="$(oc get pods -n quay-enterprise | awk '/quay-database/ { print $1 }')"
----

. Set the Quay backup file location:
+
----
$ QUAY_BACKUP_FILE="${QUAY_BACKUP_DIR}/db/${PSQL_DB}.sql"
----

. Create your backup file by running the following command:
+
----
$ oc exec "$DB_POD" -n quay-enterprise -- pg_dump -U "$PSQL_USER" -h localhost "$PSQL_DB"  > "$QUAY_BACKUP_FILE"
----
+
You can view the contents of your backup file by running the following command:
+
----
$ vi $QUAY_BACKUP_FILE
----
+
Example out
+
----
COPY public."user" (id, uuid, username, password_hash, email, verified, stripe_id, organization, robot, invoice_email, invalid_login_attempts, last_invalid_login, removed_tag_expiration_s, enabled, invoice_email_address, company, family_name, given_name, location, maximum_queued_builds_count, creation_date, last_accessed) FROM stdin;
1       8e731ec4-4d39-45ae-abf5-5d88bd4fe7cd    qad1504 $2b$12$njf1LbJ.YAW3dtEGJThK2uKh9Hxj5APknQ5dDsDlgH.p8sgtnmVYu    qad1504@example.com     t       \N      f       f       f       0       2021-11-29 17:14:31.899651      1209600 t       \N      \N      \N      \N      \N      \N      2021-11-29 17:14:31.899653      \N
2       01d6c6fe-b854-43fb-853a-ac6a3f914803    testorg \N      94020f5d-5f73-4d44-96de-c2be5fd8818e    f       \N      t       f       f       0       2021-11-29 17:16:36.522396      1209600 t       \N      \N      \N      \N      \N      \N      2021-11-29 17:16:36.522399      \N
3       c3867a3e-fd01-43dd-a137-39d80ffc5386    test1   $2b$12$OgNNWrv.uZSIKcLl.HPfVuTxny3Hi4YdSs6pLroiWVAgSeXa/0Cga    test1@example.com       t       \N      f       f       f       0       2021-11-29 17:20:01.897724      1209600 t       \N      \N      \N      \N      \N      \N      2021-11-29 17:20:01.897746      \N
4       63f254e3-8d48-438f-bfc1-060fe3bd474b    test2   $2b$12$hldE02yptVKhsaxi9qzPQOqZjrOFA96yyjqwfAmSkRdL48B2q6heq    test2@example.com       t       \N      f       f       f       0       2021-11-29 17:24:08.982127      1209600 t       \N      \N      \N      \N      \N      \N      2021-11-29 17:24:08.98213       \N
----

. Obtain the s3 route for your OpenShift storage namespace:
+
----
$  oc get route s3 -n openshift-storage -o yaml -o jsonpath="{.spec.host}{'\n'}"
----
+
Example output:
+
----
s3-openshift-storage.apps.docs2.quayteam.org
----

. Install the Amazon Web Services (AWS) CLI:
+
----
$ curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
----
+
----
$ unzip awscliv2.zip
----
+
----
$ sudo ./aws/install
----
+
----
$ /usr/local/bin/aws --version
----

. Obtain and export your AWS access key:
+
----
$ export AWS_ACCESS_KEY_ID=VvoFhVFp8Bqcxxxxxx
----
+
----
$ export AWS_SECRET_ACCESS_KEY=XyThQKm6lMWh4O7dKdmRwMUHB9ktxxxxxxx
----

. Sync your AWS s3 storage with your backup Quay directory:
+
----
$ aws s3 sync  --no-verify-ssl --endpoint-url=https://s3-openshift-storage.apps.docs2.quayteam.org s3://quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf/ "${QUAY_BACKUP_DIR}/data/"
----
+
Example output:
+
----
download: s3://quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf/datastorage/registry/sha256/a3/a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4 to ../../../var/tmp/quay-backup/data/datastorage/registry/sha256/a3/a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
download: s3://quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf/datastorage/registry/sha256/71/7138284460ffa3bb6ee087344f5b051468b3f8697e2d1427bac1a20c8d168b14 to ../../../var/tmp/quay-backup/data/datastorage/registry/sha256/71/7138284460ffa3bb6ee087344f5b051468b3f8697e2d1427bac1a20c8d168b14
download: s3://quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf/datastorage/registry/sha256/aa/aadc30fb0b879db4832927a9f0e6236fa66e209fecf448fc2cd2c2619ee8acb2 to ../../../var/tmp/quay-backup/data/datastorage/registry/sha256/aa/aadc30fb0b879db4832927a9f0e6236fa66e209fecf448fc2cd2c2619ee8acb2
----

. Scale up your Quay Operator deployment:
+
----
$ oc scale deployment quay-operator.v3.6.1 --replicas=1 -n quay-enterprise
----

. Scale up your Quay Application deployment:
+
----
$ oc scale deployment example-registry-quay-app --replicas=1 -n quay-enterprise
----

. Scale up your Quay Mirror deployment:
+
----
$ oc scale deployment example-registry-quay-mirror --replicas=1 -n quay-enterprise
----

. You can ensure that the Quay Operator, Quay App, and Quay Mirror deployments have successfully scaled up by running the following command:
+
----
$ oc get deployment -n quay-enterprise
----
+
Example output:
+
----
NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE
example-registry-clair-app            2/2     2            2           4d22h
example-registry-clair-postgres       1/1     1            1           4d22h
example-registry-quay-app             2/2     2            2           4d22h
example-registry-quay-config-editor   1/1     1            1           4d22h
example-registry-quay-database        1/1     1            1           4d22h
example-registry-quay-mirror          1/1     1            1           4d22h
example-registry-quay-redis           1/1     1            1           4d22h
----

. You can ensure your pods are running by running the following command:
+
----
$ oc get pods -n quay-enterprise
----
+
Example output:
+
----
NAME                                                   READY   STATUS      RESTARTS   AGE
example-registry-clair-app-5c5fdd6cf4-79l9l            1/1     Running     0          3d1h
example-registry-clair-app-5c5fdd6cf4-wsrp5            1/1     Running     0          3d1h
example-registry-clair-postgres-599cf4c4c9-bzmt5       1/1     Running     1          4d22h
example-registry-quay-app-7944ff6846-5thtg             1/1     Running     0          6m58s
example-registry-quay-app-7944ff6846-fdgwx             1/1     Running     0          3d1h
example-registry-quay-app-upgrade-dwz7m                0/1     Completed   0          3d1h
example-registry-quay-config-editor-7568ff5fd9-wl9d4   1/1     Running     0          3d1h
example-registry-quay-database-74d4ff7474-t562m        1/1     Running     0          4d22h
example-registry-quay-mirror-57f5878989-mz6k4          1/1     Running     0          3d1h
example-registry-quay-mirror-57f5878989-pc27v          1/1     Running     0          42s
example-registry-quay-postgres-init-6lrnh              0/1     Completed   0          3d1h
example-registry-quay-redis-56c456fd47-b5jlj           1/1     Running     0          4d22h
----

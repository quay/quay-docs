<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Early access documentation for Red Hat Quay 3.7.0</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css"/><meta name="generator" content="publican v4.3.2"/><meta name="description" content="Early access docs for 370 release"/><link rel="next" href="#quay-release-notes" title="Chapter 1. Red Hat Quay Release Notes"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><script type="text/javascript" src="Common_Content/scripts/jquery-1.7.1.min.js"> </script><script type="text/javascript" src="Common_Content/scripts/utils.js"> </script><script type="text/javascript" src="Common_Content/scripts/highlight.js/highlight.pack.js"> </script></head><body><div id="chrometwo"><div id="main"><div xml:lang="en-US" class="book" id="idm45834566022544"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat Quay</span> <span class="productnumber">3.7</span></div><div><h1 class="title">Early access documentation for Red Hat Quay 3.7.0</h1></div><div><h2 class="subtitle">Red Hat Quay Early Access Documentation</h2></div><div><div xml:lang="en-US" class="authorgroup"><span class="orgname">Red Hat OpenShift Documentation Team</span></div></div><div><a href="#idm45834542311648">Legal Notice</a></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				Early access docs for 370 release
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="chapter"><a href="#quay-release-notes">1. Red Hat Quay Release Notes</a></span><ul><li><span class="section"><a href="#rn-3-700">1.1. Version 3.7.0</a></span><ul><li><span class="section"><a href="#quay_clair_quay_builder">1.1.1. quay / clair / quay-builder</a></span></li><li><span class="section"><a href="#quay_operator">1.1.2. quay-operator</a></span></li><li><span class="section"><a href="#red_hat_quay_feature_tracker">1.1.3. Red Hat Quay feature tracker</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#quota_management">2. Quota management</a></span><ul><li><span class="section"><a href="#red-hat-quay-quota-management-and-enforcement">2.1. Red Hat Quay quota management and enforcement</a></span><ul><li><span class="section"><a href="#quota-management-arch">2.1.1. Quota management architecture</a></span></li><li><span class="section"><a href="#quota-management-limitations">2.1.2. Quota management limitations</a></span></li><li><span class="section"><a href="#red-hat-quay-quota-management-establishment">2.1.3. Establishing quota in Red Hat Quay</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#red_hat_quay_as_cache_proxy">3. Red Hat Quay as cache proxy</a></span><ul><li><span class="section"><a href="#quay-as-cache-proxy">3.1. Red Hat Quay as a proxy cache for upstream registries</a></span><ul><li><span class="section"><a href="#proxy-cache-architecture">3.1.1. Proxy cache architecture</a></span></li><li><span class="section"><a href="#proxy-cache-limitations">3.1.2. Proxy cache limitations</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#build_enhancements">4. Build Enhancements</a></span><ul><li><span class="section"><a href="#red-hat-quay-builders-enhancement">4.1. Red Hat Quay build enhancements</a></span><ul><li><span class="section"><a href="#red-hat-quay-builds-architecture">4.1.1. Red Hat Quay enhanced build architecture</a></span></li><li><span class="section"><a href="#red-hat-quay-build-limitations">4.1.2. Red Hat Quay build limitations</a></span></li></ul></li></ul></li></ul></div><section class="chapter" id="quay-release-notes"><div class="titlepage"><div><div><h1 class="title">Chapter 1. Red Hat Quay Release Notes</h1></div></div></div><p>
			Red Hat Quay is regularly released, containing new features, bug fixes, and software updates. We highly recommend deploying the latest version of Red Hat Quay.
		</p><p>
			For Red Hat Quay documentation, you should know that:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Documentation is versioned along with each major release
				</li><li class="listitem">
					The latest Red Hat Quay documentation is available from the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay">Red Hat Quay Documentation</a> page
				</li><li class="listitem">
					Prior to version 2.9.2, the product was referred to as Quay Enterprise
				</li></ul></div><p>
			Red Hat Quay, version 3 is the latest major version.
		</p><section class="section" id="rn-3-700"><div class="titlepage"><div><div><h2 class="title">1.1. Version 3.7.0</h2></div></div></div><section class="section" id="quay_clair_quay_builder"><div class="titlepage"><div><div><h3 class="title">1.1.1. quay / clair / quay-builder</h3></div></div></div><p>
					Added/Changed:
				</p><p>
					Fixed:
				</p></section><section class="section" id="quay_operator"><div class="titlepage"><div><div><h3 class="title">1.1.2. quay-operator</h3></div></div></div><p>
					Added/Changed:
				</p><p>
					Fixed:
				</p></section><section class="section" id="red_hat_quay_feature_tracker"><div class="titlepage"><div><div><h3 class="title">1.1.3. Red Hat Quay feature tracker</h3></div></div></div><p>
					New features have been added to Red Hat Quay, some of which are currently in Technology Preview. Technology Preview features are experimental features and are not intended for production use.
				</p><p>
					Some features available in previously releases have been deprecated or remove. Deprecated functionality is still included in Red Hat Quay, but is planned for removal in a future release and is not recommended for new deployments. For the most recent list of major functionality deprecated and remove with Red Hat Quay 3.7, refer to the table below. Additional details for more fine-grained functionality that has been deprecated and removed are listed after the table.
				</p><div class="table" id="idm45834561117472"><p class="title"><strong>Table 1.1. Technology Preview tracker</strong></p><div class="table-contents"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 50%; " class="col_1"/><col style="width: 50%; " class="col_2"/></colgroup><thead><tr><th align="left" valign="top" id="idm45834567273168" scope="col">Feature</th><th align="left" valign="top" id="idm45834561413088" scope="col">Quay 3.7</th></tr></thead></table></div></div><section class="section" id="deprecated_features"><div class="titlepage"><div><div><h4 class="title">1.1.3.1. Deprecated features</h4></div></div></div></section><section class="section" id="technology_preview_features"><div class="titlepage"><div><div><h4 class="title">1.1.3.2. Technology preview features</h4></div></div></div></section></section></section></section><section class="chapter" id="quota_management"><div class="titlepage"><div><div><h1 class="title">Chapter 2. Quota management</h1></div></div></div><section class="section" id="red-hat-quay-quota-management-and-enforcement"><div class="titlepage"><div><div><h2 class="title">2.1. Red Hat Quay quota management and enforcement</h2></div></div></div><p>
				With Red Hat Quay 3.7, users have the ability to report storage consumption and contain registry growth by establishing configured storage quota limits. Although there are no limitations on a Quay organization’s storage consumption, on-premises Quay customers subjected to capacity limits of their environment are now equipped with the following capabilities:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Quota reporting. With this feature, a super admin can track the storage consumption of all their organizations. Additionally, users can track the storage consumption of their assigned organization.
					</li><li class="listitem">
						Quota management. With this feature, a superuser can define soft and hard checks for Red Hat Quay users. Soft checks tell users if the storage consumption of an organization reaches their configured threshold. Hard checks prevent users from pushing to the registry when storage consumption reaches the configured limit.
					</li></ul></div><p>
				Together, these features allow service owners of a Quay registry to define service level agreements and support a healthy budget.
			</p><section class="section" id="quota-management-arch"><div class="titlepage"><div><div><h3 class="title">2.1.1. Quota management architecture</h3></div></div></div><p>
					<span class="inlinemediaobject"><img src="images/quota-management.png" alt="Quota management architecture"/></span>
				</p><p>
					The preceding image shows the expected design flow and architecture of the Quota management feature.
				</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
						With Red Hat Quay 3.7, boxes outlined in black show the current flow, and boxes outlined in green show what need to be implemented to support this feature.
					</p></div></div><p>
					Architecturally, the <code class="literal">RepositorySize</code> table holds the storage consumption, in bytes, of a Red Hat Quay repository within an organization. The sum of all repository sizes for an organization defines the current storage size of a Red Hat Quay organization. When an image push is initialized, the user’s organization storage is validated to check if it is beyond the configured quota limits. If an image push exceeds defined quota limitations, a soft or hard check occurs. For a soft check, users are notified, and for a hard check, the push is stopped. If storage consumption is within configured quota limits, the push happens as expected.
				</p><p>
					Image manifest deletion follows a similar flow, wherein the link between associated image tags and the manfiest are deleted. Additionally, after the image manifest is deleted, the repository size is recalculated and updated in the <code class="literal">RepositorySize</code> table. The image below represents the design flow and architecture when deleting an image manifest:
				</p><p>
					<span class="inlinemediaobject"><img src="images/manifest-deletion-architecture.png" alt="Manifest deletion architecture"/></span>
				</p></section><section class="section" id="quota-management-limitations"><div class="titlepage"><div><div><h3 class="title">2.1.2. Quota management limitations</h3></div></div></div><p>
					Quota management helps organizations maintain resource consumption, however there are a few limitations. For example, calculating resource consumption on push, as opposed to monitoring consumption with a background worker, does not take into account the usage data of existing images. To avoid potential issues, a backfill for all existing repositories is required before the feature is enabled. Additionally, calculation becomes part of a push’s critical path, otherwise the usage data could drift.
				</p></section><section class="section" id="red-hat-quay-quota-management-establishment"><div class="titlepage"><div><div><h3 class="title">2.1.3. Establishing quota in Red Hat Quay</h3></div></div></div><p>
					The following procedure describes how you can report storage consumption and establish storage quota limits.
				</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
							A valid Red Hat Quay repository.
						</li><li class="listitem">
							A superuser administrator.
						</li><li class="listitem">
							Enough storage to meet the demands of quota limitations.
						</li></ul></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist" type="1"><li class="listitem">
							Log in to your organization’s repository as a superuser.
						</li><li class="listitem">
							On the <span class="strong strong"><strong>Users and Organizations</strong></span> panel, click the name of the repository you want to define storage quota limits for.
						</li><li class="listitem"><p class="simpara">
							Click <span class="strong strong"><strong>Organization Settings</strong></span> on the left hand pane.
						</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
								Alternatively, you can establish quota management by clicking <span class="strong strong"><strong>Manage Organizations</strong></span> on the left hand pane, and then clicking <span class="strong strong"><strong>Settings</strong></span> → <span class="strong strong"><strong>Configure Quota</strong></span>.
							</p></div></div></li><li class="listitem">
							Set the organization quota to the desired amount in the <span class="strong strong"><strong>Quota Management</strong></span> section, for example, 10 GB.
						</li><li class="listitem">
							Set the percentage at which users will be warned when the organization reaches their defined threshold. For example, setting <span class="strong strong"><strong>Warning</strong></span> to 60 is equivalent to 60%.
						</li><li class="listitem">
							Set the percentage at which pushes are rejected from the organization. For example, setting <span class="strong strong"><strong>Rejected</strong></span> to 99 is equivalent to 99%.
						</li><li class="listitem">
							Click <span class="strong strong"><strong>Save Quota Details</strong></span>
						</li></ol></div><p>
					You can check the remaining storage on the <span class="strong strong"><strong>Repositories</strong></span> page of your organization.
				</p></section></section></section><section class="chapter" id="red_hat_quay_as_cache_proxy"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Red Hat Quay as cache proxy</h1></div></div></div><section class="section" id="quay-as-cache-proxy"><div class="titlepage"><div><div><h2 class="title">3.1. Red Hat Quay as a proxy cache for upstream registries</h2></div></div></div><p>
				With the growing popularity of container development, customers increasingly rely on container images from upstream registries like Docker or Google Cloud Platform to get services up and running. Today, registries have rate limitations and throttling on the number of times users can pull from these registries.
			</p><p>
				With this feature, Red Hat Quay will act as a proxy cache to circumvent pull-rate limitations from upstream registries. Adding a cache feature also accelerates pull performance, because images are pulled from the cache rather than upstream dependencies. Cached images are only updated when the upstream image digest differs from the cached image, reducing rate limitations and potential throttling.
			</p><p>
				With Red Hat Quay acting as a cache proxy for upstream registries, the following features are available:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Configuration of a Quay repository that acts as a cache for a specific upstream registry. This repository can be defined by the Quay config.yaml or the Quay UI.
					</li><li class="listitem">
						Leveraging of an organization’s storage quota to limit cache size.
					</li><li class="listitem">
						Cache and image streams transparency to client. Images in the proxy cache act similar to other images on Quay, and default behaviors such as security scanner, time machine, etc. are supported.
					</li><li class="listitem">
						Audit log that tracks all cache pulls.
					</li><li class="listitem">
						Cache dump to eliminate storage consumption.
					</li><li class="listitem">
						Robot account creation with Role Based Access Control (RBAC) management.
					</li><li class="listitem">
						Metrics to track cache activity and efficiency, for example, hit rate, size, and evictions.
					</li></ul></div><section class="section" id="proxy-cache-architecture"><div class="titlepage"><div><div><h3 class="title">3.1.1. Proxy cache architecture</h3></div></div></div><p>
					The following image shows the expected design flow and architecture of the proxy cache feature.
				</p><p>
					<span class="inlinemediaobject"><img src="images/cache-proxy-overview.png" alt="Proxy cache overview"/></span>
				</p><p>
					When a user pulls an image, for example, <code class="literal">postgres:14</code>, from an upstream repository on Red Hat Quay, the repository checks to see if an image is present. If the image does not exist, a fresh pull is initiated. After being pulled, the image layers are saved to cache and server to the user in parallel. The following image depicts an architectural overview of this scenario:
				</p><p>
					<span class="inlinemediaobject"><img src="images/cache-proxy-pulled-image.png" alt="Pulled image overview"/></span>
				</p><p>
					If the image in the cache exists, users can rely on Quay’s cache to stay up-to-date with the upstream source so that newer images from the cache are automatically pulled. This happens when tags of the original image have been overwritten in the upstream registry. The following image depicts an architectural overview of what happens when the upstream image and cached version of the image are different:
				</p><p>
					<span class="inlinemediaobject"><img src="images/updated-layers-in-cache.png" alt="Updating opposing layers overview"/></span>
				</p><p>
					If the upstream image and cached version are the same, no layers are pulled and the cached image is delivered to the user.
				</p><p>
					In some cases, users initiate pulls when the upstream registry is down. If this happens with the configured staleness period, the image stored in cache is delivered. If the pull happens after the configured staleness period, the error is propagated to the user. The following image depicts an architectural overview when a pull happens after the configured staleness period:
				</p><p>
					image: cache-proxy-staleness-pull.png[Staleness pull overview]
				</p><p>
					Quay administrators can leverage the configurable size limit of an organization to limit cache size so that backend storage consumption remains predictable. This is achieved by discarding images from the cache according to the frequency in which an image is used. The following image depicts an architectural overview of this scenario:
				</p><p>
					<span class="inlinemediaobject"/>
				</p></section><section class="section" id="proxy-cache-limitations"><div class="titlepage"><div><div><h3 class="title">3.1.2. Proxy cache limitations</h3></div></div></div><p>
					Proxy caching with Red Hat Quay has the following limitations:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Your proxy cache must have a size limit of greater than, or equal to, the image you want to cache. For example, if your proxy cache organization has a maximum size of 500 MB, and the image a user wants to pull is 700 MB, the image will be cached and will overflow beyond the configured limit.
						</li><li class="listitem">
							Cached images must have the same properties that images on a Quay repository must have.
						</li></ul></div></section></section></section><section class="chapter" id="build_enhancements"><div class="titlepage"><div><div><h1 class="title">Chapter 4. Build Enhancements</h1></div></div></div><section class="section" id="red-hat-quay-builders-enhancement"><div class="titlepage"><div><div><h2 class="title">4.1. Red Hat Quay build enhancements</h2></div></div></div><p>
				Prior to Red Hat Quay 3.7, Quay ran <code class="literal">podman</code> commands in virtual machines launched by pods. Running builds on virtual platforms requires enabling nested virtualization, which is not featured in Red Hat Enterprise Linux or OpenShift Container Platform. As a result, builds had to run on bare-metal clusters, which is an inefficient use of resources.
			</p><p>
				With Red Hat Quay 3.7., the bare-metal constraint required to run builds has been removed by adding an additional build option which does not contain the virtual machine layer. As a result, builds can be run on virtualized platforms. Backwards compatibility to run previous build configurations are also available.
			</p><section class="section" id="red-hat-quay-builds-architecture"><div class="titlepage"><div><div><h3 class="title">4.1.1. Red Hat Quay enhanced build architecture</h3></div></div></div><p>
					The preceding image shows the expected design flow and architecture of the enhanced build features:
				</p><p>
					<span class="inlinemediaobject"/>
				</p><p>
					With this enhancement, the build manager first creates the <code class="literal">Job Object</code>. Then, the <code class="literal">Job Object</code> then creates a pod using the <code class="literal">quay-builder-image</code>. The <code class="literal">quay-builder-image</code> will contain the <code class="literal">quay-builder binary</code> and the <code class="literal">Podman</code> service. The created pod runs as <code class="literal">unprivileged</code>. The <code class="literal">quay-builder binary</code> then builds the image while communicating status and retrieving build information from the Build Manager.
				</p></section><section class="section" id="red-hat-quay-build-limitations"><div class="titlepage"><div><div><h3 class="title">4.1.2. Red Hat Quay build limitations</h3></div></div></div><p>
					Running builds in Red Hat Quay in an unprivileged context might cause some commands that were working under the previous build strategy to fail. Attempts to change the build strategy could potentially cause performance issues and reliability with the build.
				</p><p>
					Running builds direclty in a container will not have the same isolation as using virtual machines. Changing the build environment might also caused builds that were previously working to fail.
				</p></section></section></section><div><div xml:lang="en-US" class="legalnotice" id="idm45834542311648"><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"/>© 2022 Red Hat, Inc.
	</div><div class="para">
		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). An explanation of CC-BY-SA is available at <a class="uri" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>. In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
	</div><div class="para">
		Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.
	</div><div class="para">
		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Linux</span>® is the registered trademark of Linus Torvalds in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Java</span>® is a registered trademark of Oracle and/or its affiliates.
	</div><div class="para">
		<span class="trademark">XFS</span>® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries.
	</div><div class="para">
		<span class="trademark">MySQL</span>® is a registered trademark of MySQL AB in the United States, the European Union and other countries.
	</div><div class="para">
		<span class="trademark">Node.js</span>® is an official trademark of Joyent. Red Hat is not formally related to or endorsed by the official Joyent Node.js open source or commercial project.
	</div><div class="para">
		The <span class="trademark">OpenStack</span>® Word Mark and OpenStack logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.
	</div><div class="para">
		All other trademarks are the property of their respective owners.
	</div></div></div></div></div></div><script type="text/javascript">
                        jQuery(document).ready(function() {
                            initSwitchery();
                            jQuery('pre[class*="language-"]').each(function(i, block){hljs.highlightBlock(block);});
                        });
                    </script></body></html>
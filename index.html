<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Early access documentation for Red Hat Quay 3.7.0</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css"/><meta name="generator" content="publican v4.3.2"/><meta name="description" content="Early access docs for 370 release"/><link rel="next" href="#quay-release-notes" title="Chapter 1. Red Hat Quay Release Notes"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><script type="text/javascript" src="Common_Content/scripts/jquery-1.7.1.min.js"> </script><script type="text/javascript" src="Common_Content/scripts/utils.js"> </script><script type="text/javascript" src="Common_Content/scripts/highlight.js/highlight.pack.js"> </script></head><body><div id="chrometwo"><div id="main"><div xml:lang="en-US" class="book" id="idm45383825715152"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat Quay</span> <span class="productnumber">3.7</span></div><div><h1 class="title">Early access documentation for Red Hat Quay 3.7.0</h1></div><div><h2 class="subtitle">Red Hat Quay Early Access Documentation</h2></div><div><div xml:lang="en-US" class="authorgroup"><span class="orgname">Red Hat OpenShift Documentation Team</span></div></div><div><a href="#idm45383806443344">Legal Notice</a></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				Early access docs for 370 release
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="chapter"><a href="#quay-release-notes">1. Red Hat Quay Release Notes</a></span><ul><li><span class="section"><a href="#rn-3-700">1.1. Version 3.7.0</a></span><ul><li><span class="section"><a href="#quota">1.1.1. Quota</a></span></li><li><span class="section"><a href="#proxy">1.1.2. Proxy</a></span></li><li><span class="section"><a href="#geo_replication">1.1.3. Geo-replication</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#quota_management">2. Quota management</a></span><ul><li><span class="section"><a href="#red-hat-quay-quota-management-and-enforcement">2.1. Red Hat Quay quota management and enforcement</a></span><ul><li><span class="section"><a href="#quota-management-arch">2.1.1. Quota management architecture</a></span></li><li><span class="section"><a href="#quota-management-limitations">2.1.2. Quota management limitations</a></span></li><li><span class="section"><a href="#red-hat-quay-quota-management-establishment">2.1.3. Establishing quota in Red Hat Quay</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#red_hat_quay_as_cache_proxy">3. Red Hat Quay as cache proxy</a></span><ul><li><span class="section"><a href="#quay-as-cache-proxy">3.1. Red Hat Quay as a proxy cache for upstream registries</a></span><ul><li><span class="section"><a href="#proxy-cache-architecture">3.1.1. Proxy cache architecture</a></span></li><li><span class="section"><a href="#proxy-cache-limitations">3.1.2. Proxy cache limitations</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#build_enhancements">4. Build Enhancements</a></span><ul><li><span class="section"><a href="#red-hat-quay-builders-enhancement">4.1. Red Hat Quay build enhancements</a></span><ul><li><span class="section"><a href="#red-hat-quay-builds-architecture">4.1.1. Red Hat Quay enhanced build architecture</a></span></li><li><span class="section"><a href="#red-hat-quay-build-limitations">4.1.2. Red Hat Quay build limitations</a></span></li><li><span class="section"><a href="#setting-up-builders">4.1.3. Preparing a Red Hat Quay builders environment with OpenShift</a></span></li><li><span class="section"><a href="#red-hat-quay-quota-builders-running">4.1.4. Running Red Hat Quay builders</a></span></li></ul></li></ul></li></ul></div><section class="chapter" id="quay-release-notes"><div class="titlepage"><div><div><h1 class="title">Chapter 1. Red Hat Quay Release Notes</h1></div></div></div><p>
			Red Hat Quay is regularly released, containing new features, bug fixes, and software updates. We highly recommend deploying the latest version of Red Hat Quay.
		</p><p>
			For Red Hat Quay documentation, you should know that:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Documentation is versioned along with each major release
				</li><li class="listitem">
					The latest Red Hat Quay documentation is available from the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay">Red Hat Quay Documentation</a> page
				</li><li class="listitem">
					Prior to version 2.9.2, the product was referred to as Quay Enterprise
				</li></ul></div><p>
			Red Hat Quay, version 3 is the latest major version.
		</p><section class="section" id="rn-3-700"><div class="titlepage"><div><div><h2 class="title">1.1. Version 3.7.0</h2></div></div></div><section class="section" id="quota"><div class="titlepage"><div><div><h3 class="title">1.1.1. Quota</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-302">PROJQUAY-302</a>. Quota Management and Enforcements
						</li></ul></div><section class="section" id="details"><div class="titlepage"><div><div><h4 class="title">1.1.1.1. Details</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-2936">ROJQUAY-2936</a>. Reporting API and Schema
							</li><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-2937">PROJQUAY-2937</a>. Repository Soft/Hard Limit Implementation
							</li></ul></div></section></section><section class="section" id="proxy"><div class="titlepage"><div><div><h3 class="title">1.1.2. Proxy</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-465">PROJQUAY-465</a>. Quay as a cache proxy / pull-through cache for other registries
						</li></ul></div><section class="section" id="design"><div class="titlepage"><div><div><h4 class="title">1.1.2.1. Design</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-2888">PROJQUAY-2888</a>. Quay as a cache proxy - Design: Proxy org creation and configuration
							</li><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-2889">PROJQUAY-2889</a>. Quay as a cache proxy - Design: Upstream image pull flow
							</li><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-2890">PROJQUAY-2890</a>. Quay as a cache proxy - Design: Local storage of upstream image layers and manifests
							</li><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-2891">PROJQUAY-2891</a>. Quay as a cache proxy - Design: Quota Management in Cache Proxy org Spike
							</li></ul></div></section><section class="section" id="user_stories"><div class="titlepage"><div><div><h4 class="title">1.1.2.2. User stories</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-3029">PROJQUAY-3029</a>. As a Quay user, I want to create and configure pull-through proxy orgs via UI
							</li><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-3030">PROJQUAY-3030</a>. As a Quay user I want to be able to proxy images through Quay orgs
							</li><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-3033">PROJQUAY-3033</a>. As a Quay user I want proxied images to be stored in Quay so that my pulls are faster
							</li></ul></div></section></section><section class="section" id="geo_replication"><div class="titlepage"><div><div><h3 class="title">1.1.3. Geo-replication</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-2504">PROJQUAY-2504</a>. Quay Operator supports geo-replication
						</li></ul></div><section class="section" id="details_2"><div class="titlepage"><div><div><h4 class="title">1.1.3.1. Details</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-3055">PROJQUAY-3055</a>. Environment variables override
							</li><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-3056">PROJQUAY-3056</a>. Scale down quay, clair and mirror
							</li><li class="listitem">
								<a class="link" href="https://issues.redhat.com/browse/PROJQUAY-1723">PROJQUAY-1723</a>. Multi-cluster deployment of Quay on OpenShift along with all components
							</li></ul></div></section></section></section></section><section class="chapter" id="quota_management"><div class="titlepage"><div><div><h1 class="title">Chapter 2. Quota management</h1></div></div></div><section class="section" id="red-hat-quay-quota-management-and-enforcement"><div class="titlepage"><div><div><h2 class="title">2.1. Red Hat Quay quota management and enforcement</h2></div></div></div><p>
				With Red Hat Quay 3.7, users have the ability to report storage consumption and contain registry growth by establishing configured storage quota limits. Although there are no limitations on a Quay organization’s storage consumption, on-premises Quay customers subjected to capacity limits of their environment are now equipped with the following capabilities:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Quota reporting. With this feature, a super admin can track the storage consumption of all their organizations. Additionally, users can track the storage consumption of their assigned organization.
					</li><li class="listitem">
						Quota management. With this feature, a superuser can define soft and hard checks for Red Hat Quay users. Soft checks tell users if the storage consumption of an organization reaches their configured threshold. Hard checks prevent users from pushing to the registry when storage consumption reaches the configured limit.
					</li></ul></div><p>
				Together, these features allow service owners of a Quay registry to define service level agreements and support a healthy budget.
			</p><section class="section" id="quota-management-arch"><div class="titlepage"><div><div><h3 class="title">2.1.1. Quota management architecture</h3></div></div></div><p>
					<span class="inlinemediaobject"><img src="images/quota-management.png" alt="Quota management architecture"/></span>
				</p><p>
					The preceding image shows the expected design flow and architecture of the Quota management feature.
				</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
						With Red Hat Quay 3.7, boxes outlined in black show the current flow, and boxes outlined in green show what need to be implemented to support this feature.
					</p></div></div><p>
					Architecturally, the <code class="literal">RepositorySize</code> table holds the storage consumption, in bytes, of a Red Hat Quay repository within an organization. The sum of all repository sizes for an organization defines the current storage size of a Red Hat Quay organization. When an image push is initialized, the user’s organization storage is validated to check if it is beyond the configured quota limits. If an image push exceeds defined quota limitations, a soft or hard check occurs. For a soft check, users are notified, and for a hard check, the push is stopped. If storage consumption is within configured quota limits, the push happens as expected.
				</p><p>
					Image manifest deletion follows a similar flow, wherein the link between associated image tags and the manfiest are deleted. Additionally, after the image manifest is deleted, the repository size is recalculated and updated in the <code class="literal">RepositorySize</code> table. The image below represents the design flow and architecture when deleting an image manifest:
				</p><p>
					<span class="inlinemediaobject"><img src="images/manifest-deletion-architecture.png" alt="Manifest deletion architecture"/></span>
				</p></section><section class="section" id="quota-management-limitations"><div class="titlepage"><div><div><h3 class="title">2.1.2. Quota management limitations</h3></div></div></div><p>
					Quota management helps organizations maintain resource consumption, however there are a few limitations. For example, calculating resource consumption on push, as opposed to monitoring consumption with a background worker, does not take into account the usage data of existing images. To avoid potential issues, a backfill for all existing repositories is required before the feature is enabled. Additionally, calculation becomes part of a push’s critical path, otherwise the usage data could drift.
				</p></section><section class="section" id="red-hat-quay-quota-management-establishment"><div class="titlepage"><div><div><h3 class="title">2.1.3. Establishing quota in Red Hat Quay</h3></div></div></div><p>
					The following procedure describes how you can report storage consumption and establish storage quota limits.
				</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
							A valid Red Hat Quay repository.
						</li><li class="listitem">
							A superuser administrator.
						</li><li class="listitem">
							Enough storage to meet the demands of quota limitations.
						</li></ul></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist" type="1"><li class="listitem">
							Log in to your organization’s repository as a superuser.
						</li><li class="listitem">
							On the <span class="strong strong"><strong>Users and Organizations</strong></span> panel, click the name of the repository you want to define storage quota limits for.
						</li><li class="listitem"><p class="simpara">
							Click <span class="strong strong"><strong>Organization Settings</strong></span> on the left hand pane.
						</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
								Alternatively, you can establish quota management by clicking <span class="strong strong"><strong>Manage Organizations</strong></span> on the left hand pane, and then clicking <span class="strong strong"><strong>Settings</strong></span> → <span class="strong strong"><strong>Configure Quota</strong></span>.
							</p></div></div></li><li class="listitem">
							Set the organization quota to the desired amount in the <span class="strong strong"><strong>Quota Management</strong></span> section, for example, 10 GB.
						</li><li class="listitem">
							Set the percentage at which users will be warned when the organization reaches their defined threshold. For example, setting <span class="strong strong"><strong>Warning</strong></span> to 60 is equivalent to 60%.
						</li><li class="listitem">
							Set the percentage at which pushes are rejected from the organization. For example, setting <span class="strong strong"><strong>Rejected</strong></span> to 99 is equivalent to 99%.
						</li><li class="listitem">
							Click <span class="strong strong"><strong>Save Quota Details</strong></span>.
						</li></ol></div><p>
					You can check the remaining storage on the <span class="strong strong"><strong>Repositories</strong></span> page of your organization. You can also alter or remove quota limitations, warnings, and rejections by returning to the <span class="strong strong"><strong>Organization Settings</strong></span> page.
				</p></section></section></section><section class="chapter" id="red_hat_quay_as_cache_proxy"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Red Hat Quay as cache proxy</h1></div></div></div><section class="section" id="quay-as-cache-proxy"><div class="titlepage"><div><div><h2 class="title">3.1. Red Hat Quay as a proxy cache for upstream registries</h2></div></div></div><p>
				With the growing popularity of container development, customers increasingly rely on container images from upstream registries like Docker or Google Cloud Platform to get services up and running. Today, registries have rate limitations and throttling on the number of times users can pull from these registries.
			</p><p>
				With this feature, Red Hat Quay will act as a proxy cache to circumvent pull-rate limitations from upstream registries. Adding a cache feature also accelerates pull performance, because images are pulled from the cache rather than upstream dependencies. Cached images are only updated when the upstream image digest differs from the cached image, reducing rate limitations and potential throttling.
			</p><p>
				With Red Hat Quay acting as a cache proxy for upstream registries, the following features are available:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Configuration of a Quay repository that acts as a cache for a specific upstream registry. This repository can be defined by the Quay config.yaml or the Quay UI.
					</li><li class="listitem">
						Leveraging of an organization’s storage quota to limit cache size.
					</li><li class="listitem">
						Cache and image streams transparency to client. Images in the proxy cache act similar to other images on Quay, and default behaviors such as security scanner, time machine, etc. are supported.
					</li><li class="listitem">
						Audit log that tracks all cache pulls.
					</li><li class="listitem">
						Cache dump to eliminate storage consumption.
					</li><li class="listitem">
						Robot account creation with Role Based Access Control (RBAC) management.
					</li><li class="listitem">
						Metrics to track cache activity and efficiency, for example, hit rate, size, and evictions.
					</li></ul></div><section class="section" id="proxy-cache-architecture"><div class="titlepage"><div><div><h3 class="title">3.1.1. Proxy cache architecture</h3></div></div></div><p>
					The following image shows the expected design flow and architecture of the proxy cache feature.
				</p><p>
					<span class="inlinemediaobject"><img src="images/cache-proxy-overview.png" alt="Proxy cache overview"/></span>
				</p><p>
					When a user pulls an image, for example, <code class="literal">postgres:14</code>, from an upstream repository on Red Hat Quay, the repository checks to see if an image is present. If the image does not exist, a fresh pull is initiated. After being pulled, the image layers are saved to cache and server to the user in parallel. The following image depicts an architectural overview of this scenario:
				</p><p>
					<span class="inlinemediaobject"><img src="images/cache-proxy-pulled-image.png" alt="Pulled image overview"/></span>
				</p><p>
					If the image in the cache exists, users can rely on Quay’s cache to stay up-to-date with the upstream source so that newer images from the cache are automatically pulled. This happens when tags of the original image have been overwritten in the upstream registry. The following image depicts an architectural overview of what happens when the upstream image and cached version of the image are different:
				</p><p>
					<span class="inlinemediaobject"><img src="images/updated-layers-in-cache.png" alt="Updating opposing layers overview"/></span>
				</p><p>
					If the upstream image and cached version are the same, no layers are pulled and the cached image is delivered to the user.
				</p><p>
					In some cases, users initiate pulls when the upstream registry is down. If this happens with the configured staleness period, the image stored in cache is delivered. If the pull happens after the configured staleness period, the error is propagated to the user. The following image depicts an architectural overview when a pull happens after the configured staleness period:
				</p><p>
					image: cache-proxy-staleness-pull.png[Staleness pull overview]
				</p><p>
					Quay administrators can leverage the configurable size limit of an organization to limit cache size so that backend storage consumption remains predictable. This is achieved by discarding images from the cache according to the frequency in which an image is used. The following image depicts an architectural overview of this scenario:
				</p><p>
					<span class="inlinemediaobject"/>
				</p></section><section class="section" id="proxy-cache-limitations"><div class="titlepage"><div><div><h3 class="title">3.1.2. Proxy cache limitations</h3></div></div></div><p>
					Proxy caching with Red Hat Quay has the following limitations:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Your proxy cache must have a size limit of greater than, or equal to, the image you want to cache. For example, if your proxy cache organization has a maximum size of 500 MB, and the image a user wants to pull is 700 MB, the image will be cached and will overflow beyond the configured limit.
						</li><li class="listitem">
							Cached images must have the same properties that images on a Quay repository must have.
						</li></ul></div></section></section></section><section class="chapter" id="build_enhancements"><div class="titlepage"><div><div><h1 class="title">Chapter 4. Build Enhancements</h1></div></div></div><section class="section" id="red-hat-quay-builders-enhancement"><div class="titlepage"><div><div><h2 class="title">4.1. Red Hat Quay build enhancements</h2></div></div></div><p>
				Prior to Red Hat Quay 3.7, Quay ran <code class="literal">podman</code> commands in virtual machines launched by pods. Running builds on virtual platforms requires enabling nested virtualization, which is not featured in Red Hat Enterprise Linux or OpenShift Container Platform. As a result, builds had to run on bare-metal clusters, which is an inefficient use of resources.
			</p><p>
				With Red Hat Quay 3.7., the bare-metal constraint required to run builds has been removed by adding an additional build option which does not contain the virtual machine layer. As a result, builds can be run on virtualized platforms. Backwards compatibility to run previous build configurations are also available.
			</p><section class="section" id="red-hat-quay-builds-architecture"><div class="titlepage"><div><div><h3 class="title">4.1.1. Red Hat Quay enhanced build architecture</h3></div></div></div><p>
					The preceding image shows the expected design flow and architecture of the enhanced build features:
				</p><p>
					<span class="inlinemediaobject"><img src="images/quay-builds-architecture.png" alt="Enhanced Quay builds architecture"/></span>
				</p><p>
					With this enhancement, the build manager first creates the <code class="literal">Job Object</code>. Then, the <code class="literal">Job Object</code> then creates a pod using the <code class="literal">quay-builder-image</code>. The <code class="literal">quay-builder-image</code> will contain the <code class="literal">quay-builder binary</code> and the <code class="literal">Podman</code> service. The created pod runs as <code class="literal">unprivileged</code>. The <code class="literal">quay-builder binary</code> then builds the image while communicating status and retrieving build information from the Build Manager.
				</p></section><section class="section" id="red-hat-quay-build-limitations"><div class="titlepage"><div><div><h3 class="title">4.1.2. Red Hat Quay build limitations</h3></div></div></div><p>
					Running builds in Red Hat Quay in an unprivileged context might cause some commands that were working under the previous build strategy to fail. Attempts to change the build strategy could potentially cause performance issues and reliability with the build.
				</p><p>
					Running builds direclty in a container will not have the same isolation as using virtual machines. Changing the build environment might also caused builds that were previously working to fail.
				</p></section><section class="section" id="setting-up-builders"><div class="titlepage"><div><div><h3 class="title">4.1.3. Preparing a Red Hat Quay builders environment with OpenShift</h3></div></div></div><section class="section" id="openshift_tls_component"><div class="titlepage"><div><div><h4 class="title">4.1.3.1. OpenShift TLS component</h4></div></div></div><p>
						The Red Hat Quay 3.6 Operator has introduced the <code class="literal">tls</code> component which allows you to control TLS configuration.
					</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
							Red Hat Quay 3.6 does not support builders when the TLS component is managed by the Operator.
						</p></div></div><p>
						If you set <code class="literal">tls</code> to <code class="literal">unmanaged</code>, you supply your own <code class="literal">ssl.cert</code> and <code class="literal">ssl.key</code> files. In this instance, if you want your cluster to support builders, you must add both the Quay route and the builder route name to the SAN list in the cert, or alternatively use a wildcard. To add the builder route, use the following format:
					</p><pre class="programlisting language-bash">[quayregistry-cr-name]-quay-builder-[ocp-namespace].[ocp-domain-name]</pre></section><section class="section" id="red-hat-quay-quota-builders-establishment"><div class="titlepage"><div><div><h4 class="title">4.1.3.2. Preparing OpenShift Container Platform for Red Hat Quay builders</h4></div></div></div><p>
						The following procedure describes how you can implement the builders feature in Red Hat Quay.
					</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
								Builders require SSL certificates. For more information <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/2.9/html/manage_red_hat_quay/adding-tls-certificates-to-the-quay-enterprise-container">Adding TLS certificates to the Red Hat Quay container</a>.
							</li></ul></div><div class="admonition note"><div class="admonition_header">Procedure</div><div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
									This procedure assumes you already have a cluster provisioned and a Quay Operator running.
								</li><li class="listitem">
									This procedure is for setting up a virtual namespace on OpenShift Container Platform.
								</li></ul></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
								Log in to your Red Hat Quay cluster using your specified username and password:
							</p><pre class="screen">$ oc login -u $KUBE_USER -p $KUBE_PASSWORD $KUBE_API</pre></li><li class="listitem"><p class="simpara">
								Create a namespace for your virtual builds (e.g., <code class="literal">virtual-builders</code>):
							</p><pre class="screen">$ oc create ns virtual-builders</pre></li><li class="listitem"><p class="simpara">
								Create a new project where your virtual builders will be run (e.g., <code class="literal">virtual-builders</code>).
							</p><pre class="screen">$ oc new-project virtual-builders</pre></li><li class="listitem"><p class="simpara">
								Create a <code class="literal">ServiceAccount</code> in this <code class="literal">Project</code> that will be used to run builds.
							</p><pre class="screen">$ oc create sa -n builder quay-builder</pre></li><li class="listitem"><p class="simpara">
								Provide the created service account with editing permissions so that it can run the build:
							</p><pre class="screen">$ oc adm policy add-role-to-user edit system:serviceaccount:virtual-builders:quay-builder</pre></li><li class="listitem"><p class="simpara">
								Grant the Quay builder <code class="literal">anyuid scc</code> permissions:
							</p><pre class="screen">$ oc adm polcy add-scc-to-user anyuid -z quay-builder</pre><div class="admonition note"><div class="admonition_header">Note</div><div><p>
									This action requires cluster admin privileges and is required because for unprivileged or rootless builds to work, they must run as the Podman user.
								</p></div></div></li><li class="listitem"><p class="simpara">
								Obtain the token for the Quay builder service account:
							</p><pre class="screen">$ oc sa get-token -n builder quay-builder</pre></li><li class="listitem"><p class="simpara">
								Update your config.yaml to include the Quay builder service account:
							</p><pre class="programlisting language-yaml">  DB_URI: "postgresql://admin:password@postgres:5432/quay"
  FEATURE_USER_INITIALIZE: true
  FEATURE_REPO_MIRROR: true
  REPO_MIRROR_INTERVAL: 20
  REPO_MIRROR_TLS_VERIFY: false
  FEATURE_USER_INITIALIZE: true
  SUPER_USERS:
    - quay
    - admin
  DISTRIBUTED_STORAGE_CONFIG:
    default:
      - LocalStorage
      - storage_path: /datastorage/registry
  DISTRIBUTED_STORAGE_DEFAULT_LOCATIONS: []
  DISTRIBUTED_STORAGE_PREFERENCE:
    - default
  FEATURE_BUILD_SUPPORT: True
  BUILDMAN_HOSTNAME: ENTER_BUILD_ROUTE_HERE
  BUILD_MANAGER:
    - ephemeral
    - ALLOWED_WORKER_COUNT: 1
      ORCHESTRATOR_PREFIX: buildman/production/
      ORCHESTRATOR:
        REDIS_HOST: reg-quay-redis
        REDIS_PASSWORD: ""
        REDIS_SSL: false
        REDIS_SKIP_KEYSPACE_EVENT_SETUP: false
      EXECUTORS:
        - EXECUTOR: kubernetesPodman
          NAME: openshift
          BUILDER_NAMESPACE: virtual-builders
          SETUP_TIME: 180
          MINIMUM_RETRY_THRESHOLD: 1
          BUILDER_CONTAINER_IMAGE: ENTER_CONTAINER_IMAGE
          # Kubernetes resource options
          K8S_API_SERVER: ENTER_FIELD_REQUIRED
          K8S_API_TLS_CA: /conf/stack/extra_ca_cert_build_cluster.crt
          VOLUME_SIZE: 8G
          KUBERNETES_DISTRIBUTION: openshift
          CONTAINER_MEMORY_LIMITS: 300Mi
          CONTAINER_CPU_LIMITS: 1000m
          CONTAINER_MEMORY_REQUEST: 300Mi
          CONTAINER_CPU_REQUEST: 500m
          NODE_SELECTOR_LABEL_KEY: ""
          NODE_SELECTOR_LABEL_VALUE: ""
          SERVICE_ACCOUNT_NAME: quay-builder
          SERVICE_ACCOUNT_TOKEN:</pre></li><li class="listitem"><p class="simpara">
								Create an Operator subscription yaml (e.g., <code class="literal">quay-operator-subscription.yaml</code>):
							</p><pre class="programlisting language-yaml">  apiVersion: operators.coreos.com/v1alpha1
  kind: Subscription
  metadata:
    name: quay-operator-subscription
    namespace: openshift-operators
  spec:
    channel: stable-3.6
    name: quay-operator
    source: redhat-operators
    sourceNamespace: openshift-marketplace</pre></li><li class="listitem"><p class="simpara">
								Install the Quay Operator with the subscription yaml:
							</p><pre class="screen">$ oc apply -f ./$QUAY/quay-operator-subscription.yaml -n openshift-operators</pre><div class="admonition note"><div class="admonition_header">Note</div><div><p>
									This step can also be accomplished on the Quay UI.
								</p></div></div></li><li class="listitem"><p class="simpara">
								Create a namespace for the Quay deployment:
							</p><pre class="screen">$ oc create ns quay</pre></li><li class="listitem"><p class="simpara">
								Set the project context:
							</p><pre class="screen">$ oc project quay</pre></li></ol></div></section></section><section class="section" id="red-hat-quay-quota-builders-running"><div class="titlepage"><div><div><h3 class="title">4.1.4. Running Red Hat Quay builders</h3></div></div></div><p>
					The following procedure describes how you can run Red Hat Quay builders on a virtual environment.
				</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
							You have set up a virtual environment to run Red Hat Quay builders.
						</li><li class="listitem"><p class="simpara">
							A config.yaml similar to the following:
						</p><pre class="programlisting language-yaml">  DB_URI: "postgresql://admin:password@postgres:5432/quay"
  FEATURE_USER_INITIALIZE: true
  FEATURE_REPO_MIRROR: true
  REPO_MIRROR_INTERVAL: 20
  REPO_MIRROR_TLS_VERIFY: false
  FEATURE_USER_INITIALIZE: true
  SUPER_USERS:
    - quay
    - admin
  DISTRIBUTED_STORAGE_CONFIG:
    default:
      - LocalStorage
      - storage_path: /datastorage/registry
  DISTRIBUTED_STORAGE_DEFAULT_LOCATIONS: []
  DISTRIBUTED_STORAGE_PREFERENCE:
    - default
  FEATURE_BUILD_SUPPORT: True
  BUILDMAN_HOSTNAME: ENTER_BUILD_ROUTE_HERE
  BUILD_MANAGER:
    - ephemeral
    - ALLOWED_WORKER_COUNT: 1
      ORCHESTRATOR_PREFIX: buildman/production/
      ORCHESTRATOR:
        REDIS_HOST: reg-quay-redis
        REDIS_PASSWORD: ""
        REDIS_SSL: false
        REDIS_SKIP_KEYSPACE_EVENT_SETUP: false
      EXECUTORS:
        - EXECUTOR: kubernetesPodman
          NAME: openshift
          BUILDER_NAMESPACE: virtual-builders
          SETUP_TIME: 180
          MINIMUM_RETRY_THRESHOLD: 1
          BUILDER_CONTAINER_IMAGE: ENTER_CONTAINER_IMAGE
          # Kubernetes resource options
          K8S_API_SERVER: ENTER_FIELD_REQUIRED
          K8S_API_TLS_CA: /conf/stack/extra_ca_cert_build_cluster.crt
          VOLUME_SIZE: 8G
          KUBERNETES_DISTRIBUTION: openshift
          CONTAINER_MEMORY_LIMITS: 300Mi
          CONTAINER_CPU_LIMITS: 1000m
          CONTAINER_MEMORY_REQUEST: 300Mi
          CONTAINER_CPU_REQUEST: 500m
          NODE_SELECTOR_LABEL_KEY: ""
          NODE_SELECTOR_LABEL_VALUE: ""
          SERVICE_ACCOUNT_NAME: quay-builder
          SERVICE_ACCOUNT_TOKEN:</pre></li></ul></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Recreate your Quay config secret using your config.yaml and SSL certificates:
						</p><pre class="screen">$ oc delete secret quay-config
oc create secret generic quay-config \
    --from-file config.yaml=./quay-configs/$CONFIG \
    --from-file ssl.cert=ssl.cert \
    --from-file ssl.key=ssl.key</pre></li><li class="listitem"><p class="simpara">
							Delete your Quay registry deployment:
						</p><pre class="screen">$ oc delete quayregistry reg</pre></li><li class="listitem"><p class="simpara">
							Create a new Quay registry yaml, e.g. quay-registry.yaml with the following parameters:
						</p><pre class="programlisting language-yaml">  apiVersion: quay.redhat.com/v1
  kind: QuayRegistry
  metadata:
    name: reg
    namespace: quay
  spec:
    components:
      - kind: clair
        managed: false
      - kind: objectstorage
        managed: false
      - kind: mirror
        managed: false
      - kind: postgres
        managed: false
    configBundleSecret: quay-config</pre></li><li class="listitem"><p class="simpara">
							Create a new Quay registry using the new yaml:
						</p><pre class="screen">$ oc apply -f $QUAY/quay-registry.yaml</pre></li><li class="listitem"><p class="simpara">
							Check that your pods are running:
						</p><pre class="screen">$ oc get pods</pre></li><li class="listitem"><p class="simpara">
							Obtain the route:
						</p><pre class="screen">$ oc get route</pre><p class="simpara">
							Example output:
						</p><pre class="screen">reg-quay-quay.apps.ci-ln-ty4mn4t-76ef8.origin-ci-int-aws.dev.rhcloud.com</pre></li><li class="listitem">
							Copy the route to your browser and create a new account using the Quay UI.
						</li><li class="listitem">
							Click <span class="strong strong"><strong>Create New Repository</strong></span> and create a new registry, e.g., <code class="literal">test</code>.
						</li><li class="listitem">
							On the <span class="strong strong"><strong>Repositories</strong></span> page, click <span class="strong strong"><strong>Builds</strong></span> on the left hand pane, and then <span class="strong strong"><strong>Create Build Trigger</strong></span>.
						</li><li class="listitem">
							Enter the HTTP or SSH style URL used to clone your git repository, then click <span class="strong strong"><strong>Continue</strong></span>.
						</li><li class="listitem">
							Check <span class="strong strong"><strong>Tag manifest with the branch or tag name</strong></span> and then click <span class="strong strong"><strong>Continue</strong></span>.
						</li><li class="listitem">
							Enter the location of the Dockerfile to build when the trigger is invoked, for example, <code class="literal">/Dockerfile</code>.
						</li><li class="listitem">
							Enter the location of the conext for the Docker build, for example, <code class="literal">/</code>.
						</li><li class="listitem">
							Click <span class="strong strong"><strong>Continue</strong></span> to verify the parameters.
						</li><li class="listitem">
							On the <span class="strong strong"><strong>Builds</strong></span> page, click <span class="strong strong"><strong>Options</strong></span> of your Trigger Name, and then click <span class="strong strong"><strong>Run Trigger Now</strong></span>.
						</li><li class="listitem">
							Enter the commit ID and click <span class="strong strong"><strong>Start Build</strong></span>.
						</li><li class="listitem"><p class="simpara">
							On your terminal, check the status of your Trigger build:
						</p><pre class="screen">$ oc get pod -n virtual-builders</pre><p class="simpara">
							Example output:
						</p><pre class="screen">NAME                                                   READY   STATUS                RESTARTS   AGE
38b37sj3-195c-8ehg-27b83719b7bb-b18dh-02jdy            0/1     ContainerCreating     0          3m42s</pre></li><li class="listitem">
							Once created, you can check the status of the Trigger Build on the UI and that your tag was successfully pushed.
						</li></ol></div></section></section></section><div><div xml:lang="en-US" class="legalnotice" id="idm45383806443344"><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"/>© 2022 Red Hat, Inc.
	</div><div class="para">
		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). An explanation of CC-BY-SA is available at <a class="uri" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>. In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
	</div><div class="para">
		Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.
	</div><div class="para">
		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Linux</span>® is the registered trademark of Linus Torvalds in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Java</span>® is a registered trademark of Oracle and/or its affiliates.
	</div><div class="para">
		<span class="trademark">XFS</span>® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries.
	</div><div class="para">
		<span class="trademark">MySQL</span>® is a registered trademark of MySQL AB in the United States, the European Union and other countries.
	</div><div class="para">
		<span class="trademark">Node.js</span>® is an official trademark of Joyent. Red Hat is not formally related to or endorsed by the official Joyent Node.js open source or commercial project.
	</div><div class="para">
		The <span class="trademark">OpenStack</span>® Word Mark and OpenStack logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.
	</div><div class="para">
		All other trademarks are the property of their respective owners.
	</div></div></div></div></div></div><script type="text/javascript">
                        jQuery(document).ready(function() {
                            initSwitchery();
                            jQuery('pre[class*="language-"]').each(function(i, block){hljs.highlightBlock(block);});
                        });
                    </script></body></html>
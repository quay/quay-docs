<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Manage Red Hat Quay</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css"/><meta name="generator" content="publican v4.3.2"/><meta name="description" content="Manage Red Hat Quay"/><link rel="next" href="#idm45792906575488" title="Preface"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><script type="text/javascript" src="Common_Content/scripts/jquery-1.7.1.min.js"> </script><script type="text/javascript" src="Common_Content/scripts/utils.js"> </script><script type="text/javascript" src="Common_Content/scripts/highlight.js/highlight.pack.js"> </script></head><body><div id="chrometwo"><div id="main"><div xml:lang="en-US" class="book" id="idm45792901952320"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat Quay</span> <span class="productnumber">3.6</span></div><div><h1 class="title">Manage Red Hat Quay</h1></div><div><h2 class="subtitle">Manage Red Hat Quay</h2></div><div><div xml:lang="en-US" class="authorgroup"><span class="orgname">Red Hat OpenShift Documentation Team</span></div></div><div><a href="#idm45792902728640">Legal Notice</a></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				Manage Red Hat Quay
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="preface"><a href="#idm45792906575488">Preface</a></span></li><li><span class="chapter"><a href="#advanced-quay-configuration">1. Advanced Red Hat Quay configuration</a></span><ul><li><span class="section"><a href="#using-the-config-tool">1.1. Using Red Hat Quay Config Tool to modify Red Hat Quay</a></span><ul><li><span class="section"><a href="#running_the_config_tool_from_the_red_hat_quay_operator">1.1.1. Running the Config Tool from the Red Hat Quay Operator</a></span></li><li><span class="section"><a href="#running_the_config_tool_from_the_command_line">1.1.2. Running the Config Tool from the command line</a></span></li></ul></li><li><span class="section"><a href="#overview-advanced-config">1.2. Using the API to modify Red Hat Quay</a></span></li><li><span class="section"><a href="#editing_the_literal_config_yaml_literal_file_to_modify_red_hat_quay">1.3. Editing the <code class="literal">config.yaml</code> file to modify Red Hat Quay</a></span><ul><li><span class="section"><a href="#add_name_and_company_to_red_hat_quay_sign_in">1.3.1. Add name and company to Red Hat Quay sign-in</a></span></li><li><span class="section"><a href="#disable_tls_protocols">1.3.2. Disable TLS Protocols</a></span></li><li><span class="section"><a href="#rate_limit_api_calls">1.3.3. Rate limit API calls</a></span></li><li><span class="section"><a href="#adjust_database_connection_pooling">1.3.4. Adjust database connection pooling</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#using_the_configuration_api">2. Using the configuration API</a></span><ul><li><span class="section"><a href="#retrieving_the_default_configuration">2.1. Retrieving the default configuration</a></span></li><li><span class="section"><a href="#retrieving_the_current_configuration">2.2. Retrieving the current configuration</a></span></li><li><span class="section"><a href="#validating_configuration_using_the_api">2.3. Validating configuration using the API</a></span></li><li><span class="section"><a href="#determining_the_required_fields">2.4. Determining the required fields</a></span></li></ul></li><li><span class="chapter"><a href="#release-notifications">3. Getting Red Hat Quay release notifications</a></span></li><li><span class="chapter"><a href="#using-ssl-to-protect-quay">4. Using SSL to protect connections to Red Hat Quay</a></span><ul><li><span class="section"><a href="#introduction_to_using_ssl">4.1. Introduction to using SSL</a></span></li><li><span class="section"><a href="#create-a-ca-and-sign-a-certificate">4.2. Create a Certificate Authority and sign a certificate</a></span><ul><li><span class="section"><a href="#create_a_certificate_authority">4.2.1. Create a Certificate Authority</a></span></li><li><span class="section"><a href="#sign_a_certificate">4.2.2. Sign a certificate</a></span></li></ul></li><li><span class="section"><a href="#configuring_ssl_using_the_command_line">4.3. Configuring SSL using the command line</a></span></li><li><span class="section"><a href="#configuring_ssl_using_the_ui">4.4. Configuring SSL using the UI</a></span></li><li><span class="section"><a href="#testing_ssl_configuration_using_the_command_line">4.5. Testing SSL configuration using the command line</a></span></li><li><span class="section"><a href="#testing_ssl_configuration_using_the_browser">4.6. Testing SSL configuration using the browser</a></span></li><li><span class="section"><a href="#configuring_podman_to_trust_the_certificate_authority">4.7. Configuring podman to trust the Certificate Authority</a></span></li><li><span class="section"><a href="#configuring_the_system_to_trust_the_certificate_authority">4.8. Configuring the system to trust the certificate authority</a></span></li></ul></li><li><span class="chapter"><a href="#config-custom-ssl-certs-manual">5. Adding TLS Certificates to the Red Hat Quay Container</a></span><ul><li><span class="section"><a href="#add-certificates-to-quay-container">5.1. Add TLS certificates to Red Hat Quay</a></span></li><li><span class="section"><a href="#config-custom-ssl-cert-kubernetes">5.2. Add certs when deployed on Kubernetes</a></span></li></ul></li><li><span class="chapter"><a href="#proc_manage-log-storage">6. Configuring action log storage for Elasticsearch</a></span></li><li><span class="chapter"><a href="#clair-intro2">7. Clair Security Scanning</a></span><ul><li><span class="section"><a href="#clair-openshift">7.1. Setting Up Clair on a Red Hat Quay OpenShift deployment</a></span><ul><li><span class="section"><a href="#deploying_via_the_quay_operator">7.1.1. Deploying Via the Quay Operator</a></span></li><li><span class="section"><a href="#clair-openshift-manual">7.1.2. Manually Deploying Clair</a></span></li></ul></li><li><span class="section"><a href="#clair-standalone">7.2. Setting up Clair on a non-OpenShift Red Hat Quay deployment</a></span></li><li><span class="section"><a href="#clair-using">7.3. Using Clair</a></span></li><li><span class="section"><a href="#clair-cve">7.4. CVE ratings from the National Vulnerability Database</a></span></li><li><span class="section"><a href="#clair-disconnected">7.5. Configuring Clair for Disconnected Environments</a></span></li><li><span class="section"><a href="#clair-updater-urls">7.6. Clair updater URLs</a></span></li><li><span class="section"><a href="#clair-add-info">7.7. Additional Information</a></span></li></ul></li><li><span class="chapter"><a href="#container-security-operator-setup">8. Scan pod images with the Container Security Operator</a></span><ul><li><span class="section"><a href="#run_the_cso_in_openshift">8.1. Run the CSO in OpenShift</a></span></li><li><span class="section"><a href="#query_image_vulnerabilities_from_the_cli">8.2. Query image vulnerabilities from the CLI</a></span></li></ul></li><li><span class="chapter"><a href="#quay-bridge-operator">9. Integrate Red Hat Quay into OpenShift with the Bridge Operator</a></span><ul><li><span class="section"><a href="#running_the_quay_bridge_operator">9.1. Running the Quay Bridge Operator</a></span><ul><li><span class="section"><a href="#prerequisites">9.1.1. Prerequisites</a></span></li><li><span class="section"><a href="#setting_up_and_configuring_openshift_and_red_hat_quay">9.1.2. Setting up and configuring OpenShift and Red Hat Quay</a></span></li><li><span class="section"><a href="#red_hat_quay_setup">9.1.3. Red Hat Quay setup</a></span></li><li><span class="section"><a href="#openshift_setup">9.1.4. OpenShift Setup</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#repo-mirroring-in-red-hat-quay">10. Repository mirroring</a></span><ul><li><span class="section"><a href="#mirroring-intro">10.1. Repository mirroring</a></span></li><li><span class="section"><a href="#mirroring-versus-georepl">10.2. Repository mirroring versus geo-replication</a></span></li><li><span class="section"><a href="#mirroring-using">10.3. Using repository mirroring</a></span></li><li><span class="section"><a href="#mirroring_configuration_ui">10.4. Mirroring configuration UI</a></span></li><li><span class="section"><a href="#config-fields-mirroring">10.5. Mirroring configuration fields</a></span></li><li><span class="section"><a href="#mirroring-worker">10.6. Mirroring worker</a></span></li><li><span class="section"><a href="#mirroring-creating-repo">10.7. Creating a mirrored repository</a></span><ul><li><span class="section"><a href="#repository_mirroring_settings">10.7.1. Repository mirroring settings</a></span></li><li><span class="section"><a href="#advanced_settings">10.7.2. Advanced settings</a></span></li><li><span class="section"><a href="#synchronize_now">10.7.3. Synchronize now</a></span></li></ul></li><li><span class="section"><a href="#mirroring-events">10.8. Event notifications for mirroring</a></span></li><li><span class="section"><a href="#mirroring-tag-patterns">10.9. Mirroring tag patterns</a></span><ul><li><span class="section"><a href="#pattern_syntax">10.9.1. Pattern syntax</a></span></li><li><span class="section"><a href="#example_tag_patterns">10.9.2. Example tag patterns</a></span></li></ul></li><li><span class="section"><a href="#mirroring-working-with">10.10. Working with mirrored repositories</a></span></li><li><span class="section"><a href="#mirroring-recommend">10.11. Repository mirroring recommendations</a></span></li></ul></li><li><span class="chapter"><a href="#back-up-and-restore-red-hat-quay">11. Back up and recover Red Hat Quay</a></span><ul><li><span class="section"><a href="#back_up_red_hat_quay_procedure">11.1. Back up Red Hat Quay procedure</a></span><ul><li><span class="section"><a href="#restore_red_hat_quay_when_the_operator_manages_the_database_procedure">11.1.1. Restore Red Hat Quay when the Operator manages the database procedure</a></span></li><li><span class="section"><a href="#restore_quay_when_the_quay_operator_does_not_manage_the_database">11.1.2. Restore Quay when the Quay Operator does not manage the database</a></span></li><li><span class="section"><a href="#restore_quay_on_a_virtual_machine_deployment">11.1.3. Restore Quay on a virtual machine deployment</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#ldap-authentication-setup-for-quay-enterprise">12. LDAP Authentication Setup for Red Hat Quay</a></span><ul><li><span class="section"><a href="#considerations_prior_to_enabling_ldap">12.1. Considerations prior to enabling LDAP</a></span><ul><li><span class="section"><a href="#considerations-for-existing-quay-deployments">12.1.1. Existing Quay deployments</a></span></li><li><span class="section"><a href="#considerations-for-manual-user-creation">12.1.2. Manual User Creation and LDAP authentication</a></span></li></ul></li><li><span class="section"><a href="#setup-ldap-configuration">12.2. Set Up LDAP Configuration</a></span><ul><li><span class="section"><a href="#full_ldap_uri">12.2.1. Full LDAP URI</a></span></li><li><span class="section"><a href="#team_synchronization">12.2.2. Team Synchronization</a></span></li><li><span class="section"><a href="#base_and_relative_distinguished_names">12.2.3. Base and Relative Distinguished Names</a></span></li><li><span class="section"><a href="#additional_user_filters">12.2.4. Additional User Filters</a></span></li><li><span class="section"><a href="#administrator_dn">12.2.5. Administrator DN</a></span></li><li><span class="section"><a href="#uid_and_mail_attributes">12.2.6. UID and Mail attributes</a></span></li><li><span class="section"><a href="#validation">12.2.7. Validation</a></span></li></ul></li><li><span class="section"><a href="#common-issues">12.3. Common Issues</a></span></li><li><span class="section"><a href="#configure-ldap-superuser">12.4. Configure an LDAP user as superuser</a></span></li></ul></li><li><span class="chapter"><a href="#prometheus-metrics-under-quay-enterprise">13. Prometheus and Grafana metrics under Red Hat Quay</a></span><ul><li><span class="section"><a href="#exposing-the-prometheus-endpoint">13.1. Exposing the Prometheus endpoint</a></span><ul><li><span class="section"><a href="#setting-up-prometheus-to-consume-metrics">13.1.1. Setting up Prometheus to consume metrics</a></span></li><li><span class="section"><a href="#dns-configuration-under-kubernetes">13.1.2. DNS configuration under Kubernetes</a></span></li><li><span class="section"><a href="#dns-configuration-for-a-manual-cluster">13.1.3. DNS configuration for a manual cluster</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#georepl-intro">14. Geo-replication</a></span><ul><li><span class="section"><a href="#geo_replication_features">14.1. Geo-replication features</a></span></li><li><span class="section"><a href="#georepl-prereqs">14.2. Geo-replication requirements and constraints</a></span></li><li><span class="section"><a href="#georepl-arch">14.3. Geo-replication architecture</a></span></li><li><span class="section"><a href="#config-ui-storage-georepl">14.4. Enable storage replication</a></span><ul><li><span class="section"><a href="#georepl-deploy">14.4.1. Run Red Hat Quay with storage preferences</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#quay-troubleshooting-guides">15. Red Hat Quay Troubleshooting</a></span></li><li><span class="chapter"><a href="#quay-schema">16. Schema for Red Hat Quay configuration</a></span></li></ul></div><section class="preface" id="idm45792906575488"><div class="titlepage"><div><div><h1 class="title">Preface</h1></div></div></div><p>
			Once you have deployed a Red Hat Quay registry, there are many ways you can further configure and manage that deployment. Topics covered here include:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Advanced Red Hat Quay configuration
				</li><li class="listitem">
					Setting notifications to alert you of a new Red Hat Quay release
				</li><li class="listitem">
					Securing connections with SSL and TLS certificates
				</li><li class="listitem">
					Directing action logs storage to Elasticsearch
				</li><li class="listitem">
					Configuring image security scanning with Clair
				</li><li class="listitem">
					Scan pod images with the Container Security Operator
				</li><li class="listitem">
					Integrate Red Hat Quay into OpenShift with the Quay Bridge Operator
				</li><li class="listitem">
					Mirroring images with repository mirroring
				</li><li class="listitem">
					Sharing Quay images with a BitTorrent service
				</li><li class="listitem">
					Authenticating users with LDAP
				</li><li class="listitem">
					Enabling Quay for Prometheus and Grafana metrics
				</li><li class="listitem">
					Setting up geo-replication
				</li><li class="listitem">
					Troubleshooting Quay
				</li></ul></div></section><section class="chapter" id="advanced-quay-configuration"><div class="titlepage"><div><div><h1 class="title">Chapter 1. Advanced Red Hat Quay configuration</h1></div></div></div><p>
			You can configure your Red Hat Quay after initial deployment using several different interfaces:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					The Red Hat Quay Config Tool: Running the <code class="literal">Quay</code> container in <code class="literal">config</code> mode presents a Web-based interface for configuring the Red Hat Quay cluster. This is the recommended method for most configuration of the Red Hat Quay service itself.
				</li><li class="listitem">
					Editing the <code class="literal">config.yaml</code>: The <code class="literal">config.yaml</code> file holds most of the configuration information for the Red Hat Quay cluster. Editing that file directly is possible, but it is only recommended for advanced tuning and performance features that are not available through the Config Tool.
				</li><li class="listitem">
					Red Hat Quay API: Some Red Hat Quay configuration can be done through the API.
				</li></ul></div><p>
			While configuration for specific features is covered in separate sections, this section describes how to use each of those interfaces and perform some more advanced configuration.
		</p><section class="section" id="using-the-config-tool"><div class="titlepage"><div><div><h2 class="title">1.1. Using Red Hat Quay Config Tool to modify Red Hat Quay</h2></div></div></div><p>
				The Red Hat Quay Config Tool is made available by running a <code class="literal">Quay</code> container in <code class="literal">config</code> mode alongside the regular Red Hat Quay service. Running the Config Tool is different for Red Hat Quay clusters running on OpenShift than it is for those running directly on host systems.
			</p><section class="section" id="running_the_config_tool_from_the_red_hat_quay_operator"><div class="titlepage"><div><div><h3 class="title">1.1.1. Running the Config Tool from the Red Hat Quay Operator</h3></div></div></div><p>
					If you are running the Red Hat Quay Operator from OpenShift, the Config Tool is probably already available for you to use. To access the Config Tool, do the following:
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
							From the OpenShift console, select the project in which Red Hat Quay is running. For example, quay-enterprise.
						</li><li class="listitem"><p class="simpara">
							From the left column, select Networking → Routes. You should see routes to both the Red Hat Quay application and Config Tool, as shown in the following image:
						</p><p class="simpara">
							<span class="inlinemediaobject"><img src="images/configtoolroute.png" alt="View the route to the Red Hat Quay Config Tool"/></span>
						</p></li><li class="listitem">
							Select the route to the Config Tool (for example, example-quayecosystem-quay-config) and select it. The Config tool Web UI should open in your browser.
						</li><li class="listitem"><p class="simpara">
							Select <code class="literal">Modify configuration for this cluster</code>. You should see the Config Tool, ready for you to change features of your Red Hat Quay cluster, as shown in the following image:
						</p><p class="simpara">
							<span class="inlinemediaobject"><img src="images/configtoolsetup.png" alt="Modify Red Hat Quay cluster settings from the Config Tool"/></span>
						</p></li><li class="listitem">
							When you have made the changes you want, select <code class="literal">Save Configuration Changes</code>. The Config Tool will validate your changes.
						</li><li class="listitem">
							Make any corrections as needed by selecting <code class="literal">Continue Editing</code> or select <code class="literal">Next</code> to continue on.
						</li><li class="listitem">
							When prompted, it is recommended that you select <code class="literal">Download Configuration</code>. That will download a tarball of your new <code class="literal">config.yaml</code>, as well as any certificates and keys used with your Red Hat Quay setup.
						</li><li class="listitem">
							Select <code class="literal">Go to deployment rollout</code>, then <code class="literal">Populate the configuration to deployments</code>. The Red Hat Quay pods will be restarted and the changes will take effect.
						</li></ol></div><p>
					The <code class="literal">config.yaml</code> file you saved can be used to make advanced changes to your configuration or just kept for future reference.
				</p></section><section class="section" id="running_the_config_tool_from_the_command_line"><div class="titlepage"><div><div><h3 class="title">1.1.2. Running the Config Tool from the command line</h3></div></div></div><p>
					If you are running Red Hat Quay directly from a host system, using tools such as the <code class="literal">podman</code> or <code class="literal">docker</code> commands, after the initial Red Hat Quay deployment, you can restart the Config Tool to modify your Red Hat Quay cluster. Here’s how:
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							<span class="strong strong"><strong>Start quay in config mode</strong></span>: On the first <code class="literal">quay</code> node run the following, replacing <code class="literal">my-secret-password</code> with your password. If you would like to modify an existing config bundle, you can simply mount your configuration directory into the <code class="literal">Quay</code> container as you would in registry mode.
						</p><pre class="literallayout"># podman run --rm -it --name quay_config -p 8080:8080 \
    -v path/to/config-bundle:/conf/stack \
    registry.redhat.io/quay/quay-rhel8:v3.6.2 config my-secret-password</pre></li><li class="listitem">
							<span class="strong strong"><strong>Open browser</strong></span>: When the quay configuration tool starts up, open a browser to the URL and port 8080 of the system you are running the configuration tool on (for example <a class="link" href="https://myquay.example.com:8080">https://myquay.example.com:8080</a>). You are prompted for a username and password.
						</li></ol></div><p>
					At this point, you can begin modifying your Red Hat Quay cluster as described earlier.
				</p></section></section><section class="section" id="overview-advanced-config"><div class="titlepage"><div><div><h2 class="title">1.2. Using the API to modify Red Hat Quay</h2></div></div></div><p>
				See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3/html-single/red_hat_quay_api_guide/index">Red Hat Quay API Guide</a> for information on how to access Red Hat Quay API.
			</p></section><section class="section" id="editing_the_literal_config_yaml_literal_file_to_modify_red_hat_quay"><div class="titlepage"><div><div><h2 class="title">1.3. Editing the <code class="literal">config.yaml</code> file to modify Red Hat Quay</h2></div></div></div><p>
				Some advanced Red Hat Quay configuration that is not available through the Config Tool can be achieved by editing the <code class="literal">config.yaml</code> file directly. Available settings are described in the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/manage_red_hat_quay/quay-schema">Schema for Red Hat Quay configuration</a> The following are examples of settings you can change directly in the <code class="literal">config.yaml</code> file.
			</p><section class="section" id="add_name_and_company_to_red_hat_quay_sign_in"><div class="titlepage"><div><div><h3 class="title">1.3.1. Add name and company to Red Hat Quay sign-in</h3></div></div></div><p>
					Setting the following will cause users to be prompted for their name and company when they first sign in. Although this is optional, it can provide you with extra data about your Red Hat Quay users:
				</p><p>
					+ <code class="literal">FEATURE_USER_METADATA: true</code>
				</p></section><section class="section" id="disable_tls_protocols"><div class="titlepage"><div><div><h3 class="title">1.3.2. Disable TLS Protocols</h3></div></div></div><p>
					You can change the SSL_PROTOCOLS setting to remove SSL protocols that you do not want to support in your Red Hat Quay instance. For example, to remove TLS v1 support from the default SSL_PROTOCOLS : ['TLSv1','TLSv1.1','TLSv1.2'], change it as follows:
				</p><p>
					+ SSL_PROTOCOLS : ['TLSv1.1','TLSv1.2']
				</p></section><section class="section" id="rate_limit_api_calls"><div class="titlepage"><div><div><h3 class="title">1.3.3. Rate limit API calls</h3></div></div></div><p>
					Adding the FEATURE_RATE_LIMITS parameter to the <code class="literal">config.yaml</code> causes <code class="literal">nginx</code> to limit certain API calls to 30 per second. If that feature is not set, API calls are limied to 300 per second (effectively unlimited). Rate limiting can be an important feature, if you need to make sure the resources available are not overwhelmed with traffic.
				</p><p>
					Some namespace may require unlimited access (perhaps they are important to CI/CD and take priority, for example). In this case, those namespace may be placed in a list in <code class="literal">config.yaml</code> for NON_RATE_LIMITED_NAMESPACES.
				</p></section><section class="section" id="adjust_database_connection_pooling"><div class="titlepage"><div><div><h3 class="title">1.3.4. Adjust database connection pooling</h3></div></div></div><p>
					Red Hat Quay is composed of many different processes which all run within the same container. Many of these processes interact with the database.
				</p><p>
					If enabled, each process that interacts with the database will contain a connection pool. These per-process connection pools are configured to maintain a maximum of 20 connections. Under heavy load, it is possible to fill the connection pool for every process within a Red Hat Quay container. Under certain deployments and loads, this may require analysis to ensure Red Hat Quay does not exceed the database’s configured maximum connection count.
				</p><p>
					Overtime, the connection pools will release idle connections. To release all connections immediately, Red Hat Quay requires a restart.
				</p><p>
					Database connection pooling may be toggled by setting the environment variable <code class="literal">DB_CONNECTION_POOLING={true|false}</code>
				</p><p>
					If database connection pooling is enabled, it is possible to change the maximum size of the connection pool. This can be done through the following <code class="literal">config.yaml</code> option:
				</p><pre class="literallayout">DB_CONNECTION_ARGS:
  max_connections: 10</pre><section class="section" id="database_connection_arguments"><div class="titlepage"><div><div><h4 class="title">1.3.4.1. Database connection arguments</h4></div></div></div><p>
						You can customize Red Hat Quay database connection settings within the <code class="literal">config.yaml</code> file. These are entirely dependent upon the underlying database driver, such as <code class="literal">psycopg2</code> for Postgres and <code class="literal">pymysql</code> for MySQL. It is also possible to pass in arguments used by Peewee’s Connection Pooling mechanism as seen below.
					</p><pre class="literallayout">DB_CONNECTION_ARGS:
  max_connections: n  # Max Connection Pool size. (Connection Pooling only)
  timeout: n  # Time to hold on to connections. (Connection Pooling only)
  stale_timeout: n  # Number of seconds to block when the pool is full. (Connection Pooling only)</pre></section><section class="section" id="database-ssl-configuration"><div class="titlepage"><div><div><h4 class="title">1.3.4.2. Database SSL configuration</h4></div></div></div><p>
						Some key-value pairs defined under DB_CONNECTION_ARGS are generic while others are database-specific. In particular, SSL configuration depends on the database you are deploying.
					</p><section class="section" id="postgresql_ssl_connection_arguments"><div class="titlepage"><div><div><h5 class="title">1.3.4.2.1. PostgreSQL SSL connection arguments</h5></div></div></div><p>
							A sample PostgreSQL SSL configuration is given below:
						</p><pre class="screen">DB_CONNECTION_ARGS:
  sslmode: verify-ca
  sslrootcert: /path/to/cacert</pre><p>
							The <code class="literal">sslmode</code> option determines whether or with what priority a secure SSL TCP/IP connection will be negotiated with the server. There are six modes:
						</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
									<span class="strong strong"><strong>disable:</strong></span> only try a non-SSL connection
								</li><li class="listitem">
									<span class="strong strong"><strong>allow:</strong></span> first try a non-SSL connection; if that fails, try an SSL connection
								</li><li class="listitem">
									<span class="strong strong"><strong>prefer:</strong></span> (default) first try an SSL connection; if that fails, try a non-SSL connection
								</li><li class="listitem">
									<span class="strong strong"><strong>require:</strong></span> only try an SSL connection. If a root CA file is present, verify the certificate in the same way as if verify-ca was specified
								</li><li class="listitem">
									<span class="strong strong"><strong>verify-ca:</strong></span> only try an SSL connection, and verify that the server certificate is issued by a trusted certificate authority (CA)
								</li><li class="listitem">
									<span class="strong strong"><strong>verify-full:</strong></span> only try an SSL connection, verify that the server certificate is issued by a trusted CA and that the requested server host name matches that in the certificate
								</li></ul></div><p>
							More information on the valid arguments for PostgreSQL is available at <a class="link" href="https://www.postgresql.org/docs/current/libpq-connect.html">https://www.postgresql.org/docs/current/libpq-connect.html</a>.
						</p></section><section class="section" id="mysql_ssl_connection_arguments"><div class="titlepage"><div><div><h5 class="title">1.3.4.2.2. MySQL SSL connection arguments</h5></div></div></div><p>
							A sample MySQL SSL configuration follows:
						</p><pre class="screen">DB_CONNECTION_ARGS:
  ssl:
    ca: /path/to/cacert</pre><p>
							Information on the valid connection arguments for MySQL is available at <a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/connecting-using-uri-or-key-value-pairs.html">https://dev.mysql.com/doc/refman/8.0/en/connecting-using-uri-or-key-value-pairs.html</a>.
						</p></section></section><section class="section" id="http_connection_counts"><div class="titlepage"><div><div><h4 class="title">1.3.4.3. HTTP connection counts</h4></div></div></div><p>
						It is possible to specify the quantity of simultaneous HTTP connections using environment variables. These can be specified as a whole, or for a specific component. The default for each is 50 parallel connections per process.
					</p><p>
						Environment variables:
					</p><pre class="screen">WORKER_CONNECTION_COUNT_REGISTRY=n
WORKER_CONNECTION_COUNT_WEB=n
WORKER_CONNECTION_COUNT_SECSCAN=n
WORKER_CONNECTION_COUNT=n</pre><div class="informalexample"><p>
						Specifying a count for a specific component will override any value set in WORKER_CONNECTION_COUNT.
					</p></div></section><section class="section" id="dynamic_process_counts"><div class="titlepage"><div><div><h4 class="title">1.3.4.4. Dynamic process counts</h4></div></div></div><p>
						To estimate the quantity of dynamically sized processes, the following calculation is used by default.
					</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
							Red Hat Quay queries the available CPU count from the entire machine. Any limits applied using kubernetes or other non-virtualized mechanisms will not affect this behavior; Red Hat Quay will makes its calculation based on the total number of processors on the Node. The default values listed are simply targets, but shall not exceed the maximum or be lower than the minimum.
						</p></div></div><p>
						Each of the following process quantities can be overridden using the environment variable specified below.
					</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
								registry - Provides HTTP endpoints to handle registry action
							</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
										minimum: 8
									</li><li class="listitem">
										maximum: 64
									</li><li class="listitem">
										default: $CPU_COUNT x 4
									</li><li class="listitem">
										environment variable: WORKER_COUNT_REGISTRY
									</li></ul></div></li><li class="listitem"><p class="simpara">
								web - Provides HTTP endpoints for the web-based interface
							</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
										minimum: 2
									</li><li class="listitem">
										maximum: 32
									</li><li class="listitem">
										default: $CPU_COUNT x 2
									</li><li class="listitem">
										environment_variable: WORKER_COUNT_WEB
									</li></ul></div></li><li class="listitem"><p class="simpara">
								secscan - Interacts with Clair
							</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
										minimum: 2
									</li><li class="listitem">
										maximum: 4
									</li><li class="listitem">
										default: $CPU_COUNT x 2
									</li><li class="listitem">
										environment variable: WORKER_COUNT_SECSCAN
									</li></ul></div></li></ul></div></section><section class="section" id="environment_variables"><div class="titlepage"><div><div><h4 class="title">1.3.4.5. Environment variables</h4></div></div></div><p>
						Red Hat Quay allows overriding default behavior using environment variables. This table lists and describes each variable and the values they can expect.
					</p><div class="table" id="idm45792904827440"><p class="title"><strong>Table 1.1. Worker count environment variables</strong></p><div class="table-contents"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 33%; " class="col_1"/><col style="width: 33%; " class="col_2"/><col style="width: 33%; " class="col_3"/></colgroup><thead><tr><th align="left" valign="top" id="idm45792904821712" scope="col">Variable</th><th align="left" valign="top" id="idm45792904820624" scope="col">Description</th><th align="left" valign="top" id="idm45792901358608" scope="col">Values</th></tr></thead><tbody><tr><td align="left" valign="top" headers="idm45792904821712">
									<p>
										WORKER_COUNT_REGISTRY
									</p>
									</td><td align="left" valign="top" headers="idm45792904820624">
									<p>
										Specifies the number of processes to handle Registry requests within the <code class="literal">Quay</code> container.
									</p>
									</td><td align="left" valign="top" headers="idm45792901358608">
									<p>
										Integer between 8 and 64
									</p>
									</td></tr><tr><td align="left" valign="top" headers="idm45792904821712">
									<p>
										WORKER_COUNT_WEB
									</p>
									</td><td align="left" valign="top" headers="idm45792904820624">
									<p>
										Specifies the number of processes to handle UI/Web requests within the container.
									</p>
									</td><td align="left" valign="top" headers="idm45792901358608">
									<p>
										Integer between 2 and 32
									</p>
									</td></tr><tr><td align="left" valign="top" headers="idm45792904821712">
									<p>
										WORKER_COUNT_SECSCAN
									</p>
									</td><td align="left" valign="top" headers="idm45792904820624">
									<p>
										Specifies the number of processes to handle Security Scanning (e.g. Clair) integration within the container.
									</p>
									</td><td align="left" valign="top" headers="idm45792901358608">
									<p>
										Integer between 2 and 4
									</p>
									</td></tr><tr><td align="left" valign="top" headers="idm45792904821712">
									<p>
										DB_CONNECTION_POOLING
									</p>
									</td><td align="left" valign="top" headers="idm45792904820624">
									<p>
										Toggle database connection pooling. In 3.4, it is disabled by default.
									</p>
									</td><td align="left" valign="top" headers="idm45792901358608">
									<p>
										"true" or "false"
									</p>
									</td></tr></tbody></table></div></div></section><section class="section" id="turning_off_connection_pooling"><div class="titlepage"><div><div><h4 class="title">1.3.4.6. Turning off connection pooling</h4></div></div></div><p>
						Red Hat Quay deployments with a large amount of user activity can regularly hit the 2k maximum database connection limit. In these cases, connection pooling, which is enabled by default for Red Hat Quay, can cause database connection count to rise exponentially and require you to turn off connection pooling.
					</p><p>
						If turning off connection pooling is not enough to prevent hitting that 2k database connection limit, you need to take additional steps to deal with the problem. In this case you might need to increase the maximum database connections to better suit your workload.
					</p></section></section></section></section><section class="chapter" id="using_the_configuration_api"><div class="titlepage"><div><div><h1 class="title">Chapter 2. Using the configuration API</h1></div></div></div><p>
			The configuration tool exposes 4 endpoints that can be used to build, validate, bundle and deploy a configuration. The config-tool API is documented at <a class="link" href="https://github.com/quay/config-tool/blob/master/pkg/lib/editor/API.md">https://github.com/quay/config-tool/blob/master/pkg/lib/editor/API.md</a>. In this section, you will see how to use the API to retrieve the current configuration and how to validate any changes you make.
		</p><section class="section" id="retrieving_the_default_configuration"><div class="titlepage"><div><div><h2 class="title">2.1. Retrieving the default configuration</h2></div></div></div><p>
				If you are running the configuration tool for the first time, and do not have an existing configuration, you can retrieve the default configuration. Start the container in config mode:
			</p><pre class="literallayout">$ sudo podman run --rm -it --name quay_config \
  -p 8080:8080 \
  registry.redhat.io/quay/quay-rhel8:v3.6.2 config secret</pre><p>
				Use the <code class="literal">config</code> endpoint of the configuration API to get the default:
			</p><pre class="literallayout">$ curl -X GET -u quayconfig:secret http://quay-server:8080/api/v1/config  | jq</pre><p>
				The value returned is the default configuration in JSON format:
			</p><pre class="programlisting language-json">{
  "config.yaml": {
    "AUTHENTICATION_TYPE": "Database",
    "AVATAR_KIND": "local",
    "DB_CONNECTION_ARGS": {
      "autorollback": true,
      "threadlocals": true
    },
    "DEFAULT_TAG_EXPIRATION": "2w",
    "EXTERNAL_TLS_TERMINATION": false,
    "FEATURE_ACTION_LOG_ROTATION": false,
    "FEATURE_ANONYMOUS_ACCESS": true,
    "FEATURE_APP_SPECIFIC_TOKENS": true,
    ....
  }

}</pre></section><section class="section" id="retrieving_the_current_configuration"><div class="titlepage"><div><div><h2 class="title">2.2. Retrieving the current configuration</h2></div></div></div><p>
				If you have already configured and deployed the Quay registry, stop the container and restart it in configuration mode, loading the existing configuration as a volume:
			</p><pre class="literallayout">$ sudo podman run --rm -it --name quay_config \
  -p 8080:8080 \
  -v $QUAY/config:/conf/stack:Z \
  registry.redhat.io/quay/quay-rhel8:v3.6.2 config secret</pre><p>
				Use the <code class="literal">config</code> endpoint of the API to get the current configuration:
			</p><pre class="literallayout">$ curl -X GET -u quayconfig:secret http://quay-server:8080/api/v1/config  | jq</pre><p>
				The value returned is the current configuration in JSON format, including database and Redis configuration data:
			</p><pre class="programlisting language-json">{
  "config.yaml": {
    ....
    "BROWSER_API_CALLS_XHR_ONLY": false,
    "BUILDLOGS_REDIS": {
      "host": "quay-server",
      "password": "strongpassword",
      "port": 6379
    },
    "DATABASE_SECRET_KEY": "4b1c5663-88c6-47ac-b4a8-bb594660f08b",
    "DB_CONNECTION_ARGS": {
      "autorollback": true,
      "threadlocals": true
    },
    "DB_URI": "postgresql://quayuser:quaypass@quay-server:5432/quay",
    "DEFAULT_TAG_EXPIRATION": "2w",
    ....


  }

}</pre></section><section class="section" id="validating_configuration_using_the_api"><div class="titlepage"><div><div><h2 class="title">2.3. Validating configuration using the API</h2></div></div></div><p>
				You can validate a configuration by posting it to the <code class="literal">config/validate</code> endpoint:
			</p><pre class="literallayout">curl -u quayconfig:secret --header 'Content-Type: application/json' --request POST --data '
{
  "config.yaml": {
    ....
    "BROWSER_API_CALLS_XHR_ONLY": false,
    "BUILDLOGS_REDIS": {
      "host": "quay-server",
      "password": "strongpassword",
      "port": 6379
    },
    "DATABASE_SECRET_KEY": "4b1c5663-88c6-47ac-b4a8-bb594660f08b",
    "DB_CONNECTION_ARGS": {
      "autorollback": true,
      "threadlocals": true
    },
    "DB_URI": "postgresql://quayuser:quaypass@quay-server:5432/quay",
    "DEFAULT_TAG_EXPIRATION": "2w",
    ....

  }

} http://quay-server:8080/api/v1/config/validate | jq</pre><p>
				The returned value is an array containing the errors found in the configuration. If the configuration is valid, an empty array <code class="literal">[]</code> is returned.
			</p></section><section class="section" id="determining_the_required_fields"><div class="titlepage"><div><div><h2 class="title">2.4. Determining the required fields</h2></div></div></div><p>
				You can determine the required fields by posting an empty configuration structure to the <code class="literal">config/validate</code> endpoint:
			</p><pre class="literallayout">curl -u quayconfig:secret --header 'Content-Type: application/json' --request POST --data '
{
  "config.yaml": {
  }

} http://quay-server:8080/api/v1/config/validate | jq</pre><p>
				The value returned is an array indicating which fields are required:
			</p><pre class="programlisting language-yaml">[
  {
    "FieldGroup": "Database",
    "Tags": [
      "DB_URI"
    ],
    "Message": "DB_URI is required."
  },
  {
    "FieldGroup": "DistributedStorage",
    "Tags": [
      "DISTRIBUTED_STORAGE_CONFIG"
    ],
    "Message": "DISTRIBUTED_STORAGE_CONFIG must contain at least one storage location."
  },
  {
    "FieldGroup": "HostSettings",
    "Tags": [
      "SERVER_HOSTNAME"
    ],
    "Message": "SERVER_HOSTNAME is required"
  },
  {
    "FieldGroup": "HostSettings",
    "Tags": [
      "SERVER_HOSTNAME"
    ],
    "Message": "SERVER_HOSTNAME must be of type Hostname"
  },
  {
    "FieldGroup": "Redis",
    "Tags": [
      "BUILDLOGS_REDIS"
    ],
    "Message": "BUILDLOGS_REDIS is required"
  }
]</pre></section></section><section class="chapter" id="release-notifications"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Getting Red Hat Quay release notifications</h1></div></div></div><p>
			To keep up with the latest Red Hat Quay releases and other changes related to Red Hat Quay, you can sign up for update notifications on the <a class="link" href="https://access.redhat.com">Red Hat Customer Portal</a>. After signing up for notifications, you will receive notifications letting you know when there is new a Red Hat Quay version, updated documentation, or other Red Hat Quay news.
		</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
					Log into the <a class="link" href="https://access.redhat.com">Red Hat Customer Portal</a> with your Red Hat customer account credentials.
				</li><li class="listitem">
					Select your user name (upper-right corner) to see Red Hat Account and Customer Portal selections: 
					<span class="inlinemediaobject"><img src="images/notification-profile.png" alt="View account and portal selections"/></span>
				</li><li class="listitem">
					Select Notifications. Your profile activity page appears.
				</li><li class="listitem">
					Select the Notifications tab.
				</li><li class="listitem">
					Select Manage Notifications.
				</li><li class="listitem">
					Select Follow, then choose Products from the drop-down box.
				</li><li class="listitem">
					From the drop-down box next to the Products, search for and select Red Hat Quay: 
					<span class="inlinemediaobject"><img src="images/notification-follow.png" alt="Select Products from notifications box"/></span>
				</li><li class="listitem">
					Select the SAVE NOTIFICATION button. Going forward, you will receive notifications when there are changes to the Red Hat Quay product, such as a new release.
				</li></ol></div></section><section class="chapter" id="using-ssl-to-protect-quay"><div class="titlepage"><div><div><h1 class="title">Chapter 4. Using SSL to protect connections to Red Hat Quay</h1></div></div></div><section class="section" id="introduction_to_using_ssl"><div class="titlepage"><div><div><h2 class="title">4.1. Introduction to using SSL</h2></div></div></div><p>
				To configure Red Hat Quay with a <a class="link" href="https://en.wikipedia.org/wiki/Self-signed_certificate">self-signed certificate</a>, you need to create a Certificate Authority (CA) and then generate the required key and certificate files.
			</p><p>
				The following examples assume you have configured the server hostname <code class="literal">quay-server.example.com</code> using DNS or another naming mechanism, such as adding an entry in your <code class="literal">/etc/hosts</code> file:
			</p><pre class="literallayout">$ cat /etc/hosts
...
192.168.1.112   quay-server.example.com</pre></section><section class="section" id="create-a-ca-and-sign-a-certificate"><div class="titlepage"><div><div><h2 class="title">4.2. Create a Certificate Authority and sign a certificate</h2></div></div></div><p>
				At the end of this procedure, you will have a certificate file and a primary key file named <code class="literal">ssl.cert</code> and <code class="literal">ssl.key</code>, respectively.
			</p><section class="section" id="create_a_certificate_authority"><div class="titlepage"><div><div><h3 class="title">4.2.1. Create a Certificate Authority</h3></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Generate the root CA key:
						</p><pre class="screen">$ openssl genrsa -out rootCA.key 2048</pre></li><li class="listitem"><p class="simpara">
							Generate the root CA cert:
						</p><pre class="screen">$ openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 1024 -out rootCA.pem</pre></li><li class="listitem"><p class="simpara">
							Enter the information that will be incorporated into your certificate request, including the server hostname, for example:
						</p><pre class="screen">Country Name (2 letter code) [XX]:IE
State or Province Name (full name) []:GALWAY
Locality Name (eg, city) [Default City]:GALWAY
Organization Name (eg, company) [Default Company Ltd]:QUAY
Organizational Unit Name (eg, section) []:DOCS
Common Name (eg, your name or your server's hostname) []:quay-server.example.com</pre></li></ol></div></section><section class="section" id="sign_a_certificate"><div class="titlepage"><div><div><h3 class="title">4.2.2. Sign a certificate</h3></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Generate the server key:
						</p><pre class="screen">$ openssl genrsa -out ssl.key 2048</pre></li><li class="listitem"><p class="simpara">
							Generate a signing request:
						</p><pre class="screen">$ openssl req -new -key ssl.key -out ssl.csr</pre></li><li class="listitem"><p class="simpara">
							Enter the information that will be incorporated into your certificate request, including the server hostname, for example:
						</p><pre class="screen">Country Name (2 letter code) [XX]:IE
State or Province Name (full name) []:GALWAY
Locality Name (eg, city) [Default City]:GALWAY
Organization Name (eg, company) [Default Company Ltd]:QUAY
Organizational Unit Name (eg, section) []:DOCS
Common Name (eg, your name or your server's hostname) []:quay-server.example.com</pre></li><li class="listitem"><p class="simpara">
							Create a configuration file <code class="literal">openssl.cnf</code>, specifying the server hostname, for example:
						</p><div class="formalpara"><p class="title"><strong>openssl.cnf</strong></p><p>
								
<pre class="screen">[req]
req_extensions = v3_req
distinguished_name = req_distinguished_name
[req_distinguished_name]
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names
[alt_names]
DNS.1 = quay-server.example.com
IP.1 = 192.168.1.112</pre>
							</p></div></li><li class="listitem"><p class="simpara">
							Use the configuration file to generate the certificate <code class="literal">ssl.cert</code>:
						</p><pre class="screen">$ openssl x509 -req -in ssl.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out ssl.cert -days 356 -extensions v3_req -extfile openssl.cnf</pre></li></ol></div></section></section><section class="section" id="configuring_ssl_using_the_command_line"><div class="titlepage"><div><div><h2 class="title">4.3. Configuring SSL using the command line</h2></div></div></div><p>
				Another option when configuring SSL is to use the command line interface.
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						Copy the certificate file and primary key file to your configuration directory, ensuring they are named <code class="literal">ssl.cert</code> and <code class="literal">ssl.key</code> respectively:
					</p><pre class="screen">$ cp ~/ssl.cert $QUAY/config
$ cp ~/ssl.key $QUAY/config
$ cd $QUAY/config</pre></li><li class="listitem"><p class="simpara">
						Edit the <code class="literal">config.yaml</code> file and specify that you want Quay to handle TLS:
					</p><div class="formalpara"><p class="title"><strong>config.yaml</strong></p><p>
							
<pre class="programlisting language-yaml">...
SERVER_HOSTNAME: quay-server.example.com
...
PREFERRED_URL_SCHEME: https
...</pre>
						</p></div></li><li class="listitem"><p class="simpara">
						Stop the <code class="literal">Quay</code> container and restart the registry:
					</p><pre class="screen">$ sudo podman rm -f quay
$ sudo podman run -d --rm -p 80:8080 -p 443:8443 \
  --name=quay \
  -v $QUAY/config:/conf/stack:Z \
  -v $QUAY/storage:/datastorage:Z \
  registry.redhat.io/quay/quay-rhel8:v3.6.2</pre></li></ol></div></section><section class="section" id="configuring_ssl_using_the_ui"><div class="titlepage"><div><div><h2 class="title">4.4. Configuring SSL using the UI</h2></div></div></div><p>
				This section configures SSL using the Quay UI. To configure SSL using the command line interface, see the following section.
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						Start the <code class="literal">Quay</code> container in configuration mode:
					</p><pre class="screen">$ sudo podman run --rm -it --name quay_config -p 80:8080 -p 443:8443 registry.redhat.io/quay/quay-rhel8:v3.6.2 config secret</pre></li><li class="listitem">
						In the Server Configuration section, select <code class="literal">Red Hat Quay handles TLS</code> for TLS. Upload the certificate file and private key file created earlier, ensuring that the Server Hostname matches the value used when creating the certs. Validate and download the updated configuration.
					</li><li class="listitem"><p class="simpara">
						Stop the <code class="literal">Quay</code> container and then restart the registry:
					</p><pre class="screen">$ sudo podman rm -f quay
$ sudo podman run -d --rm -p 80:8080 -p 443:8443 \
--name=quay \
-v $QUAY/config:/conf/stack:Z \
-v $QUAY/storage:/datastorage:Z \
registry.redhat.io/quay/quay-rhel8:v3.6.2</pre></li></ol></div></section><section class="section" id="testing_ssl_configuration_using_the_command_line"><div class="titlepage"><div><div><h2 class="title">4.5. Testing SSL configuration using the command line</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
						Use the <code class="literal">podman login</code> command to attempt to log in to the Quay registry with SSL enabled:
					</p><pre class="screen">$ sudo podman login quay-server.example.com
Username: quayadmin
Password:

Error: error authenticating creds for "quay-server.example.com": error pinging docker registry quay-server.example.com: Get "https://quay-server.example.com/v2/": x509: certificate signed by unknown authority</pre></li><li class="listitem"><p class="simpara">
						Podman does not trust self-signed certificates. As a workaround, use the <code class="literal">--tls-verify</code> option:
					</p><pre class="screen">$ sudo podman login --tls-verify=false quay-server.example.com
Username: quayadmin
Password:

Login Succeeded!</pre></li></ul></div><p>
				Configuring Podman to trust the root Certificate Authority (CA) is covered in a subsequent section.
			</p></section><section class="section" id="testing_ssl_configuration_using_the_browser"><div class="titlepage"><div><div><h2 class="title">4.6. Testing SSL configuration using the browser</h2></div></div></div><p>
				When you attempt to access the Quay registry, in this case, <code class="literal"><a class="link" href="https://quay-server.example.com">https://quay-server.example.com</a></code>, the browser warns of the potential risk:
			</p><p>
				<span class="inlinemediaobject"><img src="images/ssl-connection-not-private.png" alt="Potential risk"/></span>
			</p><p>
				Proceed to the log in screen, and the browser will notify you that the connection is not secure:
			</p><p>
				<span class="inlinemediaobject"><img src="images/ssl-connection-not-secure.png" alt="Connection not secure"/></span>
			</p><p>
				Configuring the system to trust the root Certificate Authority (CA) is covered in the subsequent section.
			</p></section><section class="section" id="configuring_podman_to_trust_the_certificate_authority"><div class="titlepage"><div><div><h2 class="title">4.7. Configuring podman to trust the Certificate Authority</h2></div></div></div><p>
				Podman uses two paths to locate the CA file, namely, <code class="literal">/etc/containers/certs.d/</code> and <code class="literal">/etc/docker/certs.d/</code>.
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
						Copy the root CA file to one of these locations, with the exact path determined by the server hostname, and naming the file <code class="literal">ca.crt</code>:
					</p><pre class="screen">$ sudo cp rootCA.pem /etc/containers/certs.d/quay-server.example.com/ca.crt</pre></li><li class="listitem"><p class="simpara">
						Alternatively, if you are using Docker, you can copy the root CA file to the equivalent Docker directory:
					</p><pre class="screen">$ sudo cp rootCA.pem /etc/docker/certs.d/quay-server.example.com/ca.crt</pre></li></ul></div><p>
				You should no longer need to use the <code class="literal">--tls-verify=false</code> option when logging in to the registry:
			</p><pre class="screen">$ sudo podman login quay-server.example.com

Username: quayadmin
Password:
Login Succeeded!</pre></section><section class="section" id="configuring_the_system_to_trust_the_certificate_authority"><div class="titlepage"><div><div><h2 class="title">4.8. Configuring the system to trust the certificate authority</h2></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						Copy the root CA file to the consolidated system-wide trust store:
					</p><pre class="screen">$ sudo cp rootCA.pem /etc/pki/ca-trust/source/anchors/</pre></li><li class="listitem"><p class="simpara">
						Update the system-wide trust store configuration:
					</p><pre class="screen">$ sudo update-ca-trust extract</pre></li><li class="listitem"><p class="simpara">
						You can use the <code class="literal">trust list</code> command to ensure that the Quay server has been configured:
					</p><pre class="screen">$ trust list | grep quay
    label: quay-server.example.com</pre><p class="simpara">
						Now, when you browse to the registry at <code class="literal"><a class="link" href="https://quay-server.example.com">https://quay-server.example.com</a></code>, the lock icon shows that the connection is secure:
					</p><p class="simpara">
						<span class="inlinemediaobject"><img src="images/ssl-connection-secure.png" alt="Connection not secure"/></span>
					</p></li><li class="listitem"><p class="simpara">
						To remove the root CA from system-wide trust, delete the file and update the configuration:
					</p><pre class="screen">$ sudo rm /etc/pki/ca-trust/source/anchors/rootCA.pem
$ sudo update-ca-trust extract
$ trust list | grep quay
$</pre></li></ol></div><p>
				More information can be found in the RHEL 8 documentation in the chapter <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/security_hardening/using-shared-system-certificates_security-hardening">Using shared system certificates</a>.
			</p></section></section><section class="chapter" id="config-custom-ssl-certs-manual"><div class="titlepage"><div><div><h1 class="title">Chapter 5. Adding TLS Certificates to the Red Hat Quay Container</h1></div></div></div><p>
			To add custom TLS certificates to Red Hat Quay, create a new directory named <code class="literal">extra_ca_certs/</code> beneath the Red Hat Quay config directory. Copy any required site-specific TLS certificates to this new directory.
		</p><section class="section" id="add-certificates-to-quay-container"><div class="titlepage"><div><div><h2 class="title">5.1. Add TLS certificates to Red Hat Quay</h2></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						View certificate to be added to the container
					</p><pre class="screen">$ cat storage.crt
-----BEGIN CERTIFICATE-----
MIIDTTCCAjWgAwIBAgIJAMVr9ngjJhzbMA0GCSqGSIb3DQEBCwUAMD0xCzAJBgNV
[...]
-----END CERTIFICATE-----</pre></li><li class="listitem"><p class="simpara">
						Create certs directory and copy certificate there
					</p><pre class="screen">$ mkdir -p quay/config/extra_ca_certs
$ cp storage.crt quay/config/extra_ca_certs/
$ tree quay/config/
├── config.yaml
├── extra_ca_certs
│   ├── storage.crt</pre></li><li class="listitem"><p class="simpara">
						Obtain the <code class="literal">Quay</code> container’s <code class="literal">CONTAINER ID</code> with <code class="literal">podman ps</code>:
					</p><pre class="screen">$ sudo podman ps
CONTAINER ID        IMAGE                                COMMAND                  CREATED             STATUS              PORTS
5a3e82c4a75f        &lt;registry&gt;/&lt;repo&gt;/quay:v3.6.2 "/sbin/my_init"          24 hours ago        Up 18 hours         0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 443/tcp   grave_keller</pre></li><li class="listitem"><p class="simpara">
						Restart the container with that ID:
					</p><pre class="screen">$ sudo podman restart 5a3e82c4a75f</pre></li><li class="listitem"><p class="simpara">
						Examine the certificate copied into the container namespace:
					</p><pre class="screen">$ sudo podman exec -it 5a3e82c4a75f cat /etc/ssl/certs/storage.pem
-----BEGIN CERTIFICATE-----
MIIDTTCCAjWgAwIBAgIJAMVr9ngjJhzbMA0GCSqGSIb3DQEBCwUAMD0xCzAJBgNV</pre></li></ol></div></section><section class="section" id="config-custom-ssl-cert-kubernetes"><div class="titlepage"><div><div><h2 class="title">5.2. Add certs when deployed on Kubernetes</h2></div></div></div><p>
				When deployed on Kubernetes, Red Hat Quay mounts in a secret as a volume to store config assets. Unfortunately, this currently breaks the upload certificate function of the superuser panel.
			</p><p>
				To get around this error, a base64 encoded certificate can be added to the secret <span class="emphasis"><em>after</em></span> Red Hat Quay has been deployed. Here’s how:
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						Begin by base64 encoding the contents of the certificate:
					</p><pre class="screen">$ cat ca.crt
-----BEGIN CERTIFICATE-----
MIIDljCCAn6gAwIBAgIBATANBgkqhkiG9w0BAQsFADA5MRcwFQYDVQQKDA5MQUIu
TElCQ09SRS5TTzEeMBwGA1UEAwwVQ2VydGlmaWNhdGUgQXV0aG9yaXR5MB4XDTE2
MDExMjA2NTkxMFoXDTM2MDExMjA2NTkxMFowOTEXMBUGA1UECgwOTEFCLkxJQkNP
UkUuU08xHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTCCASIwDQYJKoZI
[...]
-----END CERTIFICATE-----

$ cat ca.crt | base64 -w 0
[...]
c1psWGpqeGlPQmNEWkJPMjJ5d0pDemVnR2QNCnRsbW9JdEF4YnFSdVd3PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</pre></li><li class="listitem"><p class="simpara">
						Use the <code class="literal">kubectl</code> tool to edit the quay-enterprise-config-secret.
					</p><pre class="screen">$ kubectl --namespace quay-enterprise edit secret/quay-enterprise-config-secret</pre></li><li class="listitem"><p class="simpara">
						Add an entry for the cert and paste the full base64 encoded string under the entry:
					</p><pre class="screen">  custom-cert.crt:
c1psWGpqeGlPQmNEWkJPMjJ5d0pDemVnR2QNCnRsbW9JdEF4YnFSdVd3PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</pre></li><li class="listitem">
						Finally, recycle all Red Hat Quay pods. Use <code class="literal">kubectl delete</code> to remove all Red Hat Quay pods. The Red Hat Quay Deployment will automatically schedule replacement pods with the new certificate data.
					</li></ol></div></section></section><section class="chapter" id="proc_manage-log-storage"><div class="titlepage"><div><div><h1 class="title">Chapter 6. Configuring action log storage for Elasticsearch</h1></div></div></div><p>
			By default, the past three months of usage logs are stored in the Red Hat Quay database and exposed via the web UI on organization and repository levels. Appropriate administrative privileges are required to see log entries. For deployments with a large amount of logged operations, you can now store the usage logs in Elasticsearch instead of the Red Hat Quay database backend. To do this, you need to provide your own Elasticsearch stack, as it is not included with Red Hat Quay as a customizable component.
		</p><p>
			Enabling Elasticsearch logging can be done during Red Hat Quay deployment or post-deployment using the Red Hat Quay Config Tool. The resulting configuration is stored in the <code class="literal">config.yaml</code> file. Once configured, usage log access continues to be provided the same way, via the web UI for repositories and organizations.
		</p><p>
			Here’s how to configure action log storage to change it from the default Red Hat Quay database to use Elasticsearch:
		</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
					Obtain an Elasticsearch account.
				</li><li class="listitem">
					Open the Red Hat Quay Config Tool (either during or after Red Hat Quay deployment).
				</li><li class="listitem"><p class="simpara">
					Scroll to the <span class="emphasis"><em>Action Log Storage Configuration</em></span> setting and select <span class="emphasis"><em>Elasticsearch</em></span> instead of <span class="emphasis"><em>Database</em></span>. The following figure shows the Elasticsearch settings that appear:
				</p><p class="simpara">
					<span class="inlinemediaobject"><img src="images/elasticsearch_action_logs.png" alt="Choose Elasticsearch to view settings to store logs"/></span>
				</p></li><li class="listitem"><p class="simpara">
					Fill in the following information for your Elasticsearch instance:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Elasticsearch hostname</strong></span>: The hostname or IP address of the system providing the Elasticsearch service.
						</li><li class="listitem">
							<span class="strong strong"><strong>Elasticsearch port</strong></span>: The port number providing the Elasticsearch service on the host you just entered. Note that the port must be accessible from all systems running the Red Hat Quay registry. The default is TCP port 9200.
						</li><li class="listitem">
							<span class="strong strong"><strong>Elasticsearch access key</strong></span>: The access key needed to gain access to the Elastic search service, if required.
						</li><li class="listitem">
							<span class="strong strong"><strong>Elasticsearch secret key</strong></span>: The secret key needed to gain access to the Elastic search service, if required.
						</li><li class="listitem">
							<span class="strong strong"><strong>AWS region</strong></span>: If you are running on AWS, set the AWS region (otherwise, leave it blank).
						</li><li class="listitem">
							<span class="strong strong"><strong>Index prefix</strong></span>: Choose a prefix to attach to log entries.
						</li><li class="listitem"><p class="simpara">
							<span class="strong strong"><strong>Logs Producer</strong></span>: Choose either Elasticsearch (default) or Kinesis to direct logs to an intermediate Kinesis stream on AWS. You need to set up your own pipeline to send logs from Kinesis to Elasticsearch (for example, Logstash). The following figure shows additional fields you would need to fill in for Kinesis:
						</p><p class="simpara">
							<span class="inlinemediaobject"><img src="images/kinesis_producer.png" alt="On AWS optionally set up an intermediate Kinesis stream"/></span>
						</p></li></ul></div></li><li class="listitem"><p class="simpara">
					If you chose Elasticsearch as the Logs Producer, no further configuration is needed. If you chose Kinesis, fill in the following:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Stream name</strong></span>: The name of the Kinesis stream.
						</li><li class="listitem">
							<span class="strong strong"><strong>AWS access key</strong></span>: The name of the AWS access key needed to gain access to the Kinesis stream, if required.
						</li><li class="listitem">
							<span class="strong strong"><strong>AWS secret key</strong></span>: The name of the AWS secret key needed to gain access to the Kinesis stream, if required.
						</li><li class="listitem">
							<span class="strong strong"><strong>AWS region</strong></span>: The AWS region.
						</li></ul></div></li><li class="listitem">
					When you are done, save the configuration. The Config Tool checks your settings. If there is a problem connecting to the Elasticsearch or Kinesis services, you will see an error and have the opportunity to continue editing. Otherwise, logging will begin to be directed to your Elasticsearch configuration after the cluster restarts with the new configuration.
				</li></ol></div></section><section class="chapter" id="clair-intro2"><div class="titlepage"><div><div><h1 class="title">Chapter 7. Clair Security Scanning</h1></div></div></div><p>
			Clair is a set of micro services that can be used with Red Hat Quay to perform vulnerability scanning of container images associated with a set of Linux operating systems. The micro services design of Clair makes it appropriate to run in a highly scalable configuration, where components can be scaled separately as appropriate for enterprise environments.
		</p><p>
			Clair uses the following vulnerability databases to scan for issues in your images:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Alpine SecDB database
				</li><li class="listitem">
					AWS UpdateInfo
				</li><li class="listitem">
					Debian Oval database
				</li><li class="listitem">
					Oracle Oval database
				</li><li class="listitem">
					RHEL Oval database
				</li><li class="listitem">
					SUSE Oval database
				</li><li class="listitem">
					Ubuntu Oval database
				</li><li class="listitem">
					Pyup.io (python) database
				</li></ul></div><p>
			For information on how Clair does security mapping with the different databases, see <a class="link" href="https://quay.github.io/claircore/concepts/severity_mapping.html">ClairCore Severity Mapping</a>.
		</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				With the release of Red Hat Quay 3.4, the new Clair V4 (image registry.redhat.io/quay/clair-rhel8 fully replaces the prior Clair V2 (image quay.io/redhat/clair-jwt). See below for how to run V2 in read-only mode while V4 is updating.
			</p></div></div><section class="section" id="clair-openshift"><div class="titlepage"><div><div><h2 class="title">7.1. Setting Up Clair on a Red Hat Quay OpenShift deployment</h2></div></div></div><section class="section" id="deploying_via_the_quay_operator"><div class="titlepage"><div><div><h3 class="title">7.1.1. Deploying Via the Quay Operator</h3></div></div></div><p>
					To set up Clair V4 on a new Red Hat Quay deployment on OpenShift, it is highly recommended to use the Quay Operator. By default, the Quay Operator will install or upgrade a Clair deployment along with your Red Hat Quay deployment and configure Clair security scanning automatically.
				</p></section><section class="section" id="clair-openshift-manual"><div class="titlepage"><div><div><h3 class="title">7.1.2. Manually Deploying Clair</h3></div></div></div><p>
					To configure Clair V4 on an existing Red Hat Quay OpenShift deployment running Clair V2, first ensure Red Hat Quay has been upgraded to at least version 3.4.0. Then use the following steps to manually set up Clair V4 alongside Clair V2.
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Set your current project to the name of the project in which Red Hat Quay is running. For example:
						</p><pre class="screen">$ oc project quay-enterprise</pre></li><li class="listitem"><p class="simpara">
							Create a Postgres deployment file for Clair v4 (for example, <code class="literal">clairv4-postgres.yaml</code>) as follows.
						</p><div class="formalpara"><p class="title"><strong>clairv4-postgres.yaml</strong></p><p>
								
<pre class="programlisting language-yaml">---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: clairv4-postgres
  namespace: quay-enterprise
  labels:
    quay-component: clairv4-postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      quay-component: clairv4-postgres
  template:
    metadata:
      labels:
        quay-component: clairv4-postgres
    spec:
      volumes:
        - name: postgres-data
          persistentVolumeClaim:
            claimName: clairv4-postgres
      containers:
        - name: postgres
          image: postgres:11.5
          imagePullPolicy: "IfNotPresent"
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              value: "postgres"
            - name: POSTGRES_DB
              value: "clair"
            - name: POSTGRES_PASSWORD
              value: "postgres"
            - name: PGDATA
              value: "/etc/postgres/data"
          volumeMounts:
            - name: postgres-data
              mountPath: "/etc/postgres"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: clairv4-postgres
  labels:
    quay-component: clairv4-postgres
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: "5Gi"
    volumeName: "clairv4-postgres"
---
apiVersion: v1
kind: Service
metadata:
  name: clairv4-postgres
  labels:
    quay-component: clairv4-postgres
spec:
  type: ClusterIP
  ports:
    - port: 5432
      protocol: TCP
      name: postgres
      targetPort: 5432
  selector:
    quay-component: clairv4-postgres</pre>
							</p></div></li><li class="listitem"><p class="simpara">
							Deploy the postgres database as follows:
						</p><pre class="screen">$ oc create -f ./clairv4-postgres.yaml</pre></li><li class="listitem"><p class="simpara">
							Create a Clair <code class="literal">config.yaml</code> file to use for Clair v4. For example:
						</p><div class="formalpara"><p class="title"><strong>config.yaml</strong></p><p>
								
<pre class="programlisting language-yaml">introspection_addr: :8089
http_listen_addr: :8080
log_level: debug
indexer:
  connstring: host=clairv4-postgres port=5432 dbname=clair user=postgres password=postgres sslmode=disable
  scanlock_retry: 10
  layer_scan_concurrency: 5
  migrations: true
matcher:
  connstring: host=clairv4-postgres port=5432 dbname=clair user=postgres password=postgres sslmode=disable
  max_conn_pool: 100
  run: ""
  migrations: true
  indexer_addr: clair-indexer
notifier:
  connstring: host=clairv4-postgres port=5432 dbname=clair user=postgres password=postgres sslmode=disable
  delivery: 1m
  poll_interval: 5m
  migrations: true
auth:
  psk:
    key: MTU5YzA4Y2ZkNzJoMQ== <span id="CO1-1"/><span class="callout">1</span>
    iss: ["quay"]
# tracing and metrics
trace:
  name: "jaeger"
  probability: 1
  jaeger:
    agent_endpoint: "localhost:6831"
    service_name: "clair"
metrics:
  name: "prometheus"</pre>
							</p></div><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO1-1"><span class="callout">1</span></a> </dt><dd><div class="para">
									To generate a Clair pre-shared key (PSK), enable <code class="literal">scanning</code> in the Security Scanner section of the User Interface and click <code class="literal">Generate PSK</code>.
								</div></dd></dl></div></li></ol></div><p>
					More information about Clair’s configuration format can be found in <a class="link" href="https://quay.github.io/clair/reference/config.html">upstream Clair documentation</a>.
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Create a secret from the Clair <code class="literal">config.yaml</code>:
						</p><pre class="screen">$ oc create secret generic clairv4-config-secret --from-file=./config.yaml</pre></li><li class="listitem"><p class="simpara">
							Create the Clair v4 deployment file (for example, <code class="literal">clair-combo.yaml</code>) and modify it as necessary:
						</p><div class="formalpara"><p class="title"><strong>clair-combo.yaml</strong></p><p>
								
<pre class="programlisting language-yaml">---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    quay-component: clair-combo
  name: clair-combo
spec:
  replicas: 1
  selector:
    matchLabels:
      quay-component: clair-combo
  template:
    metadata:
      labels:
        quay-component: clair-combo
    spec:
      containers:
        - image: registry.redhat.io/quay/clair-rhel8:v3.6.2  <span id="CO2-1"/><span class="callout">1</span>
          imagePullPolicy: IfNotPresent
          name: clair-combo
          env:
            - name: CLAIR_CONF
              value: /clair/config.yaml
            - name: CLAIR_MODE
              value: combo
          ports:
            - containerPort: 8080
              name: clair-http
              protocol: TCP
            - containerPort: 8089
              name: clair-intro
              protocol: TCP
          volumeMounts:
            - mountPath: /clair/
              name: config
      imagePullSecrets:
        - name: redhat-pull-secret
      restartPolicy: Always
      volumes:
        - name: config
          secret:
            secretName: clairv4-config-secret
---
apiVersion: v1
kind: Service
metadata:
  name: clairv4 <span id="CO2-2"/><span class="callout">2</span>
  labels:
    quay-component: clair-combo
spec:
  ports:
    - name: clair-http
      port: 80
      protocol: TCP
      targetPort: 8080
    - name: clair-introspection
      port: 8089
      protocol: TCP
      targetPort: 8089
  selector:
    quay-component: clair-combo
  type: ClusterIP</pre>
							</p></div><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO2-1"><span class="callout">1</span></a> </dt><dd><div class="para">
									Change image to latest clair image name and version.
								</div></dd><dt><a href="#CO2-2"><span class="callout">2</span></a> </dt><dd><div class="para">
									With the Service set to clairv4, the scanner endpoint for Clair v4 is entered later into the Red Hat Quay config.yaml in the <code class="literal">SECURITY_SCANNER_V4_ENDPOINT</code> as <code class="literal">http://clairv4</code>.
								</div></dd></dl></div></li><li class="listitem"><p class="simpara">
							Create the Clair v4 deployment as follows:
						</p><pre class="screen">$ oc create -f ./clair-combo.yaml</pre></li><li class="listitem"><p class="simpara">
							Modify the <code class="literal">config.yaml</code> file for your Red Hat Quay deployment to add the following entries at the end:
						</p><pre class="programlisting language-yaml">FEATURE_SECURITY_SCANNER: true
SECURITY_SCANNER_V4_ENDPOINT: http://clairv4 <span id="CO3-1"/><span class="callout">1</span></pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO3-1"><span class="callout">1</span></a> </dt><dd><div class="para">
									Identify the Clair v4 service endpoint
								</div></dd></dl></div></li><li class="listitem"><p class="simpara">
							Redeploy the modified <code class="literal">config.yaml</code> to the secret containing that file (for example, <code class="literal">quay-enterprise-config-secret</code>:
						</p><pre class="screen">$ oc delete secret quay-enterprise-config-secret
$ oc create secret generic quay-enterprise-config-secret --from-file=./config.yaml</pre></li><li class="listitem">
							For the new <code class="literal">config.yaml</code> to take effect, you need to restart the Red Hat Quay pods. Simply deleting the <code class="literal">quay-app</code> pods causes pods with the updated configuration to be deployed.
						</li></ol></div><p>
					At this point, images in any of the organizations identified in the namespace whitelist will be scanned by Clair v4.
				</p></section></section><section class="section" id="clair-standalone"><div class="titlepage"><div><div><h2 class="title">7.2. Setting up Clair on a non-OpenShift Red Hat Quay deployment</h2></div></div></div><p>
				For Red Hat Quay deployments not running on OpenShift, it is possible to configure Clair security scanning manually. Red Hat Quay deployments already running Clair V2 can use the instructions below to add Clair V4 to their deployment.
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						Deploy a (preferably fault-tolerant) Postgres database server. Note that Clair requires the <code class="literal">uuid-ossp</code> extension to be added to its Postgres database. If the user supplied in Clair’s <code class="literal">config.yaml</code> has the necessary privileges to create the extension then it will be added automatically by Clair itself. If not, then the extension must be added before starting Clair. If the extension is not present, the following error will be displayed when Clair attempts to start.
					</p><pre class="screen">ERROR: Please load the "uuid-ossp" extension. (SQLSTATE 42501)</pre></li><li class="listitem"><p class="simpara">
						Create a Clair config file in a specific folder, for example, <code class="literal">/etc/clairv4/config/config.yaml</code>).
					</p><div class="formalpara"><p class="title"><strong>config.yaml</strong></p><p>
							
<pre class="programlisting language-yaml">introspection_addr: :8089
http_listen_addr: :8080
log_level: debug
indexer:
  connstring: host=clairv4-postgres port=5432 dbname=clair user=postgres password=postgres sslmode=disable
  scanlock_retry: 10
  layer_scan_concurrency: 5
  migrations: true
matcher:
  connstring: host=clairv4-postgres port=5432 dbname=clair user=postgres password=postgres sslmode=disable
  max_conn_pool: 100
  run: ""
  migrations: true
  indexer_addr: clair-indexer
notifier:
  connstring: host=clairv4-postgres port=5432 dbname=clair user=postgres password=postgres sslmode=disable
  delivery_interval: 1m
  poll_interval: 5m
  migrations: true

# tracing and metrics
trace:
  name: "jaeger"
  probability: 1
  jaeger:
    agent_endpoint: "localhost:6831"
    service_name: "clair"
metrics:
  name: "prometheus"</pre>
						</p></div></li></ol></div><p>
				More information about Clair’s configuration format can be found in <a class="link" href="https://quay.github.io/clair/reference/config.html">upstream Clair documentation</a>.
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						Run Clair via the container image, mounting in the configuration from the file you created.
					</p><pre class="screen">$ podman run -p 8080:8080 -p 8089:8089 -e CLAIR_CONF=/clair/config.yaml -e CLAIR_MODE=combo -v /etc/clair4/config:/clair -d registry.redhat.io/quay/clair-rhel8:v3.6.2</pre></li><li class="listitem">
						Follow the remaining instructions from the previous section for configuring Red Hat Quay to use the new Clair V4 endpoint.
					</li></ol></div><p>
				Running multiple Clair containers in this fashion is also possible, but for deployment scenarios beyond a single container the use of a container orchestrator like Kubernetes or OpenShift is strongly recommended.
			</p></section><section class="section" id="clair-using"><div class="titlepage"><div><div><h2 class="title">7.3. Using Clair</h2></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
						Log in to your Red Hat Quay cluster and select an organization for which you have configured Clair scanning.
					</li><li class="listitem"><p class="simpara">
						Select a repository from that organization that holds some images and select Tags from the left navigation. The following figure shows an example of a repository with two images that have been scanned:
					</p><p class="simpara">
						<span class="inlinemediaobject"><img src="images/clair-reposcan.png" alt="Security scan information appears for scanned repository images"/></span>
					</p></li><li class="listitem"><p class="simpara">
						If vulnerabilities are found, select to under the Security Scan column for the image to see either all vulnerabilities or those that are fixable. The following figure shows information on all vulnerabilities found:
					</p><p class="simpara">
						<span class="inlinemediaobject"><img src="images/clair-vulnerabilities.png" alt="See all vulnerabilities or only those that are fixable"/></span>
					</p></li></ol></div></section><section class="section" id="clair-cve"><div class="titlepage"><div><div><h2 class="title">7.4. CVE ratings from the National Vulnerability Database</h2></div></div></div><p>
				With Clair v4.2, enrichment data is now viewable in the Quay UI. Additionally, Clair v4.2 adds CVSS scores from the National Vulnerability Database for detected vulnerabilities.
			</p><p>
				With this change, if the vulnerability has a CVSS score that is within 2 levels of the distro’s score, the Quay UI present’s the distro’s score by default. For example:
			</p><p>
				<span class="inlinemediaobject"><img src="images/clair-4-2-enrichment-data.png" alt="Clair v4.2 data display"/></span>
			</p><p>
				This differs from the previous interface, which would only display the following information:
			</p><p>
				<span class="inlinemediaobject"><img src="images/clair-4-0-cve-report.png" alt="Clair v4 data display"/></span>
			</p></section><section class="section" id="clair-disconnected"><div class="titlepage"><div><div><h2 class="title">7.5. Configuring Clair for Disconnected Environments</h2></div></div></div><p>
				Clair utilizes a set of components called Updaters to handle the fetching and parsing of data from various vulnerability databases. These Updaters are set up by default to pull vulnerability data directly from the internet and work out of the box. For customers in disconnected environments without direct access to the internet this poses a problem. Clair supports these environments through the ability to work with different types of update workflows that take into account network isolation. Using the <code class="literal">clairctl</code> command line utility, any process can easily fetch Updater data from the internet via an open host, securely transfer the data to an isolated host, and then import the Updater data on the isolated host into Clair itself.
			</p><p>
				The steps are as follows.
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						First ensure that your Clair configuration has disabled automated Updaters from running.
					</p><div class="formalpara"><p class="title"><strong>config.yaml</strong></p><p>
							
<pre class="programlisting language-yaml">matcher:
  disable_updaters: true</pre>
						</p></div></li><li class="listitem"><p class="simpara">
						Export out the latest Updater data to a local archive. This requires the <code class="literal">clairctl</code> tool which can be run directly as a binary, or via the Clair container image. Assuming your Clair configuration is in <code class="literal">/etc/clairv4/config/config.yaml</code>, to run via the container image:
					</p><pre class="screen">$ podman run -it --rm -v /etc/clairv4/config:/cfg:Z -v /path/to/output/directory:/updaters:Z --entrypoint /bin/clairctl registry.redhat.io/quay/clair-rhel8:v3.6.2 --config /cfg/config.yaml export-updaters  /updaters/updaters.gz</pre><p class="simpara">
						Note that you need to explicitly reference the Clair configuration. This will create the Updater archive in <code class="literal">/etc/clairv4/updaters/updaters.gz</code>. If you want to ensure the archive was created without any errors from the source databases, you can supply the <code class="literal">--strict</code> flag to <code class="literal">clairctl</code>. The archive file should be copied over to a volume that is accessible from the disconnected host running Clair. From the disconnected host, use the same procedure now to import the archive into Clair.
					</p><pre class="screen">$ podman run -it --rm -v /etc/clairv4/config:/cfg:Z -v /path/to/output/directory:/updaters:Z --entrypoint /bin/clairctl registry.redhat.io/quay/clair-rhel8:v3.6.2 --config /cfg/config.yaml import-updaters /updaters/updaters.gz</pre></li></ol></div></section><section class="section" id="clair-updater-urls"><div class="titlepage"><div><div><h2 class="title">7.6. Clair updater URLs</h2></div></div></div><p>
				The following are the HTTP hosts and paths that Clair will attempt to talk to in a default configuration. This list is non-exhaustive, as some servers will issue redirects and some request URLs are constructed dynamically.
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						https://secdb.alpinelinux.org/
					</li><li class="listitem">
						http://repo.us-west-2.amazonaws.com/2018.03/updates/x86_64/mirror.list
					</li><li class="listitem">
						https://cdn.amazonlinux.com/2/core/latest/x86_64/mirror.list
					</li><li class="listitem">
						https://www.debian.org/security/oval/
					</li><li class="listitem">
						https://linux.oracle.com/security/oval/
					</li><li class="listitem">
						https://packages.vmware.com/photon/photon_oval_definitions/
					</li><li class="listitem">
						https://github.com/pyupio/safety-db/archive/
					</li><li class="listitem">
						https://catalog.redhat.com/api/containers/
					</li><li class="listitem">
						https://www.redhat.com/security/data/
					</li><li class="listitem">
						https://support.novell.com/security/oval/
					</li><li class="listitem">
						https://people.canonical.com/~ubuntu-security/oval/
					</li></ul></div></section><section class="section" id="clair-add-info"><div class="titlepage"><div><div><h2 class="title">7.7. Additional Information</h2></div></div></div><p>
				For detailed documentation on the internals of Clair, including how the microservices are structured, please see the <a class="link" href="https://quay.github.io/clair">Upstream Clair</a> and <a class="link" href="https://quay.github.io/claircore">ClairCore</a> documentation.
			</p></section></section><section class="chapter" id="container-security-operator-setup"><div class="titlepage"><div><div><h1 class="title">Chapter 8. Scan pod images with the Container Security Operator</h1></div></div></div><p>
			Using the <a class="link" href="https://operatorhub.io/operator/container-security-operator">Container Security Operator</a>, (CSO) you can scan container images associated with active pods, running on OpenShift (4.2 or later) and other Kubernetes platforms, for known vulnerabilities. The CSO:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Watches containers associated with pods on all or specified namespaces
				</li><li class="listitem">
					Queries the container registry where the containers came from for vulnerability information provided an image’s registry supports image scanning (such as a Quay registry with Clair scanning)
				</li><li class="listitem">
					Exposes vulnerabilities via the ImageManifestVuln object in the Kubernetes API
				</li></ul></div><p>
			Using the instructions here, the CSO is installed in the <code class="literal">marketplace-operators</code> namespace, so it is available to all namespaces on your OpenShift cluster.
		</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				To see instructions on installing the CSO on Kubernetes, select the Install button from the <a class="link" href="https://operatorhub.io/operator/container-security-operator">Container Security OperatorHub.io</a> page.
			</p></div></div><section class="section" id="run_the_cso_in_openshift"><div class="titlepage"><div><div><h2 class="title">8.1. Run the CSO in OpenShift</h2></div></div></div><p>
				To start using the CSO in OpenShift, do the following:
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
						Go to Operators → OperatorHub (select Security) to see the available <code class="literal">Container Security</code> Operator.
					</li><li class="listitem">
						Select the <code class="literal">Container Security</code> Operator, then select <code class="literal">Install</code> to go to the Create Operator Subscription page.
					</li><li class="listitem">
						Check the settings (all namespaces and automatic approval strategy, by default), and select <code class="literal">Subscribe</code>. The <code class="literal">Container Security</code> appears after a few moments on the <code class="literal">Installed Operators</code> screen.
					</li><li class="listitem"><p class="simpara">
						Optionally, you can add custom certificates to the CSO. In this example, create a certificate named quay.crt in the current directory. Then run the following command to add the cert to the CSO (restart the Operator pod for the new certs to take effect):
					</p><pre class="screen">$ oc create secret generic container-security-operator-extra-certs --from-file=quay.crt -n openshift-operators</pre></li><li class="listitem"><p class="simpara">
						Open the OpenShift Dashboard (Home → Dashboards). A link to Image Security appears under the status section, with a listing of the number of vulnerabilities found so far. Select the link to see a Security breakdown, as shown in the following figure:
					</p><p class="simpara">
						<span class="inlinemediaobject"><img src="images/cso-dashboard.png" alt="Access SCO scanning data from OpenShift dashboard"/></span>
					</p></li><li class="listitem"><p class="simpara">
						You can do one of two things at this point to follow up on any detected vulnerabilities:
					</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
								Select the link to the vulnerability. You are taken to the container registry, Red Hat Quay or other registry where the container came from, where you can see information about the vulnerability. The following figure shows an example of detected vulnerabilities from a Quay.io registry:
							</p><p class="simpara">
								<span class="inlinemediaobject"><img src="images/cso-registry-vulnerable.png" alt="The CSO points you to a registry containing the vulnerable image"/></span>
							</p></li><li class="listitem"><p class="simpara">
								Select the namespaces link to go to the ImageManifestVuln screen, where you can see the name of the selected image and all namespaces where that image is running. The following figure indicates that a particular vulnerable image is running in two namespaces:
							</p><p class="simpara">
								<span class="inlinemediaobject"><img src="images/cso-namespace-vulnerable.png" alt="View namespaces a vulnerable image is running in"/></span>
							</p></li></ul></div></li></ol></div><p>
				At this point, you know what images are vulnerable, what you need to do to fix those vulnerabilities, and every namespace that the image was run in. So you can:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Alert anyone running the image that they need to correct the vulnerability
					</li><li class="listitem">
						Stop the images from running (by deleting the deployment or other object that started the pod the image is in)
					</li></ul></div><p>
				Note that if you do delete the pod, it may take a few minutes for the vulnerability to reset on the dashboard.
			</p></section><section class="section" id="query_image_vulnerabilities_from_the_cli"><div class="titlepage"><div><div><h2 class="title">8.2. Query image vulnerabilities from the CLI</h2></div></div></div><p>
				You can query information on security from the command line. To query for detected vulnerabilities, type:
			</p><pre class="screen">$ oc get vuln --all-namespaces
NAMESPACE     NAME              AGE
default       sha256.ca90...    6m56s
skynet        sha256.ca90...    9m37s</pre><p>
				To display details for a particular vulnerability, identify one of the vulnerabilities, along with its namespace and the <code class="literal">describe</code> option. This example shows an active container whose image includes an RPM package with a vulnerability:
			</p><pre class="screen">$ oc describe vuln --namespace mynamespace sha256.ac50e3752...
Name:         sha256.ac50e3752...
Namespace:    quay-enterprise
...
Spec:
  Features:
    Name:            nss-util
    Namespace Name:  centos:7
    Version:         3.44.0-3.el7
    Versionformat:   rpm
    Vulnerabilities:
      Description: Network Security Services (NSS) is a set of libraries...</pre></section></section><section class="chapter" id="quay-bridge-operator"><div class="titlepage"><div><div><h1 class="title">Chapter 9. Integrate Red Hat Quay into OpenShift with the Bridge Operator</h1></div></div></div><p>
			Using the Quay Bridge Operator, you can replace the integrated container registry in OpenShift with a Red Hat Quay registry. By doing this, your integrated OpenShift registry becomes a highly available, enterprise-grade Red Hat Quay registry with enhanced role based access control (RBAC) features.
		</p><p>
			The primary goals of the Bridge Operator is to duplicate the features of the integrated OpenShift registry in the new Red Hat Quay registry. The features enabled with this Operator include:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
					Synchronizing OpenShift namespaces as Red Hat Quay organizations.
				</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
							Creating Robot accounts for each default namespace service account
						</li><li class="listitem">
							Creating Secrets for each created Robot Account (associating each Robot Secret to a Service Account as Mountable and Image Pull Secret)
						</li><li class="listitem">
							Synchronizing OpenShift ImageStreams as Quay Repositories
						</li></ul></div></li><li class="listitem">
					Automatically rewriting new Builds making use of ImageStreams to output to Red Hat Quay
				</li><li class="listitem">
					Automatically importing an ImageStream tag once a build completes
				</li></ul></div><p>
			Using this procedure with the Quay Bridge Operator, you enable bi-directional communication between your Red Hat Quay and OpenShift clusters.
		</p><section class="section" id="running_the_quay_bridge_operator"><div class="titlepage"><div><div><h2 class="title">9.1. Running the Quay Bridge Operator</h2></div></div></div><section class="section" id="prerequisites"><div class="titlepage"><div><div><h3 class="title">9.1.1. Prerequisites</h3></div></div></div><p>
					Before setting up the Bridge Operator, have the following in place:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							An existing Red Hat Quay environment for which you have superuser permissions
						</li><li class="listitem">
							A Red Hat OpenShift Container Platform environment (4.2 or later is recommended) for which you have cluster administrator permissions
						</li><li class="listitem">
							An OpenShift command line tool (<code class="literal">oc</code> command)
						</li></ul></div></section><section class="section" id="setting_up_and_configuring_openshift_and_red_hat_quay"><div class="titlepage"><div><div><h3 class="title">9.1.2. Setting up and configuring OpenShift and Red Hat Quay</h3></div></div></div><p>
					Both Red Hat Quay and OpenShift configuration is required:
				</p></section><section class="section" id="red_hat_quay_setup"><div class="titlepage"><div><div><h3 class="title">9.1.3. Red Hat Quay setup</h3></div></div></div><p>
					Create a dedicated Red Hat Quay organization, and from a new application you create within that organization, generate an OAuth token to be used with the Quay Bridge Operator in OpenShift
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
							Log in to Red Hat Quay as a user with superuser access and select the organization for which the external application will be configured.
						</li><li class="listitem">
							In the left navigation, select Applications.
						</li><li class="listitem">
							Select <code class="literal">Create New Application</code> and entering a name for the new application (for example, <code class="literal">openshift</code>).
						</li><li class="listitem">
							With the new application displayed, select it.
						</li><li class="listitem">
							In the left navigation, select <code class="literal">Generate Token</code> to create a new OAuth2 token.
						</li><li class="listitem">
							Select all checkboxes to grant the access needed for the integration.
						</li><li class="listitem">
							Review the assigned permissions and then select <code class="literal">Authorize Application</code>, then confirm it.
						</li><li class="listitem">
							Copy and save the generated Access Token that appears to use in the next section.
						</li></ol></div></section><section class="section" id="openshift_setup"><div class="titlepage"><div><div><h3 class="title">9.1.4. OpenShift Setup</h3></div></div></div><p>
					Setting up OpenShift for the Quay Bridge Operator requires several steps, including:
				</p><section class="section" id="deploying_the_operator"><div class="titlepage"><div><div><h4 class="title">9.1.4.1. Deploying the Operator</h4></div></div></div><p>
						The fastest method for deploying the operator is to deploy from OperatorHub. From the Administrator perspective in the OpenShift Web Console, navigate to the Operators tab, and then select OperatorHub.
					</p><p>
						Search for Quay Bridge Operator and then select Install.
					</p><p>
						Select an Approval Strategy and then select Install which will deploy the operator to the cluster.
					</p></section><section class="section" id="creating_an_openshift_secret_for_the_oauth_token"><div class="titlepage"><div><div><h4 class="title">9.1.4.2. Creating an OpenShift secret for the OAuth token</h4></div></div></div><p>
						The Operator will use the previously obtained Access Token to communicate with Quay. Store this token within OpenShift as a secret.
					</p><p>
						Execute the following command to create a secret called <code class="literal">quay-integration</code> in the <code class="literal">openshift-operators</code> namespace with a key called <code class="literal">token</code> containing the access token:
					</p><pre class="programlisting language-bash">$ oc create secret -n openshift-operators generic quay-integration --from-literal=token=&lt;access_token&gt;</pre></section><section class="section" id="create_the_quayintegration_custom_resource"><div class="titlepage"><div><div><h4 class="title">9.1.4.3. Create the QuayIntegration Custom Resource</h4></div></div></div><p>
						Finally, to complete the integration between OpenShift and Quay, a <code class="literal">QuayIntegration</code> custom resource needs to be created. This can be completed in the Web Console or from the command line.
					</p><div class="formalpara"><p class="title"><strong>quay-integration.yaml</strong></p><p>
							
<pre class="programlisting language-yaml">apiVersion: quay.redhat.com/v1
kind: QuayIntegration
metadata:
  name: example-quayintegration
spec:
  clusterID: openshift  <span id="CO4-1"/><span class="callout">1</span>
  credentialsSecret:
    namespace: openshift-operators
    name: quay-integration<span id="CO4-2"/><span class="callout">2</span>
  quayHostname: https://&lt;QUAY_URL&gt;   <span id="CO4-3"/><span class="callout">3</span>
  insecureRegistry: false <span id="CO4-4"/><span class="callout">4</span></pre>
						</p></div><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO4-1"><span class="callout">1</span></a> </dt><dd><div class="para">
								The clusterID value should be unique across the entire ecosystem. This value is optional and defaults to <code class="literal">openshift</code>.
							</div></dd><dt><a href="#CO4-2"><span class="callout">2</span></a> </dt><dd><div class="para">
								The <code class="literal">credentialsSecret</code> property refers to the namespace and name of the secret containing the token that was previously created.
							</div></dd><dt><a href="#CO4-3"><span class="callout">3</span></a> </dt><dd><div class="para">
								Replace QUAY_URL with the hostname of your Red Hat Quay instance.
							</div></dd><dt><a href="#CO4-4"><span class="callout">4</span></a> </dt><dd><div class="para">
								If Quay is using self signed certificates, set the property <code class="literal">insecureRegistry: true</code>.
							</div></dd></dl></div><p>
						Create the <code class="literal">QuayIntegration</code> Custom Resource:
					</p><pre class="programlisting language-bash">$ oc create -f quay-integration.yaml</pre><p>
						At this point a Quay integration resource is created, linking the OpenShift cluster to the Red Hat Quay instance. Organizations within Quay should be created for the related namespaces from the OpenShift environment
					</p></section></section></section></section><section class="chapter" id="repo-mirroring-in-red-hat-quay"><div class="titlepage"><div><div><h1 class="title">Chapter 10. Repository mirroring</h1></div></div></div><section class="section" id="mirroring-intro"><div class="titlepage"><div><div><h2 class="title">10.1. Repository mirroring</h2></div></div></div><p>
				Red Hat Quay repository mirroring lets you mirror images from external container registries (or another local registry) into your Red Hat Quay cluster. Using repository mirroring, you can synchronize images to Red Hat Quay based on repository names and tags.
			</p><p>
				From your Red Hat Quay cluster with repository mirroring enabled, you can:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Choose a repository from an external registry to mirror
					</li><li class="listitem">
						Add credentials to access the external registry
					</li><li class="listitem">
						Identify specific container image repository names and tags to sync
					</li><li class="listitem">
						Set intervals at which a repository is synced
					</li><li class="listitem">
						Check the current state of synchronization
					</li></ul></div><p>
				To use the mirroring functionality, you need to:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Enable Repository Mirroring in the Red Hat Quay configuration
					</li><li class="listitem">
						Run a repository mirroring worker
					</li><li class="listitem">
						Create mirrored repositories
					</li></ul></div><p>
				All repository mirroring configuration can be performed using the configuration tool UI or via the Quay API
			</p></section><section class="section" id="mirroring-versus-georepl"><div class="titlepage"><div><div><h2 class="title">10.2. Repository mirroring versus geo-replication</h2></div></div></div><p>
				Quay geo-replication mirrors the entire image storage backend data between 2 or more different storage backends while the database is shared (one Quay registry with two different blob storage endpoints). The primary use cases for geo-replication are:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Speeding up access to the binary blobs for geographically dispersed setups
					</li><li class="listitem">
						Guaranteeing that the image content is the same across regions
					</li></ul></div><p>
				Repository mirroring synchronizes selected repositories (or subsets of repositories) from one registry to another. The registries are distinct, with registry is separate database and image storage. The primary use cases for mirroring are:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Independent registry deployments in different datacenters or regions, where a certain subset of the overall content is supposed to be shared across the datacenters / regions
					</li><li class="listitem">
						Automatic synchronization or mirroring of selected (whitelisted) upstream repositories from external registries into a local Quay deployment
					</li></ul></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					Repository mirroring and geo-replication can be used simultaneously.
				</p></div></div><div class="table" id="idm45792902867632"><p class="title"><strong>Table 10.1. Red Hat Quay Repository mirroring versus geo-replication</strong></p><div class="table-contents"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 33%; " class="col_1"/><col style="width: 33%; " class="col_2"/><col style="width: 33%; " class="col_3"/></colgroup><thead><tr><th align="left" valign="top" id="idm45792902861200" scope="col">Feature / Capability</th><th align="left" valign="top" id="idm45792902860112" scope="col">Geo-replication</th><th align="left" valign="top" id="idm45792902859024" scope="col">Repository mirroring</th></tr></thead><tbody><tr><td align="left" valign="top" headers="idm45792902861200">
							<p>
								What is the feature designed to do?
							</p>
							</td><td align="left" valign="top" headers="idm45792902860112">
							<p>
								A shared, global registry
							</p>
							</td><td align="left" valign="top" headers="idm45792902859024">
							<p>
								Distinct, different registries
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792902861200">
							<p>
								What happens if replication or mirroring hasn’t been completed yet?
							</p>
							</td><td align="left" valign="top" headers="idm45792902860112">
							<p>
								The remote copy is used (slower)
							</p>
							</td><td align="left" valign="top" headers="idm45792902859024">
							<p>
								No image is served
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792902861200">
							<p>
								Is access to all storage backends in both regions required?
							</p>
							</td><td align="left" valign="top" headers="idm45792902860112">
							<p>
								Yes (all Red Hat Quay nodes)
							</p>
							</td><td align="left" valign="top" headers="idm45792902859024">
							<p>
								No (distinct storage)
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792902861200">
							<p>
								Can users push images from both sites to the same repository?
							</p>
							</td><td align="left" valign="top" headers="idm45792902860112">
							<p>
								Yes
							</p>
							</td><td align="left" valign="top" headers="idm45792902859024">
							<p>
								No
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792902861200">
							<p>
								Is all registry content and configuration identical across all regions (shared database)
							</p>
							</td><td align="left" valign="top" headers="idm45792902860112">
							<p>
								Yes
							</p>
							</td><td align="left" valign="top" headers="idm45792902859024">
							<p>
								No
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792902861200">
							<p>
								Can users select individual namespaces or repositories to be mirrored?
							</p>
							</td><td align="left" valign="top" headers="idm45792902860112">
							<p>
								No,by default
							</p>
							</td><td align="left" valign="top" headers="idm45792902859024">
							<p>
								Yes
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792902861200">
							<p>
								Can users apply filters to synchronization rules?
							</p>
							</td><td align="left" valign="top" headers="idm45792902860112">
							<p>
								No
							</p>
							</td><td align="left" valign="top" headers="idm45792902859024">
							<p>
								Yes
							</p>
							</td></tr></tbody></table></div></div></section><section class="section" id="mirroring-using"><div class="titlepage"><div><div><h2 class="title">10.3. Using repository mirroring</h2></div></div></div><p>
				Here are some features and limitations of Red Hat Quay repository mirroring:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						With repository mirroring, you can mirror an entire repository or selectively limit which images are synced. Filters can be based on a comma-separated list of tags, a range of tags, or other means of identifying tags through regular expressions.
					</li><li class="listitem">
						Once a repository is set as mirrored, you cannot manually add other images to that repository.
					</li><li class="listitem">
						Because the mirrored repository is based on the repository and tags you set, it will hold only the content represented by the repo/tag pair. In other words, if you change the tag so that some images in the repository no longer match, those images will be deleted.
					</li><li class="listitem">
						Only the designated robot can push images to a mirrored repository, superseding any role-based access control permissions set on the repository.
					</li><li class="listitem">
						With a mirrored repository, a user can pull images (given read permission) from the repository but not push images to the repository.
					</li><li class="listitem">
						Changing settings on your mirrored repository is done from the Mirrors tab on the Repositories page for the mirrored repository you create.
					</li><li class="listitem">
						Images are synced at set intervals, but can also be synced on demand.
					</li></ul></div></section><section class="section" id="mirroring_configuration_ui"><div class="titlepage"><div><div><h2 class="title">10.4. Mirroring configuration UI</h2></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						Start the <code class="literal">Quay</code> container in configuration mode and select the Enable Repository Mirroring check box. If you want to require HTTPS communications and verify certificates during mirroring, select the HTTPS and cert verification check box.
					</p><p class="simpara">
						<span class="inlinemediaobject"><img src="images/repo_mirror_config.png" alt="Enable mirroring and require HTTPS and verified certificates"/></span>
					</p></li><li class="listitem">
						Validate and download the <code class="literal">configuration</code> file, and then restart Quay in registry mode using the updated config file.
					</li></ol></div></section><section class="section" id="config-fields-mirroring"><div class="titlepage"><div><div><h2 class="title">10.5. Mirroring configuration fields</h2></div></div></div><div class="table" id="idm45792901631728"><p class="title"><strong>Table 10.2. Mirroring configuration</strong></p><div class="table-contents"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 50%; " class="col_1"/><col style="width: 17%; " class="col_2"/><col style="width: 33%; " class="col_3"/></colgroup><thead><tr><th align="left" valign="top" id="idm45792899933104" scope="col">Field</th><th align="left" valign="top" id="idm45792899932016" scope="col">Type</th><th align="left" valign="top" id="idm45792899930928" scope="col">Description</th></tr></thead><tbody><tr><td align="left" valign="top" headers="idm45792899933104">
							<p>
								<span class="strong strong"><strong>FEATURE_REPO_MIRROR</strong></span>
							</p>
							</td><td align="left" valign="top" headers="idm45792899932016">
							<p>
								Boolean
							</p>
							</td><td align="left" valign="top" headers="idm45792899930928">
							<p>
								Enable or disable repository mirroring<br/><br/> <span class="strong strong"><strong>Default:</strong></span> <code class="literal">false</code>
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792899933104">
							<p>
								 
							</p>
							</td><td align="left" valign="top" headers="idm45792899932016">
							<p>
								 
							</p>
							</td><td align="left" valign="top" headers="idm45792899930928">
							<p>
								 
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792899933104">
							<p>
								<span class="strong strong"><strong>REPO_MIRROR_INTERVAL</strong></span>
							</p>
							</td><td align="left" valign="top" headers="idm45792899932016">
							<p>
								Number
							</p>
							</td><td align="left" valign="top" headers="idm45792899930928">
							<p>
								The number of seconds between checking for repository mirror candidates<br/><br/><span class="strong strong"><strong>Default:</strong></span> 30
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792899933104">
							<p>
								<span class="strong strong"><strong>REPO_MIRROR_SERVER_HOSTNAME</strong></span>
							</p>
							</td><td align="left" valign="top" headers="idm45792899932016">
							<p>
								String
							</p>
							</td><td align="left" valign="top" headers="idm45792899930928">
							<p>
								Replaces the <code class="literal">SERVER_HOSTNAME</code> as the destination for mirroring. <br/><br/><span class="strong strong"><strong>Default:</strong></span> None<br/><br/><span class="strong strong"><strong>Example</strong></span>:<br/><code class="literal">openshift-quay-service</code>
							</p>
							</td></tr><tr><td align="left" valign="top" headers="idm45792899933104">
							<p>
								<span class="strong strong"><strong>REPO_MIRROR_TLS_VERIFY</strong></span>
							</p>
							</td><td align="left" valign="top" headers="idm45792899932016">
							<p>
								Boolean
							</p>
							</td><td align="left" valign="top" headers="idm45792899930928">
							<p>
								Require HTTPS and verify certificates of Quay registry during mirror.<br/><br/> <span class="strong strong"><strong>Default:</strong></span> <code class="literal">false</code>
							</p>
							</td></tr></tbody></table></div></div></section><section class="section" id="mirroring-worker"><div class="titlepage"><div><div><h2 class="title">10.6. Mirroring worker</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
						To run the repository mirroring worker, start by running a <code class="literal">Quay</code> pod with the <code class="literal">repomirror</code> option:
					</p><pre class="screen">$ sudo podman run -d --name mirroring-worker \
  -v $QUAY/config:/conf/stack:Z \
  registry.redhat.io/quay/quay-rhel8:v3.6.2 repomirror</pre></li><li class="listitem"><p class="simpara">
						If you have configured TLS communications using a certificate <code class="literal">/root/ca.crt</code>, then the following example shows how to start the mirroring worker:
					</p><pre class="screen">$ sudo podman run -d --name mirroring-worker \
  -v $QUAY/config:/conf/stack:Z \
  -v /root/ca.crt:/etc/pki/ca-trust/source/anchors/ca.crt \
  registry.redhat.io/quay/quay-rhel8:v3.6.2 repomirror</pre></li></ul></div></section><section class="section" id="mirroring-creating-repo"><div class="titlepage"><div><div><h2 class="title">10.7. Creating a mirrored repository</h2></div></div></div><p>
				The steps shown in this section assume you already have enabled repository mirroring in the configuration for your Red Hat Quay cluster and that you have a deployed a mirroring worker.
			</p><p>
				When mirroring a repository from an external container registry, create a new private repository. Typically the same name is used as the target repository, for example, <code class="literal">quay-rhel8</code>:
			</p><p>
				<span class="inlinemediaobject"><img src="images/repo_quay_rhel8.png" alt="Create new Red Hat Quay repo"/></span>
			</p><section class="section" id="repository_mirroring_settings"><div class="titlepage"><div><div><h3 class="title">10.7.1. Repository mirroring settings</h3></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							In the Settings tab, set the Repository State to <code class="literal">Mirror</code>:
						</p><p class="simpara">
							<span class="inlinemediaobject"><img src="images/repo_mirror_create.png" alt="Create a new Red Hat Quay repo mirror"/></span>
						</p></li><li class="listitem"><p class="simpara">
							In the Mirror tab, enter the details for connecting to the external registry, along with the tags, scheduling and access information:
						</p><p class="simpara">
							<span class="inlinemediaobject"><img src="images/repo-mirror-details-start.png" alt="Repository mirroring"/></span>
						</p></li><li class="listitem"><p class="simpara">
							Enter the details as required in the following fields:
						</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
									<span class="strong strong"><strong>Registry Location:</strong></span> The external repository you want to mirror, for example, <code class="literal">registry.redhat.io/quay/quay-rhel8</code>
								</li><li class="listitem"><p class="simpara">
									<span class="strong strong"><strong>Tags:</strong></span> This field is required. You may enter a comma-separated list of individual tags or tag patterns. (See <span class="emphasis"><em>Tag Patterns</em></span> section for details.)
								</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
										In order for Quay to get the list of tags in the remote repository, one of the following requirements must be met:
									</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
												An image with the "latest" tag must exist in the remote repository <span class="emphasis"><em>OR</em></span>
											</li><li class="listitem">
												At least one explicit tag, without pattern matching, must exist in the list of tags that you specify
											</li></ul></div></div></div></li><li class="listitem">
									<span class="strong strong"><strong>Start Date:</strong></span> The date on which mirroring begins. The current date and time is used by default.
								</li><li class="listitem">
									<span class="strong strong"><strong>Sync Interval:</strong></span> Defaults to syncing every 24 hours. You can change that based on hours or days.
								</li><li class="listitem">
									<span class="strong strong"><strong>Robot User:</strong></span> Create a new robot account or choose an existing robot account to do the mirroring.
								</li><li class="listitem">
									<span class="strong strong"><strong>Username:</strong></span> The username for accessing the external registry holding the repository you are mirroring.
								</li><li class="listitem">
									<span class="strong strong"><strong>Password:</strong></span> The password associated with the Username. Note that the password cannot include characters that require an escape character (\).
								</li></ul></div></li></ol></div></section><section class="section" id="advanced_settings"><div class="titlepage"><div><div><h3 class="title">10.7.2. Advanced settings</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							In the Advanced Settings section, configure TLS and proxy, if required:
						</li><li class="listitem">
							<span class="strong strong"><strong>Verify TLS:</strong></span> Check this box if you want to require HTTPS and to verify certificates, when communicating with the target remote registry.
						</li><li class="listitem">
							<span class="strong strong"><strong>HTTP Proxy:</strong></span> Identify the HTTP proxy server needed to access the remote site, if one is required.
						</li><li class="listitem">
							<span class="strong strong"><strong>HTTPS Proxy:</strong></span> Identify the HTTPS proxy server needed to access the remote site, if one is required.
						</li><li class="listitem">
							<span class="strong strong"><strong>No Proxy:</strong></span> List of locations that do not require proxy
						</li></ul></div></section><section class="section" id="synchronize_now"><div class="titlepage"><div><div><h3 class="title">10.7.3. Synchronize now</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
							To perform an immediate mirroring operation, press the Sync Now button on the repository’s Mirroring tab. The logs are available on the Usage Logs tab:
						</p><p class="simpara">
							<span class="inlinemediaobject"><img src="images/repo-mirror-usage-logs.png" alt="Usage logs"/></span>
						</p><p class="simpara">
							When the mirroring is complete, the images will appear in the Tags tab:
						</p><p class="simpara">
							<span class="inlinemediaobject"><img src="images/repo-mirror-tags.png" alt="Repository mirroring tags"/></span>
						</p><p class="simpara">
							Below is an example of a completed Repository Mirroring screen:
						</p><p class="simpara">
							<span class="inlinemediaobject"><img src="images/repo-mirror-details.png" alt="Repository mirroring details"/></span>
						</p></li></ul></div></section></section><section class="section" id="mirroring-events"><div class="titlepage"><div><div><h2 class="title">10.8. Event notifications for mirroring</h2></div></div></div><p>
				There are three notification events for repository mirroring:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Repository Mirror Started
					</li><li class="listitem">
						Repository Mirror Success
					</li><li class="listitem">
						Repository Mirror Unsuccessful
					</li></ul></div><p>
				The events can be configured inside the Settings tab for each repository, and all existing notification methods such as email, slack, Quay UI and webhooks are supported.
			</p></section><section class="section" id="mirroring-tag-patterns"><div class="titlepage"><div><div><h2 class="title">10.9. Mirroring tag patterns</h2></div></div></div><p>
				As noted above, at least one Tag must be explicitly entered (ie. not a tag pattern) <span class="emphasis"><em>or</em></span> the tag "latest" must exist in the report repository. (The tag "latest" will not be synced unless specified in the tag list.). This is required for Quay to get the list of tags in the remote repository to compare to the specified list to mirror.
			</p><section class="section" id="pattern_syntax"><div class="titlepage"><div><div><h3 class="title">10.9.1. Pattern syntax</h3></div></div></div><div class="informaltable"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 50%; " class="col_1"/><col style="width: 50%; " class="col_2"/></colgroup><tbody><tr><td align="left" valign="top">
								<p>
									Pattern
								</p>
								</td><td align="left" valign="top">
								<p>
									Description
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									*
								</p>
								</td><td align="left" valign="top">
								<p>
									Matches all characters
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									?
								</p>
								</td><td align="left" valign="top">
								<p>
									Matches any single character
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									[seq]
								</p>
								</td><td align="left" valign="top">
								<p>
									Matches any character in <span class="emphasis"><em>seq</em></span>
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									[!seq]
								</p>
								</td><td align="left" valign="top">
								<p>
									Matches any character not in <span class="emphasis"><em>seq</em></span>
								</p>
								</td></tr></tbody></table></div></section><section class="section" id="example_tag_patterns"><div class="titlepage"><div><div><h3 class="title">10.9.2. Example tag patterns</h3></div></div></div><div class="informaltable"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 50%; " class="col_1"/><col style="width: 50%; " class="col_2"/></colgroup><tbody><tr><td align="left" valign="top">
								<p>
									Example Pattern
								</p>
								</td><td align="left" valign="top">
								<p>
									Example Matches
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									v3*
								</p>
								</td><td align="left" valign="top">
								<p>
									v32, v3.1, v3.2, v3.2-4beta, v3.3
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									v3.*
								</p>
								</td><td align="left" valign="top">
								<p>
									v3.1, v3.2, v3.2-4beta
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									v3.?
								</p>
								</td><td align="left" valign="top">
								<p>
									v3.1, v3.2, v3.3
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									v3.[12]
								</p>
								</td><td align="left" valign="top">
								<p>
									v3.1, v3.2
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									v3.[12]*
								</p>
								</td><td align="left" valign="top">
								<p>
									v3.1, v3.2, v3.2-4beta
								</p>
								</td></tr><tr><td align="left" valign="top">
								<p>
									v3.[!1]*
								</p>
								</td><td align="left" valign="top">
								<p>
									v3.2, v3.2-4beta, v3.3
								</p>
								</td></tr></tbody></table></div></section></section><section class="section" id="mirroring-working-with"><div class="titlepage"><div><div><h2 class="title">10.10. Working with mirrored repositories</h2></div></div></div><p>
				Once you have created a mirrored repository, there are several ways you can work with that repository. Select your mirrored repository from the Repositories page and do any of the following:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						<span class="strong strong"><strong>Enable/disable the repository</strong></span>: Select the Mirroring button in the left column, then toggle the Enabled check box to enable or disable the repository temporarily.
					</li><li class="listitem"><p class="simpara">
						<span class="strong strong"><strong>Check mirror logs</strong></span>: To make sure the mirrored repository is working properly, you can check the mirror logs. To do that, select the Usage Logs button in the left column. Here’s an example:
					</p><p class="simpara">
						<span class="inlinemediaobject"><img src="images/repo_mirror_logs.png" alt="View logs for your Red Hat Quay repo mirror"/></span>
					</p></li><li class="listitem">
						<span class="strong strong"><strong>Sync mirror now</strong></span>: To immediately sync the images in your repository, select the Sync Now button.
					</li><li class="listitem">
						<span class="strong strong"><strong>Change credentials</strong></span>: To change the username and password, select DELETE from the Credentials line. Then select None and add the username and password needed to log into the external registry when prompted.
					</li><li class="listitem">
						<span class="strong strong"><strong>Cancel mirroring</strong></span>: To stop mirroring, which keeps the current images available but stops new ones from being synced, select the CANCEL button.
					</li><li class="listitem"><p class="simpara">
						<span class="strong strong"><strong>Set robot permissions</strong></span>: Red Hat Quay robot accounts are named tokens that hold credentials for accessing external repositories. By assigning credentials to a robot, that robot can be used across multiple mirrored repositories that need to access the same external registry.
					</p><p class="simpara">
						You can assign an existing robot to a repository by going to Account Settings, then selecting the Robot Accounts icon in the left column. For the robot account, choose the link under the REPOSITORIES column. From the pop-up window, you can:
					</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
								Check which repositories are assigned to that robot.
							</li><li class="listitem">
								Assign read, write or Admin privileges to that robot from the PERMISSION field shown in this figure: 
								<span class="inlinemediaobject"><img src="images/repo_mirror_robot_assign.png" alt="Assign a robot to mirrored repo"/></span>
							</li></ul></div></li><li class="listitem"><p class="simpara">
						<span class="strong strong"><strong>Change robot credentials</strong></span>: Robots can hold credentials such as Kubernetes secrets, Docker login information, and Mesos bundles. To change robot credentials, select the Options gear on the robot’s account line on the Robot Accounts window and choose View Credentials. Add the appropriate credentials for the external repository the robot needs to access.
					</p><p class="simpara">
						<span class="inlinemediaobject"><img src="images/repo_mirror_robot_perm.png" alt="Assign permission to a robot"/></span>
					</p></li><li class="listitem">
						<span class="strong strong"><strong>Check and change general setting</strong></span>: Select the Settings button (gear icon) from the left column on the mirrored repository page. On the resulting page, you can change settings associated with the mirrored repository. In particular, you can change User and Robot Permissions, to specify exactly which users and robots can read from or write to the repo.
					</li></ul></div></section><section class="section" id="mirroring-recommend"><div class="titlepage"><div><div><h2 class="title">10.11. Repository mirroring recommendations</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Repository mirroring pods can run on any node including other nodes where Quay is already running
					</li><li class="listitem">
						Repository mirroring is scheduled in the database and run in batches. As a result, more workers could mean faster mirroring, since more batches will be processed.
					</li><li class="listitem"><p class="simpara">
						The optimal number of mirroring pods depends on:
					</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
								The total number of repositories to be mirrored
							</li><li class="listitem">
								The number of images and tags in the repositories and the frequency of changes
							</li><li class="listitem">
								Parallel batches
							</li></ul></div></li><li class="listitem">
						You should balance your mirroring schedule across all mirrored repositories, so that they do not all start up at the same time.
					</li><li class="listitem">
						For a mid-size deployment, with approximately 1000 users and 1000 repositories, and with roughly 100 mirrored repositories, it is expected that you would use 3-5 mirroring pods, scaling up to 10 if required.
					</li></ul></div></section></section><section class="chapter" id="back-up-and-restore-red-hat-quay"><div class="titlepage"><div><div><h1 class="title">Chapter 11. Back up and recover Red Hat Quay</h1></div></div></div><p>
			Use the content within this section to back up and restore Red Hat Quay on an OpenShift Container Platform deployment, or on a virtual machine.
		</p><section class="section" id="back_up_red_hat_quay_procedure"><div class="titlepage"><div><div><h2 class="title">11.1. Back up Red Hat Quay procedure</h2></div></div></div><p>
				This procedure is exclusively for OpenShift Container Platform and NooBaa deployments.
			</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
						A Red Hat Quay deployment on OpenShift Container Platform.
					</li></ul></div><div class="admonition note"><div class="admonition_header">Procedure</div><div><p>
					The procedure in this documents uses the following namespace: <code class="literal">quay-enterprise</code>.
				</p></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						Obtain a list of your deployed pods in your Quay namespace:
					</p><pre class="screen">$ oc get pods -n quay-enterprise</pre><p class="simpara">
						Example output:
					</p><pre class="screen">NAME                                                   READY   STATUS      RESTARTS   AGE
example-registry-clair-app-7dccddc6fd-fwckp            1/1     Running     0          69m
example-registry-clair-postgres-558d7cc9c-xgk2m        1/1     Running     0          68m
example-registry-quay-app-5677cb59b7-fpxcg             1/1     Running     0          69m
example-registry-quay-app-upgrade-zstr4                0/1     Completed   0          69m
example-registry-quay-config-editor-67c769f669-dp5gf   1/1     Running     0          69m
example-registry-quay-database-6d58c4c545-99s2g        1/1     Running     0          69m
example-registry-quay-mirror-d4bc9c99c-rmk4f           1/1     Running     0          68m
example-registry-quay-postgres-init-rwbsq              0/1     Completed   0          69m
example-registry-quay-redis-577776d494-k48zv           1/1     Running     0          69m
quay-operator.{productminv}-798d5c8b69-q6x88                  1/1     Running     0          79m</pre></li><li class="listitem"><p class="simpara">
						Scale down the Quay Operator deployment:
					</p><pre class="screen">$ oc scale deployment quay-operator.v3.6.2 --replicas=0 -n quay-enterprise</pre></li><li class="listitem"><p class="simpara">
						Scale down the Quay App deployment:
					</p><pre class="screen">$ oc scale deployment example-registry-quay-app --replicas=0 -n quay-enterprise</pre></li><li class="listitem"><p class="simpara">
						Scale down the Quay Mirror deployment:
					</p><pre class="screen">$ oc scale deployment example-registry-quay-mirror --replicas=0 -n quay-enterprise</pre></li><li class="listitem"><p class="simpara">
						You can ensure that the Quay Operator, Quay App, and Quay Mirror deployments have successfully scaled down by running the following command:
					</p><pre class="screen">$ oc get deployment -n quay-enterprise</pre><p class="simpara">
						Example output:
					</p><pre class="screen">NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE
example-registry-clair-app            1/1     1            1           56m
example-registry-clair-postgres       1/1     1            1           56m
example-registry-quay-app             0/0     0            0           56m
example-registry-quay-config-editor   1/1     1            1           56m
example-registry-quay-database        1/1     1            1           56m
example-registry-quay-mirror          0/0     0            0           56m
example-registry-quay-redis           1/1     1            1           56m
quay-operator.v3.5.7                  0/0     0            0           57m</pre></li><li class="listitem"><p class="simpara">
						Display your Quay registry object in JSON format:
					</p><pre class="screen">$ oc get quayregistries.quay.redhat.com -o json -n quay-enterprise</pre><p class="simpara">
						Example output:
					</p><pre class="programlisting language-yaml">  {
      "apiVersion": "v1",
      "items": [
          {
              "apiVersion": "quay.redhat.com/v1",
              "kind": "QuayRegistry",
              "metadata": {
                  "creationTimestamp": "2021-11-24T17:41:59Z",
                  "finalizers": [
                      "quay-operator/finalizer"
                  ],
                  "generation": 4,
                  "managedFields": [
  ...
                  ],
                  "name": "example-registry",
                  "namespace": "quay-enterprise",
                  "resourceVersion": "94514",
                  "selfLink": "/apis/quay.redhat.com/v1/namespaces/quay-enterprise/quayregistries/example-registry",
                  "uid": "03ee01da-615a-41e5-8840-e09d1fad0824"
              },
              "spec": {
                  "components": [
                      {
                          "kind": "postgres",
                          "managed": true
                      },
                      {
                          "kind": "objectstorage",
                          "managed": true
                      },
                      {
                          "kind": "redis",
                          "managed": true
                      },
                      {
                          "kind": "horizontalpodautoscaler",
                          "managed": true
                      },
                      {
                          "kind": "route",
                          "managed": true
                      },
                      {
                          "kind": "mirror",
                          "managed": true
                      },
                      {
                          "kind": "monitoring",
                          "managed": true
                      },
                      {
                          "kind": "tls",
                          "managed": true
                      },
                      {
                          "kind": "clair",
                          "managed": true
                      }
                  ],
                  "configBundleSecret": "example-registry-quay-config-bundle-z4gx8"
              }</pre></li><li class="listitem"><p class="simpara">
						Obtain the <code class="literal">configBundleSecret</code>:
					</p><pre class="screen">$ oc get quayregistries.quay.redhat.com -o jsonpath="{.items[0].spec.configBundleSecret}{'\n'}"  -n quay-enterprise</pre><p class="simpara">
						Example output:
					</p><pre class="screen">example-registry-quay-config-bundle-z4gx8</pre></li><li class="listitem"><p class="simpara">
						Set your Quay config bundle secret:
					</p><pre class="screen">$ QUAY_CURR_CONFIG_BUNDLE=$( oc get quayregistries.quay.redhat.com -n quay-enterprise -o jsonpath="{.items[0].spec.configBundleSecret}{'\n'}" )</pre></li><li class="listitem"><p class="simpara">
						Assign your backup directory:
					</p><pre class="screen">$ QUAY_BACKUP_DIR="/var/tmp/quay-backup"</pre></li><li class="listitem"><p class="simpara">
						Create a parent directory where you can store your config.yaml:
					</p><pre class="screen">$ mkdir -pv "$QUAY_BACKUP_DIR/config"</pre></li><li class="listitem"><p class="simpara">
						Set the name of your registry namespace to match the name of your Red Hat Quay on OpenShift namespace:
					</p><pre class="screen">QUAY_NAMESPACE=quay-enterprise</pre></li><li class="listitem"><p class="simpara">
						Extract the config bundle secret to your backup directory:
					</p><pre class="screen">$ oc extract secret/"$QUAY_CURR_CONFIG_BUNDLE" -n "$QUAY_NAMESPACE" --to="${QUAY_BACKUP_DIR}/config/"</pre><p class="simpara">
						Example output:
					</p><pre class="screen">/var/tmp/quay-backup/config/config.yaml
/var/tmp/quay-backup/config/extra_ca_cert_service-ca.crt
/var/tmp/quay-backup/config/ocp-cluster-wildcard.cert</pre></li><li class="listitem"><p class="simpara">
						Obtain the full secret of your Quay deployment, including database, storage, Redis, etc.:
					</p><pre class="screen">$ oc get deployment -n quay-enterprise example-registry-quay-app -o json | jq</pre><p class="simpara">
						Example output:
					</p><pre class="screen">{
  "apiVersion": "apps/v1",
  "kind": "Deployment",
  "metadata": {
    "annotations": {
      "deployment.kubernetes.io/revision": "4",
      "quay-buildmanager-hostname": "",
      "quay-managed-fieldgroups": "Database,DistributedStorage,Redis,RepoMirror,SecurityScanner",
      "quay-operator-service-endpoint": "http://quay-operator.quay-enterprise:7071",
      "quay-registry-hostname": "example-registry-quay-quay-enterprise.apps.ci-ln-0956t32-76ef8.origin-ci-int-aws.dev.rhcloud.com"
    },
    "creationTimestamp": "2021-12-14T16:51:25Z",
    "generation": 5,
    "labels": {
      "app": "quay",
      "quay-component": "quay-app",
      "quay-operator/quayregistry": "example-registry"
    },
    "name": "example-registry-quay-app",
    "namespace": "quay-enterprise",
    "ownerReferences": [
      {
        "apiVersion": "quay.redhat.com/v1",
        "kind": "QuayRegistry",
        "name": "example-registry",
        "uid": "86f40e7b-7cda-48f8-b944-9417c1c686d8"
      }
    ],
    "resourceVersion": "54179",
    "selfLink": "/apis/apps/v1/namespaces/quay-enterprise/deployments/example-registry-quay-app",
    "uid": "114659e3-7034-496c-8479-7629035e16ce"
  },
  "spec": {
    "progressDeadlineSeconds": 600,
    "replicas": 0,
    "revisionHistoryLimit": 10,
    "selector": {
      "matchLabels": {
        "app": "quay",
        "quay-component": "quay-app",
        "quay-operator/quayregistry": "example-registry"
      }
    },
    "strategy": {
      "rollingUpdate": {
        "maxSurge": "25%",
        "maxUnavailable": "25%"
      },
      "type": "RollingUpdate"
    },
    "template": {
      "metadata": {
        "annotations": {
          "quay-buildmanager-hostname": "",
          "quay-managed-fieldgroups": "Database,DistributedStorage,Redis,RepoMirror,SecurityScanner",
          "quay-operator-service-endpoint": "http://quay-operator.quay-enterprise:7071",
          "quay-registry-hostname": "example-registry-quay-quay-enterprise.apps.ci-ln-0956t32-76ef8.origin-ci-int-aws.dev.rhcloud.com"
        },
        "creationTimestamp": null,
        "labels": {
          "app": "quay",
          "quay-component": "quay-app",
          "quay-operator/quayregistry": "example-registry"
        }
      },
      "spec": {
        "containers": [
          {
            "args": [
              "registry-nomigrate"
            ],
            "env": [
              {
                "name": "QE_K8S_CONFIG_SECRET",
                "value": "example-registry-quay-config-secret-b55666bckb"
              },
              {
                "name": "QE_K8S_NAMESPACE",
                "valueFrom": {
                  "fieldRef": {
                    "apiVersion": "v1",
                    "fieldPath": "metadata.namespace"
                  }
                }
              },
              {
                "name": "DEBUGLOG",
                "value": "false"
              },
              {
                "name": "WORKER_COUNT_WEB",
                "value": "4"
              },
              {
                "name": "WORKER_COUNT_SECSCAN",
                "value": "2"
              },
              {
                "name": "WORKER_COUNT_REGISTRY",
                "value": "8"
              }
            ],
            "image": "registry.redhat.io/quay/quay-rhel8@sha256:c599892160ac20c744d833603d9375923af7aec1edfd86982b7513e02fb6d463",
            "imagePullPolicy": "IfNotPresent",
            "name": "quay-app",
            "ports": [
              {
                "containerPort": 8443,
                "protocol": "TCP"
              },
              {
                "containerPort": 8080,
                "protocol": "TCP"
              },
              {
                "containerPort": 8081,
                "protocol": "TCP"
              },
              {
                "containerPort": 9091,
                "protocol": "TCP"
              }
            ],
            "readinessProbe": {
              "exec": {
                "command": [
                  "curl",
                  "-k",
                  "https://localhost:8443/health/instance"
                ]
              },
              "failureThreshold": 3,
              "initialDelaySeconds": 30,
              "periodSeconds": 15,
              "successThreshold": 1,
              "timeoutSeconds": 20
            },
            "resources": {
              "limits": {
                "cpu": "2",
                "memory": "8Gi"
              },
              "requests": {
                "cpu": "2",
                "memory": "8Gi"
              }
            },
            "terminationMessagePath": "/dev/termination-log",
            "terminationMessagePolicy": "File",
            "volumeMounts": [
              {
                "mountPath": "/conf/stack",
                "name": "configvolume"
              },
              {
                "mountPath": "/conf/stack/extra_ca_certs",
                "name": "extra-ca-certs",
                "readOnly": true
              }
            ]
          }
        ],
        "dnsPolicy": "ClusterFirst",
        "restartPolicy": "Always",
        "schedulerName": "default-scheduler",
        "securityContext": {},
        "terminationGracePeriodSeconds": 30,
        "volumes": [
          {
            "name": "configvolume",
            "secret": {
              "defaultMode": 420,
              "secretName": "example-registry-quay-config-secret-b55666bckb"
            }
          },
          {
            "configMap": {
              "defaultMode": 420,
              "name": "example-registry-cluster-service-ca"
            },
            "name": "extra-ca-certs"
          }
        ]
      }
    }
  },
  "status": {
    "conditions": [
      {
        "lastTransitionTime": "2021-12-14T16:54:23Z",
        "lastUpdateTime": "2021-12-14T16:54:23Z",
        "message": "Deployment has minimum availability.",
        "reason": "MinimumReplicasAvailable",
        "status": "True",
        "type": "Available"
      },
      {
        "lastTransitionTime": "2021-12-14T16:51:25Z",
        "lastUpdateTime": "2021-12-14T17:00:39Z",
        "message": "ReplicaSet \"example-registry-quay-app-7fc65dcbc5\" has successfully progressed.",
        "reason": "NewReplicaSetAvailable",
        "status": "True",
        "type": "Progressing"
      }
    ],
    "observedGeneration": 5
  }
}</pre></li><li class="listitem"><p class="simpara">
						Extract your Quay registry secrets to your backup Quay directory:
					</p><pre class="screen">$  oc extract secret/example-registry-quay-config-secret-b55666bckb -n quay-enterprise --keys=config.yaml --to=- &gt; "${QUAY_BACKUP_DIR}/quay-config-secret.yaml"</pre></li><li class="listitem"><p class="simpara">
						Ensure that your secrets are stored in the backup directory by running the following command:
					</p><pre class="screen">$ cat $QUAY_BACKUP_DIR/quay-config-secret.yaml</pre><p class="simpara">
						Example output:
					</p><pre class="programlisting language-yaml">ALLOW_PULLS_WITHOUT_STRICT_LOGGING: false
AUTHENTICATION_TYPE: Database
AVATAR_KIND: local
BUILDLOGS_REDIS:
  host: example-registry-quay-redis
  port: 6379
DATABASE_SECRET_KEY: l0YkKJNXw494VeL6qxwJrN6HoecFDiylAR8-zgjbK1LvUInVatGYZINWSgAMX5vkIJLYCQGh7OckBuf0
DB_CONNECTION_ARGS:
  autorollback: true
  threadlocals: true
DB_URI: postgresql://example-registry-quay-database:OyC4zGhJMbi3yUzW1aIgOLQNW18r14nAcuJfbsjtrAXUVInj2JgwLskQPOutPCXMtlKr1UPTsIPqOEjV@example-registry-quay-database:5432/example-registry-quay-database
DEFAULT_TAG_EXPIRATION: 2w
DISTRIBUTED_STORAGE_CONFIG:
  local_us:
  - RHOCSStorage
  - access_key: VvoFhVFp8BqcOgQ9LczE
    bucket_name: quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf
    hostname: s3.openshift-storage.svc.cluster.local
    is_secure: true
    port: 443
    secret_key: XyThQKm6lMWh4O7dKdmRwMUHB9ktxPPVSRIePOY2
    storage_path: /datastorage/registry
DISTRIBUTED_STORAGE_DEFAULT_LOCATIONS:
- local_us
DISTRIBUTED_STORAGE_PREFERENCE:
- local_us
ENTERPRISE_LOGO_URL: /static/img/quay-horizontal-color.svg
...</pre><div class="admonition note"><div class="admonition_header">Note</div><div><p>
							You will use <code class="literal">access_key</code>, <code class="literal">bucket_name</code>, <code class="literal">hostname</code>, and <code class="literal">secret_key</code> throughout the reset of this procedure.
						</p></div></div></li><li class="listitem"><p class="simpara">
						Gather the debugging information for your backup Quay directory:
					</p><pre class="screen">$ oc adm inspect --dest-dir="${QUAY_BACKUP_DIR}/inspect-ns-quay-enterprise$(date +%Y%m%d%H%M)" ns/quay-enterprise</pre><p class="simpara">
						Example output:
					</p><pre class="screen">Gathering data for ns/quay-enterprise...
Wrote inspect data to /var/tmp/quay-backup/inspect-ns-quay-enterprise202112141307.</pre></li><li class="listitem"><p class="simpara">
						Create a backup directory for your Quay database:
					</p><pre class="screen">$ mkdir -pv $QUAY_BACKUP_DIR/db</pre></li><li class="listitem"><p class="simpara">
						Set your quay-enterprise database deployment:
					</p><pre class="screen">$ DB_DEPLOYMENT="$(oc get deployment -n quay-enterprise | awk '/quay-database/ { print $1 }')"</pre></li><li class="listitem"><p class="simpara">
						Obtain the PostgreSQL secret of your database deployment in JSON format:
					</p><pre class="screen">$ oc get deployment/$DB_DEPLOYMENT -n quay-enterprise -o jsonpath="{.spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name}{'\n'}"</pre><p class="simpara">
						Example output:
					</p><pre class="screen">example-registry-postgres-config-secret-59mhh799t8</pre></li><li class="listitem"><p class="simpara">
						Apply the PostgreSQL secret to your database deployment:
					</p><pre class="screen">$ DB_SECRET=$(oc get deployment/$DB_DEPLOYMENT -n quay-enterprise -o jsonpath="{.spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name}{'\n'}")</pre></li><li class="listitem"><p class="simpara">
						Set a PostgreSQL database user name:
					</p><pre class="screen">$ PSQL_USER="$(oc get secret/"$DB_SECRET" -n quay-enterprise -o template='{{ index .data "database-username" | base64decode }}')"</pre></li><li class="listitem"><p class="simpara">
						Set the PostgreSQL database name:
					</p><pre class="screen">$ PSQL_DB="$(oc get secret/"$DB_SECRET" -n quay-enterprise -o template='{{ index .data "database-name" | base64decode }}')"</pre></li><li class="listitem"><p class="simpara">
						Set the Quay database pod name:
					</p><pre class="screen">$ DB_POD="$(oc get pods -n quay-enterprise | awk '/quay-database/ { print $1 }')"</pre></li><li class="listitem"><p class="simpara">
						Set the Quay backup file location:
					</p><pre class="screen">$ QUAY_BACKUP_FILE="${QUAY_BACKUP_DIR}/db/${PSQL_DB}.sql"</pre></li><li class="listitem"><p class="simpara">
						Create your backup file by running the following command:
					</p><pre class="screen">$ oc exec "$DB_POD" -n quay-enterprise -- pg_dump -U "$PSQL_USER" -h localhost "$PSQL_DB"  &gt; "$QUAY_BACKUP_FILE"</pre><p class="simpara">
						You can view the contents of your backup file by running the following command:
					</p><pre class="screen">$ vi $QUAY_BACKUP_FILE</pre><p class="simpara">
						Example out
					</p><pre class="screen">COPY public."user" (id, uuid, username, password_hash, email, verified, stripe_id, organization, robot, invoice_email, invalid_login_attempts, last_invalid_login, removed_tag_expiration_s, enabled, invoice_email_address, company, family_name, given_name, location, maximum_queued_builds_count, creation_date, last_accessed) FROM stdin;
1       8e731ec4-4d39-45ae-abf5-5d88bd4fe7cd    qad1504 $2b$12$njf1LbJ.YAW3dtEGJThK2uKh9Hxj5APknQ5dDsDlgH.p8sgtnmVYu    qad1504@example.com     t       \N      f       f       f       0       2021-11-29 17:14:31.899651      1209600 t       \N      \N      \N      \N      \N      \N      2021-11-29 17:14:31.899653      \N
2       01d6c6fe-b854-43fb-853a-ac6a3f914803    testorg \N      94020f5d-5f73-4d44-96de-c2be5fd8818e    f       \N      t       f       f       0       2021-11-29 17:16:36.522396      1209600 t       \N      \N      \N      \N      \N      \N      2021-11-29 17:16:36.522399      \N
3       c3867a3e-fd01-43dd-a137-39d80ffc5386    test1   $2b$12$OgNNWrv.uZSIKcLl.HPfVuTxny3Hi4YdSs6pLroiWVAgSeXa/0Cga    test1@example.com       t       \N      f       f       f       0       2021-11-29 17:20:01.897724      1209600 t       \N      \N      \N      \N      \N      \N      2021-11-29 17:20:01.897746      \N
4       63f254e3-8d48-438f-bfc1-060fe3bd474b    test2   $2b$12$hldE02yptVKhsaxi9qzPQOqZjrOFA96yyjqwfAmSkRdL48B2q6heq    test2@example.com       t       \N      f       f       f       0       2021-11-29 17:24:08.982127      1209600 t       \N      \N      \N      \N      \N      \N      2021-11-29 17:24:08.98213       \N</pre></li><li class="listitem"><p class="simpara">
						Obtain the s3 route for your OpenShift storage namespace:
					</p><pre class="screen">$  oc get route s3 -n openshift-storage -o yaml -o jsonpath="{.spec.host}{'\n'}"</pre><p class="simpara">
						Example output:
					</p><pre class="screen">s3-openshift-storage.apps.docs2.quayteam.org</pre></li><li class="listitem"><p class="simpara">
						Install the Amazon Web Services (AWS) CLI:
					</p><pre class="screen">$ curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"</pre><pre class="screen">$ unzip awscliv2.zip</pre><pre class="screen">$ sudo ./aws/install</pre><pre class="screen">$ /usr/local/bin/aws --version</pre></li><li class="listitem"><p class="simpara">
						Obtain and export your AWS access key:
					</p><pre class="screen">$ export AWS_ACCESS_KEY_ID=VvoFhVFp8Bqcxxxxxx</pre><pre class="screen">$ export AWS_SECRET_ACCESS_KEY=XyThQKm6lMWh4O7dKdmRwMUHB9ktxxxxxxx</pre></li><li class="listitem"><p class="simpara">
						Sync your AWS s3 storage with your backup Quay directory:
					</p><pre class="screen">$ aws s3 sync  --no-verify-ssl --endpoint-url=https://s3-openshift-storage.apps.docs2.quayteam.org s3://quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf/ "${QUAY_BACKUP_DIR}/data/"</pre><p class="simpara">
						Example output:
					</p><pre class="screen">download: s3://quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf/datastorage/registry/sha256/a3/a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4 to ../../../var/tmp/quay-backup/data/datastorage/registry/sha256/a3/a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
download: s3://quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf/datastorage/registry/sha256/71/7138284460ffa3bb6ee087344f5b051468b3f8697e2d1427bac1a20c8d168b14 to ../../../var/tmp/quay-backup/data/datastorage/registry/sha256/71/7138284460ffa3bb6ee087344f5b051468b3f8697e2d1427bac1a20c8d168b14
download: s3://quay-datastore-96d2c0fa-555a-4613-a484-5b2d6d155bcf/datastorage/registry/sha256/aa/aadc30fb0b879db4832927a9f0e6236fa66e209fecf448fc2cd2c2619ee8acb2 to ../../../var/tmp/quay-backup/data/datastorage/registry/sha256/aa/aadc30fb0b879db4832927a9f0e6236fa66e209fecf448fc2cd2c2619ee8acb2</pre></li><li class="listitem"><p class="simpara">
						Scale up your Quay Operator deployment:
					</p><pre class="screen">$ oc scale deployment quay-operator.v3.6.1 --replicas=1 -n quay-enterprise</pre></li><li class="listitem"><p class="simpara">
						Scale up your Quay Application deployment:
					</p><pre class="screen">$ oc scale deployment example-registry-quay-app --replicas=1 -n quay-enterprise</pre></li><li class="listitem"><p class="simpara">
						Scale up your Quay Mirror deployment:
					</p><pre class="screen">$ oc scale deployment example-registry-quay-mirror --replicas=1 -n quay-enterprise</pre></li><li class="listitem"><p class="simpara">
						You can ensure that the Quay Operator, Quay App, and Quay Mirror deployments have successfully scaled up by running the following command:
					</p><pre class="screen">$ oc get deployment -n quay-enterprise</pre><p class="simpara">
						Example output:
					</p><pre class="screen">NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE
example-registry-clair-app            2/2     2            2           4d22h
example-registry-clair-postgres       1/1     1            1           4d22h
example-registry-quay-app             2/2     2            2           4d22h
example-registry-quay-config-editor   1/1     1            1           4d22h
example-registry-quay-database        1/1     1            1           4d22h
example-registry-quay-mirror          1/1     1            1           4d22h
example-registry-quay-redis           1/1     1            1           4d22h</pre></li><li class="listitem"><p class="simpara">
						You can ensure your pods are running by running the following command:
					</p><pre class="screen">$ oc get pods -n quay-enterprise</pre><p class="simpara">
						Example output:
					</p><pre class="screen">NAME                                                   READY   STATUS      RESTARTS   AGE
example-registry-clair-app-5c5fdd6cf4-79l9l            1/1     Running     0          3d1h
example-registry-clair-app-5c5fdd6cf4-wsrp5            1/1     Running     0          3d1h
example-registry-clair-postgres-599cf4c4c9-bzmt5       1/1     Running     1          4d22h
example-registry-quay-app-7944ff6846-5thtg             1/1     Running     0          6m58s
example-registry-quay-app-7944ff6846-fdgwx             1/1     Running     0          3d1h
example-registry-quay-app-upgrade-dwz7m                0/1     Completed   0          3d1h
example-registry-quay-config-editor-7568ff5fd9-wl9d4   1/1     Running     0          3d1h
example-registry-quay-database-74d4ff7474-t562m        1/1     Running     0          4d22h
example-registry-quay-mirror-57f5878989-mz6k4          1/1     Running     0          3d1h
example-registry-quay-mirror-57f5878989-pc27v          1/1     Running     0          42s
example-registry-quay-postgres-init-6lrnh              0/1     Completed   0          3d1h
example-registry-quay-redis-56c456fd47-b5jlj           1/1     Running     0          4d22h</pre></li></ol></div><section class="section" id="restore_red_hat_quay_when_the_operator_manages_the_database_procedure"><div class="titlepage"><div><div><h3 class="title">11.1.1. Restore Red Hat Quay when the Operator manages the database procedure</h3></div></div></div><p>
					This procedure is used to restore Red Hat Quay when the Quay Operator manages the database.
				</p><p>
					This procedure is tested within the same Red Hat Quay minor version, regardless of the z-stream version. There should be no changes in the database schema between z-stream releases.
				</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
							Red Hat Quay is deployed on OpenShift Container Platform using the Quay Operator.
						</li></ul></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist" type="1"><li class="listitem">
							Install the Quay Operator and redeploy the Quay Registry instance.
						</li><li class="listitem"><p class="simpara">
							Restore the Quay config bundle secret.
						</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">
									Create a new secret from the back up config bundle:
								</p><pre class="screen">$ oc create secret generic SECRET_NAME --from-file="${QUAY_BACKUP_DIR}/config/"</pre></li><li class="listitem"><p class="simpara">
									Patch the QuayRegistry CRD:
								</p><pre class="screen">$ oc patch quayregistries.quay.redhat.com REGISTRY_NAME --type='merge' -p '{"spec":{"configBundleSecret":"SECRET_NAME"}}'</pre></li><li class="listitem">
									Vertify that Quay is running with the desired configurations.
								</li></ol></div></li><li class="listitem"><p class="simpara">
							Scale down the Quay Operator, Quay App, and Quay Mirror deployments:
						</p><pre class="screen">$ oc scale deployment quay-operator.v3.6.2 --replicas=0 -n openshift-operators
$ oc scale deployment instance-quay-app --replicas=0
$ oc scale deployment instance-quay-mirror --replicas=0</pre></li><li class="listitem"><p class="simpara">
							Restore the s3 bucket.
						</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">
									Configure <code class="literal">s3cmd</code> with the new NooBaa bucket credentials.
								</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem">
											Edit the <code class="literal">$HOME/.s3cfg</code> file to insert the above credentials.
										</li></ol></div></li><li class="listitem"><p class="simpara">
									Restore the data:
								</p><pre class="screen">$ s3cmd sync /var/tmp/quay-backup/data/ s3://instance00-obc-[...]/</pre></li></ol></div></li><li class="listitem"><p class="simpara">
							Restore the back up database.
						</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">
									Copy the following dump on the database pod:
								</p><pre class="screen">$ oc cp /path/to/quay/backup.sql &lt;REGISTRY_NAME&gt;-quay-database-xxxxxxxxxx-xxxxx:/tmp</pre></li><li class="listitem"><p class="simpara">
									Run a remote shell on the database pod:
								</p><pre class="screen">$ oc rsh REGISTRY_NAME-quay-database-xxxxxxxxxx-xxxxx
sh-4.4$ psql
postgres=# DROP DATABASE "database-name";
postgres=# CREATE DATABASE "database-name" OWNER "database-username";
sh-4.4$ psql database-name &lt; /tmp/backup.sql</pre></li></ol></div></li><li class="listitem"><p class="simpara">
							Enable debug by setting <code class="literal">DEBUGLOG=true</code>:
						</p><pre class="screen">$ oc edit deployment instance-quay-app</pre></li><li class="listitem"><p class="simpara">
							Scale up the Quay Operator, Quay App, and Quay Mirror Deployments:
						</p><pre class="screen">$ oc scale deployment quay-operator.v3.6.2 --replicas=1 -n openshift-operators
$ oc scale deployment instance-quay-app --replicas=1
$ oc scale deployment instance-quay-mirror --replicas=1</pre></li><li class="listitem">
							Verify that Quay is up and running.
						</li><li class="listitem"><p class="simpara">
							Verify that the installation is functional.
						</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
									Pull an image from an existing repository.
								</li><li class="listitem">
									Push an image into an existing repository.
								</li><li class="listitem">
									Create a new repository.
								</li><li class="listitem">
									Create a new organization.
								</li><li class="listitem">
									Sync a mirror repository.
								</li></ol></div></li><li class="listitem">
							Disable debug by setting <code class="literal">DEBUGLOG=false</code>.
						</li></ol></div></section><section class="section" id="restore_quay_when_the_quay_operator_does_not_manage_the_database"><div class="titlepage"><div><div><h3 class="title">11.1.2. Restore Quay when the Quay Operator does not manage the database</h3></div></div></div><p>
					This procedure is used to restore Red Hat Quay when the Quay Operator does not manage the database.
				</p><p>
					This procedure is tested within the same Red Hat Quay minor version, regardless of the z-stream version. There should be no changes in the database schema between z-stream releases.
				</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
							Red Hat Quay is deployed on OpenShift Container Platform using the Quay Operator.
						</li><li class="listitem">
							To create a PostgreSQL database, you must be a superuser or have the <code class="literal">CREATEDB</code> privilege.
						</li></ul></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Create a new database in the database engine:
						</p><pre class="screen">$ CREATE DATABASE &lt;name&gt;</pre><p class="simpara">
							For a list of available parameters, see <a class="link" href="https://www.postgresql.org/docs/11/sql-createdatabase.html">Creating a PostgreSQL database</a>.
						</p></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">pg_trgm</code> extension on the newly-created database:
						</p><pre class="screen">$ CREATE EXTENSION pg_trgm</pre></li><li class="listitem"><p class="simpara">
							Restore the Quay database from backup with psql.
						</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">
									Generate a file with the SQL commands that will recreate the database in the same state as it was at the time of the dump:
								</p><pre class="screen">$ pg_dump dbname &gt; dumpfile</pre></li></ol></div></li><li class="listitem"><p class="simpara">
							Restore the dump.
						</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">
									Files created by <code class="literal">pg_dump</code> are intended to be read by the psql program. To restore a dump, use the following command:
								</p><pre class="screen">$ psql dbname &lt; dumpfile <span id="CO5-1"/><span class="callout">1</span></pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO5-1"><span class="callout">1</span></a> </dt><dd><div class="para">
											The database <code class="literal">dbname</code> will not be created by this command. You must create it yourself from <code class="literal">template0</code> before executing psql. For example, <code class="literal">createdb -T template0 dbname</code>. Additionally, your dumpfile is the file output by the <code class="literal">pg_dump</code> command.
										</div></dd></dl></div></li><li class="listitem"><p class="simpara">
									By default, the <code class="literal">psql</code> script will continue executing after an SQL error is encountered. Running <code class="literal">psql</code> with the <code class="literal">ON_ERROR_STOP</code> variable set has <code class="literal">psql exit</code> with an exist status of 3 if an SQL error occurs:
								</p><pre class="screen">$ psql --set ON_ERROR_STOP=on dbname &lt; dumpfile</pre></li><li class="listitem"><p class="simpara">
									Using <code class="literal">pg_dump</code> and <code class="literal">psql</code> to write or read from pipes makes it possible to dump a database from one server to another. For example:
								</p><pre class="screen">pg_dump -h host1 dbname | psql -h host2 dbname</pre><div class="admonition important"><div class="admonition_header">Important</div><div><p>
										The dumps produced by <code class="literal">pg_dump</code> are relative to template0. This means that any languages, procedures, etc. added via template1 will also be dumped by <code class="literal">pg_dump</code>. As a result, when restoring, if you are using a customized template1, you must create the empty database from template0, as in the example above.
									</p><p>
										After restoring a backup, we suggest running <a class="link" href="https://www.postgresql.org/docs/11/sql-analyze.html">ANALYZE</a> on each database so that the query optimizer has useful statistics; see <a class="link" href="https://www.postgresql.org/docs/11/routine-vacuuming.html#VACUUM-FOR-STATISTICS">Section 24.1.3</a> and <a class="link" href="https://www.postgresql.org/docs/11/routine-vacuuming.html#AUTOVACUUM">Section 24.1.6</a> for more information. For more advice on how to load large amounts of data into PostgreSQL efficiently, see <a class="link" href="https://www.postgresql.org/docs/11/populate.html">section 14.4</a>.
									</p></div></div></li></ol></div></li><li class="listitem"><p class="simpara">
							Create a new blob storage bucket and copy all blobs to the bucket from backup with the appropriate tool, such as s3cmd, awscli, or Azure. The following example uses s3cmd:
						</p><pre class="screen">$ aws s3 sync s3://DOC-EXAMPLE-BUCKET-SOURCE s3://DOC-EXAMPLE-BUCKET-TARGET</pre></li><li class="listitem">
							Edit the custom config bundle and modify the <code class="literal">DB_URI</code> and <code class="literal">storage</code> parameters if needed. Create the custom config bundle secret with the same name as before.
						</li><li class="listitem">
							Install the Quay Operator and apply the same QuayRegistry CR as before. It should reference the created custom config bundle. The Operator should reconcile everything, create the necessary secrets, and start Quay.
						</li></ol></div></section><section class="section" id="restore_quay_on_a_virtual_machine_deployment"><div class="titlepage"><div><div><h3 class="title">11.1.3. Restore Quay on a virtual machine deployment</h3></div></div></div><p>
					This procedure is used to restore Red Hat Quay on a virtual machine (VM) deployment.
				</p><p>
					This procedure is tested within the same Red Hat Quay minor version, regardless of the z-stream version. There should be no changes in the database schema between z-stream releases.
				</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
							To create a PostgreSQL database, you must be a superuser or have the <code class="literal">CREATEDB</code> privilege.
						</li></ul></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Create a new database in the database engine:
						</p><pre class="screen">$ CREATE DATABASE &lt;name&gt;</pre><p class="simpara">
							For a list of available parameters, see <a class="link" href="https://www.postgresql.org/docs/11/sql-createdatabase.html">Creating a PostgreSQL database</a>.
						</p></li><li class="listitem"><p class="simpara">
							Create the <code class="literal">pg_trgm</code> extension on the newly-created database:
						</p><pre class="screen">$ CREATE EXTENSION pg_trgm</pre></li><li class="listitem"><p class="simpara">
							Restore the Quay database from backup with psql.
						</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">
									Generate a file with the SQL commands that will recreate the database in the same state as it was at the time of the dump:
								</p><pre class="screen">$ pg_dump dbname &gt; dumpfile</pre></li></ol></div></li><li class="listitem"><p class="simpara">
							Restore the dump.
						</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">
									Files created by <code class="literal">pg_dump</code> are intended to be read by the psql program. To restore a dump, use the following command:
								</p><pre class="screen">$ psql dbname &lt; dumpfile <span id="CO6-1"/><span class="callout">1</span></pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO6-1"><span class="callout">1</span></a> </dt><dd><div class="para">
											The database <code class="literal">dbname</code> will not be created by this command. You must create it yourself from <code class="literal">template0</code> before executing psql. For example, <code class="literal">createdb -T template0 dbname</code>. Additionally, your dumpfile is the file output by the <code class="literal">pg_dump</code> command.
										</div></dd></dl></div></li><li class="listitem"><p class="simpara">
									By default, the <code class="literal">psql</code> script will continue executing after an SQL error is encountered. Running <code class="literal">psql</code> with the <code class="literal">ON_ERROR_STOP</code> variable set has <code class="literal">psql exit</code> with an exist status of 3 if an SQL error occurs:
								</p><pre class="screen">$ psql --set ON_ERROR_STOP=on dbname &lt; dumpfile</pre></li><li class="listitem"><p class="simpara">
									Using <code class="literal">pg_dump</code> and <code class="literal">psql</code> to write or read from pipes makes it possible to dump a database from one server to another. For example:
								</p><pre class="screen">pg_dump -h host1 dbname | psql -h host2 dbname</pre><div class="admonition important"><div class="admonition_header">Important</div><div><p>
										The dumps produced by <code class="literal">pg_dump</code> are relative to template0. This means that any languages, procedures, etc. added via template1 will also be dumped by <code class="literal">pg_dump</code>. As a result, when restoring, if you are using a customized template1, you must create the empty database from template0, as in the example above.
									</p><p>
										After restoring a backup, we suggest running <a class="link" href="https://www.postgresql.org/docs/11/sql-analyze.html">ANALYZE</a> on each database so that the query optimizer has useful statistics; see <a class="link" href="https://www.postgresql.org/docs/11/routine-vacuuming.html#VACUUM-FOR-STATISTICS">Section 24.1.3</a> and <a class="link" href="https://www.postgresql.org/docs/11/routine-vacuuming.html#AUTOVACUUM">Section 24.1.6</a> for more information. For more advice on how to load large amounts of data into PostgreSQL efficiently, see <a class="link" href="https://www.postgresql.org/docs/11/populate.html">section 14.4</a>.
									</p></div></div></li></ol></div></li><li class="listitem"><p class="simpara">
							Create a new blob storage bucket and copy all blobs to the bucket from backup with the appropriate tool, such as s3cmd, awscli, or Azure. The following example uses s3cmd:
						</p><pre class="screen">$ aws s3 sync s3://DOC-EXAMPLE-BUCKET-SOURCE s3://DOC-EXAMPLE-BUCKET-TARGET</pre></li><li class="listitem"><p class="simpara">
							Restore the config bundle directory from storage:
						</p><pre class="screen"/></li><li class="listitem"><p class="simpara">
							Edit the DB_URI inside the config.yaml file so that it references the new database if needed:
						</p><pre class="screen">DB_URI: postgresql://quay360-quay-database:0vrsIUYdhCnF8r-jwz7zR6gck6kcLLQhJ11u0dx1lz8YBk185P5NnqIBwtY22JArYLi3opdKJH2-w4aM@quay360-quay-database:5432/quay360-quay-database</pre></li><li class="listitem"><p class="simpara">
							Edit the storage parameters (new bucket name, new host, and new credentials) if needed:
						</p><pre class="screen">DISTRIBUTED_STORAGE_CONFIG:
  default:
  - S3Storage
  - host: s3.us-east-2.amazonaws.com
    s3_access_key: ******
    s3_bucket: quay360
    s3_secret_key: *****
    storage_path: /quay360</pre></li><li class="listitem"><p class="simpara">
							Start the same version of Red Hat Quay that was running prior to restoration against the restored config bundle:
						</p><pre class="screen"># sudo podman run --restart=always -p 443:8443 -p 80:8080 \
   -v /mnt/quay/config:/conf/stack:Z \
   -v /mnt/quay/storage:/datastorage:Z \
   -d registry.redhat.io/quay/quay-rhel8:v3.6.2</pre></li><li class="listitem"><p class="simpara">
							If Quay restarts normally, scale up the Quay Operator, Quay App, and Quay Mirror Deployments:
						</p><pre class="screen">$ oc scale deployment quay-operator.v3.6.2 --replicas=1 -n openshift-operators
$ oc scale deployment instance-quay-app --replicas=1
$ oc scale deployment instance-quay-mirror --replicas=1</pre></li><li class="listitem">
							Verify that Quay is up and running.
						</li><li class="listitem"><p class="simpara">
							Verify that the installation is functional.
						</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
									Pull an image from an existing repository.
								</li><li class="listitem">
									Push an image into an existing repository.
								</li><li class="listitem">
									Create a new repository.
								</li><li class="listitem">
									Create a new organization.
								</li><li class="listitem">
									Sync a mirror repository.
								</li></ol></div></li></ol></div></section></section></section><section class="chapter" id="ldap-authentication-setup-for-quay-enterprise"><div class="titlepage"><div><div><h1 class="title">Chapter 12. LDAP Authentication Setup for Red Hat Quay</h1></div></div></div><p>
			The Lightweight Directory Access Protocol (LDAP) is an open, vendor-neutral, industry standard application protocol for accessing and maintaining distributed directory information services over an Internet Protocol (IP) network. Red Hat Quay supports using LDAP as an identity provider.
		</p><section class="section" id="considerations_prior_to_enabling_ldap"><div class="titlepage"><div><div><h2 class="title">12.1. Considerations prior to enabling LDAP</h2></div></div></div><section class="section" id="considerations-for-existing-quay-deployments"><div class="titlepage"><div><div><h3 class="title">12.1.1. Existing Quay deployments</h3></div></div></div><p>
					Conflicts between user names can arise when you enable LDAP for an existing Quay deployment that already has users configured. Consider the scenario where a particular user, <code class="literal">alice</code>, was manually created in Quay prior to enabling LDAP. If the user name <code class="literal">alice</code> also exists in the LDAP directory, Quay will create a new user <code class="literal">alice-1</code> when <code class="literal">alice</code> logs in for the first time using LDAP, and will map the LDAP credentials to this account. This might not be want you want, for consistency reasons, and it is recommended that you remove any potentially conflicting local account names from Quay prior to enabling LDAP.
				</p></section><section class="section" id="considerations-for-manual-user-creation"><div class="titlepage"><div><div><h3 class="title">12.1.2. Manual User Creation and LDAP authentication</h3></div></div></div><p>
					When Quay is configured for LDAP, LDAP-authenticated users are automatically created in Quay’s database on first log in, if the configuration option <code class="literal">FEATURE_USER_CREATION</code> is set to <code class="literal">true</code>. If this option is set to <code class="literal">false</code>, the automatic user creation for LDAP users will fail and the user is not allowed to log in. In this scenario, the superuser needs to create the desired user account first. Conversely, if <code class="literal">FEATURE_USER_CREATION</code> is set to <code class="literal">true</code>, this also means that a user can still create an account from the Quay login screen, even if there is an equivalent user in LDAP.
				</p></section></section><section class="section" id="setup-ldap-configuration"><div class="titlepage"><div><div><h2 class="title">12.2. Set Up LDAP Configuration</h2></div></div></div><p>
				In the config tool, locate the Authentication section and select “LDAP” from the drop-down menu. Update LDAP configuration fields as required.
			</p><p>
				<span class="inlinemediaobject"><img src="images/authentication-ldap.png" alt="Fill in LDAP information"/></span>
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Here is an example of the resulting entry in the <span class="emphasis"><em>config.yaml</em></span> file:
					</li></ul></div><pre class="literallayout">AUTHENTICATION_TYPE: LDAP</pre><section class="section" id="full_ldap_uri"><div class="titlepage"><div><div><h3 class="title">12.2.1. Full LDAP URI</h3></div></div></div><p>
					<span class="inlinemediaobject"><img src="images/authentication-ldap-uri.png" alt="LDAP server URI"/></span>
					<span class="inlinemediaobject"><img src="images/authentication-ldap-ssl.png" alt="LDAP server SSL"/></span>
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							The full LDAP URI, including the <span class="emphasis"><em>ldap://</em></span> or <span class="emphasis"><em>ldaps://</em></span> prefix.
						</li><li class="listitem">
							A URI beginning with <span class="emphasis"><em>ldaps://</em></span> will make use of the provided SSL certificate(s) for TLS setup.
						</li><li class="listitem">
							Here is an example of the resulting entry in the <span class="emphasis"><em>config.yaml</em></span> file:
						</li></ul></div><pre class="literallayout">LDAP_URI: ldaps://ldap.example.org</pre></section><section class="section" id="team_synchronization"><div class="titlepage"><div><div><h3 class="title">12.2.2. Team Synchronization</h3></div></div></div><p>
					<span class="inlinemediaobject"><img src="images/authentication-ldap-team-sync-1.png" alt="Team synchronization"/></span>
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							If enabled, organization administrators who are also superusers can set teams to have their membership synchronized with a backing group in LDAP.
						</li></ul></div><p>
					<span class="inlinemediaobject"><img src="images/authentication-ldap-team-sync-2.png" alt="Team synchronization"/></span>
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							The resynchronization duration is the period at which a team must be re-synchronized. Must be expressed in a duration string form: 30m, 1h, 1d.
						</li><li class="listitem">
							Optionally allow non-superusers to enable and manage team syncing under organizations in which they are administrators.
						</li><li class="listitem">
							Here is an example of the resulting entries in the <span class="emphasis"><em>config.yaml</em></span> file:
						</li></ul></div><pre class="literallayout">FEATURE_TEAM_SYNCING: true
TEAM_RESYNC_STALE_TIME: 60m
FEATURE_NONSUPERUSER_TEAM_SYNCING_SETUP: true</pre></section><section class="section" id="base_and_relative_distinguished_names"><div class="titlepage"><div><div><h3 class="title">12.2.3. Base and Relative Distinguished Names</h3></div></div></div><p>
					<span class="inlinemediaobject"><img src="images/authentication-ldap-basedn.png" alt="Distinguished Names"/></span>
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							A Distinguished Name path which forms the base path for looking up all LDAP records. Example: <span class="emphasis"><em>dc=my,dc=domain,dc=com</em></span>
						</li><li class="listitem">
							Optional list of Distinguished Name path(s) which form the secondary base path(s) for looking up all user LDAP records, relative to the Base DN defined above. These path(s) will be tried if the user is not found via the primary relative DN.
						</li><li class="listitem">
							User Relative DN is relative to BaseDN. Example: <span class="emphasis"><em>ou=NYC</em></span> not <span class="emphasis"><em>ou=NYC,dc=example,dc=org</em></span>
						</li><li class="listitem">
							Multiple “Secondary User Relative DNs” may be entered if there are multiple Organizational Units where User objects are located at. Simply type in the Organizational Units and click on Add button to add multiple RDNs. Example: <span class="emphasis"><em>ou=Users,ou=NYC and ou=Users,ou=SFO</em></span>
						</li><li class="listitem">
							The "User Relative DN" searches with subtree scope. For example, if your Organization has Organizational Units NYC and SFO under the Users OU (<span class="emphasis"><em>ou=SFO,ou=Users</em></span> and <span class="emphasis"><em>ou=NYC,ou=Users</em></span>), Red Hat Quay can authenticate users from both the <span class="emphasis"><em>NYC</em></span> and <span class="emphasis"><em>SFO</em></span> Organizational Units if the User Relative DN is set to Users (<span class="emphasis"><em>ou=Users</em></span>).
						</li><li class="listitem">
							Here is an example of the resulting entries in the <span class="emphasis"><em>config.yaml</em></span> file:
						</li></ul></div><pre class="literallayout">LDAP_BASE_DN:
- dc=example
- dc=com
LDAP_USER_RDN:
- ou=users
LDAP_SECONDARY_USER_RDNS:
- ou=bots
- ou=external</pre></section><section class="section" id="additional_user_filters"><div class="titlepage"><div><div><h3 class="title">12.2.4. Additional User Filters</h3></div></div></div><p>
					<span class="inlinemediaobject"><img src="images/authentication-ldap-user-filter.png" alt="User filters"/></span>
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							If specified, the additional filter used for all user lookup queries. Note that all Distinguished Names used in the filter must be <span class="strong strong"><strong>full</strong></span> paths; the Base DN is not added automatically here. <span class="strong strong"><strong>Must</strong></span> be wrapped in parens. Example: (&amp;(someFirstField=someValue)(someOtherField=someOtherValue))
						</li><li class="listitem">
							Here is an example of the resulting entry in the <span class="emphasis"><em>config.yaml</em></span> file:
						</li></ul></div><pre class="literallayout">LDAP_USER_FILTER: (memberof=cn=developers,ou=groups,dc=example,dc=com)</pre></section><section class="section" id="administrator_dn"><div class="titlepage"><div><div><h3 class="title">12.2.5. Administrator DN</h3></div></div></div><p>
					<span class="inlinemediaobject"><img src="images/authentication-ldap-admin-dn.png" alt="Administrator DN"/></span>
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							The Distinguished Name and password for the administrator account. This account must be able to login and view the records for all user accounts. Example: uid=admin,ou=employees,dc=my,dc=domain,dc=com
						</li><li class="listitem">
							The password will be stored in <span class="strong strong"><strong>plaintext</strong></span> inside the config.yaml, so setting up a dedicated account or using a password hash is highly recommended.
						</li><li class="listitem">
							Here is an example of the resulting entries in the <span class="emphasis"><em>config.yaml</em></span> file:
						</li></ul></div><pre class="literallayout">LDAP_ADMIN_DN: cn=admin,dc=example,dc=com
LDAP_ADMIN_PASSWD: changeme</pre></section><section class="section" id="uid_and_mail_attributes"><div class="titlepage"><div><div><h3 class="title">12.2.6. UID and Mail attributes</h3></div></div></div><p>
					<span class="inlinemediaobject"><img src="images/authentication-ldap-uid-mail.png" alt="UID and Mail"/></span>
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							The UID attribute is the name of the property field in LDAP user record to use as the <span class="strong strong"><strong>username</strong></span>. Typically "uid".
						</li><li class="listitem">
							The Mail attribute is the name of the property field in LDAP user record that stores user e-mail address(es). Typically "mail".
						</li><li class="listitem">
							Either of these may be used during login.
						</li><li class="listitem">
							The logged in username must exist in User Relative DN.
						</li><li class="listitem">
							<span class="emphasis"><em>sAMAccountName</em></span> is the UID attribute for against Microsoft Active Directory setups.
						</li><li class="listitem">
							Here is an example of the resulting entries in the <span class="emphasis"><em>config.yaml</em></span> file:
						</li></ul></div><pre class="literallayout">LDAP_UID_ATTR: uid
LDAP_EMAIL_ATTR: mail</pre></section><section class="section" id="validation"><div class="titlepage"><div><div><h3 class="title">12.2.7. Validation</h3></div></div></div><p>
					Once the configuration is completed, click on “Save Configuration Changes” button to validate the configuration.
				</p><p>
					<span class="inlinemediaobject"><img src="images/authentication-ldap-success.png" alt="Fill in LDAP information"/></span>
				</p><p>
					All validation must succeed before proceeding, or additional configuration may be performed by selecting the "Continue Editing" button.
				</p></section></section><section class="section" id="common-issues"><div class="titlepage"><div><div><h2 class="title">12.3. Common Issues</h2></div></div></div><p>
				<span class="strong strong"><strong><span class="emphasis"><em>Invalid credentials</em></span></strong></span>
			</p><p>
				Administrator DN or Administrator DN Password values are incorrect
			</p><p>
				<span class="strong strong"><strong><span class="emphasis"><em>Verification of superuser %USERNAME% failed: Username not found The user either does not exist in the remote authentication system OR LDAP auth is misconfigured.</em></span></strong></span>
			</p><p>
				Red Hat Quay can connect to the LDAP server via Username/Password specified in the Administrator DN fields however cannot find the current logged in user with the UID Attribute or Mail Attribute fields in the User Relative DN Path. Either current logged in user does not exist in User Relative DN Path, or Administrator DN user do not have rights to search/read this LDAP path.
			</p></section><section class="section" id="configure-ldap-superuser"><div class="titlepage"><div><div><h2 class="title">12.4. Configure an LDAP user as superuser</h2></div></div></div><p>
				Once LDAP is configured, you can log in to your Red Hat Quay instance with a valid LDAP username and password. You are prompted to confirm your Red Hat Quay username as shown in the following figure:
			</p><p>
				<span class="inlinemediaobject"><img src="images/confirm-ldap-username.png" alt="Confirm LDAP username for Red Hat Quay"/></span>
			</p><p>
				To attach superuser privilege to an LDAP user, modify the <span class="emphasis"><em>config.yaml</em></span> file with the username. For example:
			</p><pre class="literallayout">SUPER_USERS:
- testadmin</pre><p>
				Restart the Red Hat <code class="literal">Quay</code> container with the updated config.yaml file. The next time you log in, the user will have superuser privileges.
			</p></section></section><section class="chapter" id="prometheus-metrics-under-quay-enterprise"><div class="titlepage"><div><div><h1 class="title">Chapter 13. Prometheus and Grafana metrics under Red Hat Quay</h1></div></div></div><p>
			Red Hat Quay exports a <a class="link" href="https://prometheus.io/">Prometheus</a>- and Grafana-compatible endpoint on each instance to allow for easy monitoring and alerting.
		</p><section class="section" id="exposing-the-prometheus-endpoint"><div class="titlepage"><div><div><h2 class="title">13.1. Exposing the Prometheus endpoint</h2></div></div></div><p>
				The Prometheus- and Grafana-compatible endpoint on the Red Hat Quay instance can be found at port <code class="literal">9091</code>. See <a class="link" href="https://access.redhat.com/solutions/3750281">Monitoring Quay with Prometheus and Grafana</a> for details on configuring Prometheus and Grafana to monitor Quay repository counts.
			</p><section class="section" id="setting-up-prometheus-to-consume-metrics"><div class="titlepage"><div><div><h3 class="title">13.1.1. Setting up Prometheus to consume metrics</h3></div></div></div><p>
					Prometheus needs a way to access all Red Hat Quay instances running in a cluster. In the typical setup, this is done by listing all the Red Hat Quay instances in a single named DNS entry, which is then given to Prometheus.
				</p></section><section class="section" id="dns-configuration-under-kubernetes"><div class="titlepage"><div><div><h3 class="title">13.1.2. DNS configuration under Kubernetes</h3></div></div></div><p>
					A simple <a class="link" href="http://kubernetes.io/docs/user-guide/services/">Kubernetes service</a> can be configured to provide the DNS entry for Prometheus. Details on running Prometheus under Kubernetes can be found at <a class="link" href="https://coreos.com/blog/prometheus-and-kubernetes-up-and-running.html">Prometheus and Kubernetes</a> and <a class="link" href="https://coreos.com/blog/monitoring-kubernetes-with-prometheus.html">Monitoring Kubernetes with Prometheus</a>.
				</p></section><section class="section" id="dns-configuration-for-a-manual-cluster"><div class="titlepage"><div><div><h3 class="title">13.1.3. DNS configuration for a manual cluster</h3></div></div></div><p>
					<a class="link" href="https://github.com/skynetservices/skydns">SkyDNS</a> is a simple solution for managing this DNS record when not using Kubernetes. SkyDNS can run on an <a class="link" href="https://github.com/coreos/etcd">etcd</a> cluster. Entries for each Red Hat Quay instance in the cluster can be added and removed in the etcd store. SkyDNS will regularly read them from there and update the list of Quay instances in the DNS record accordingly.
				</p></section></section></section><section class="chapter" id="georepl-intro"><div class="titlepage"><div><div><h1 class="title">Chapter 14. Geo-replication</h1></div></div></div><p>
			Geo-replication allows multiple, geographically distributed Quay deployments to work as a single registry from the perspective of a client or user. It significantly improves push and pull performance in a globally-distributed Quay setup. Image data is asynchronously replicated in the background with transparent failover / redirect for clients.
		</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				Deploying Red Hat Quay with geo-replication on OpenShift is not supported by the Operator.
			</p></div></div><section class="section" id="geo_replication_features"><div class="titlepage"><div><div><h2 class="title">14.1. Geo-replication features</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						When geo-replication is configured, container image pushes will be written to the preferred storage engine for that Red Hat Quay instance (typically the nearest storage backend within the region).
					</li><li class="listitem">
						After the initial push, image data will be replicated in the background to other storage engines.
					</li><li class="listitem">
						The list of replication locations is configurable and those can be different storage backends.
					</li><li class="listitem">
						An image pull will always use the closest available storage engine, to maximize pull performance.
					</li><li class="listitem">
						If replication hasn’t been completed yet, the pull will use the source storage backend instead.
					</li></ul></div></section><section class="section" id="georepl-prereqs"><div class="titlepage"><div><div><h2 class="title">14.2. Geo-replication requirements and constraints</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						A single database, and therefore all metadata and Quay configuration, is shared across all regions.
					</li><li class="listitem">
						A single Redis cache is shared across the entire Quay setup and needs to accessible by all Quay pods.
					</li><li class="listitem">
						The exact same configuration should be used across all regions, with exception of the storage backend, which can be configured explicitly using the <code class="literal">QUAY_DISTRIBUTED_STORAGE_PREFERENCE</code> environment variable.
					</li><li class="listitem">
						Geo-Replication requires object storage in each region. It does not work with local storage or NFS.
					</li><li class="listitem">
						Each region must be able to access every storage engine in each region (requires a network path).
					</li><li class="listitem">
						Alternatively, the storage proxy option can be used.
					</li><li class="listitem">
						The entire storage backend (all blobs) is replicated. This is in contrast to repository mirroring, which can be limited to an organization or repository or image.
					</li><li class="listitem">
						All Quay instances must share the same entrypoint, typically via load balancer.
					</li><li class="listitem">
						All Quay instances must have the same set of superusers, as they are defined inside the common configuration file.
					</li></ul></div><p>
				If the above requirements cannot be met, you should instead use two or more distinct Quay deployments and take advantage of repository mirroring functionality.
			</p></section><section class="section" id="georepl-arch"><div class="titlepage"><div><div><h2 class="title">14.3. Geo-replication architecture</h2></div></div></div><p>
				<span class="inlinemediaobject"><img src="images/178_Quay_architecture_0821_georeplication.png" alt="Georeplication"/></span>
			</p><p>
				In the example shown above, Quay is running in two separate regions, with a common database and a common Redis instance. Localized image storage is provided in each region and image pulls are served from the closest available storage engine. Container image pushes are written to the preferred storage engine for the Quay instance, and will then be replicated, in the background, to the other storage engines.
			</p></section><section class="section" id="config-ui-storage-georepl"><div class="titlepage"><div><div><h2 class="title">14.4. Enable storage replication</h2></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
						Scroll down to the section entitled <code class="literal">Registry Storage</code>.
					</li><li class="listitem">
						Click <code class="literal">Enable Storage Replication</code>.
					</li><li class="listitem">
						Add each of the storage engines to which data will be replicated. All storage engines to be used must be listed.
					</li><li class="listitem">
						If complete replication of all images to all storage engines is required, under each storage engine configuration click <code class="literal">Replicate to storage engine by default</code>. This will ensure that all images are replicated to that storage engine. To instead enable per-namespace replication, please contact support.
					</li><li class="listitem">
						When you are done, click <code class="literal">Save Configuration Changes</code>. Configuration changes will take effect the next time Red Hat Quay restarts.
					</li><li class="listitem"><p class="simpara">
						After adding storage and enabling “Replicate to storage engine by default” for Georeplications, you need to sync existing image data across all storage. To do this, you need to <code class="literal">oc exec</code> (or docker/kubectl exec) into the container and run:
					</p><pre class="screen"># scl enable python27 bash
# python -m util.backfillreplication</pre><p class="simpara">
						This is a one time operation to sync content after adding new storage.
					</p></li></ol></div><section class="section" id="georepl-deploy"><div class="titlepage"><div><div><h3 class="title">14.4.1. Run Red Hat Quay with storage preferences</h3></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
							Copy the config.yaml to all machines running Red Hat Quay
						</li><li class="listitem"><p class="simpara">
							For each machine in each region, add a <code class="literal">QUAY_DISTRIBUTED_STORAGE_PREFERENCE</code> environment variable with the preferred storage engine for the region in which the machine is running.
						</p><p class="simpara">
							For example, for a machine running in Europe with the config directory on the host available from <code class="literal">$QUAY/config</code>:
						</p><pre class="literallayout">$ sudo podman run -d --rm -p 80:8080 -p 443:8443  \
   --name=quay \
   -v $QUAY/config:/conf/stack:Z \
   -e QUAY_DISTRIBUTED_STORAGE_PREFERENCE=europestorage \
   registry.redhat.io/quay/quay-rhel8:v3.6.2</pre><div class="admonition note"><div class="admonition_header">Note</div><div><p>
								The value of the environment variable specified must match the name of a Location ID as defined in the config panel.
							</p></div></div></li><li class="listitem">
							Restart all Red Hat Quay containers
						</li></ol></div></section></section></section><section class="chapter" id="quay-troubleshooting-guides"><div class="titlepage"><div><div><h1 class="title">Chapter 15. Red Hat Quay Troubleshooting</h1></div></div></div><p>
			Common failure modes and best practices for recovery.
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/429.html">I’m receiving HTTP Status Code 429</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/auth-failure.html">I’m authorized but I’m still getting 403s</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/base-pull-issue.html">Base image pull in Dockerfile fails with 403</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/cannot-add-trigger.html">Cannot add a build trigger</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/cannot-load-build-logs.html">Build logs are not loading</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/cannot-locate-dockerfile.html">I’m receiving "Cannot locate specified Dockerfile"</a> * <a class="link" href="http://docs.quay.io/issues/could-not-reach-any-registry-endpoint.html">Could not reach any registry endpoint</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/ecs-auth-failure.html">Cannot access private repositories using EC2 Container Service</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/iotimeout.html">Docker is returning an i/o timeout</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/odd-login-failure.html">Docker login is failing with an odd error</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/odd-pull-failure.html">Pulls are failing with an odd error</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/push-timestamp-wrong.html">I just pushed but the timestamp is wrong</a>
				</li><li class="listitem">
					<a class="link" href="http://docs.quay.io/issues/quay-mesos.html">Pulling Private Quay.io images with Marathon/Mesos fails</a>
				</li></ul></div></section><section class="chapter" id="quay-schema"><div class="titlepage"><div><div><h1 class="title">Chapter 16. Schema for Red Hat Quay configuration</h1></div></div></div><p>
			Most Red Hat Quay configuration information is stored in the <code class="literal">config.yaml</code> file that is created using the browser-based config tool when Red Hat Quay is first deployed.
		</p><p>
			The configuration options are described in the Red Hat Quay Configuration Guide.
		</p><h2 id="additional_resources">Additional resources</h2></section><div><div xml:lang="en-US" class="legalnotice" id="idm45792902728640"><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"/>© 2021 Red Hat, Inc.
	</div><div class="para">
		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). An explanation of CC-BY-SA is available at <a class="uri" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>. In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
	</div><div class="para">
		Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.
	</div><div class="para">
		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Linux</span>® is the registered trademark of Linus Torvalds in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Java</span>® is a registered trademark of Oracle and/or its affiliates.
	</div><div class="para">
		<span class="trademark">XFS</span>® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries.
	</div><div class="para">
		<span class="trademark">MySQL</span>® is a registered trademark of MySQL AB in the United States, the European Union and other countries.
	</div><div class="para">
		<span class="trademark">Node.js</span>® is an official trademark of Joyent. Red Hat is not formally related to or endorsed by the official Joyent Node.js open source or commercial project.
	</div><div class="para">
		The <span class="trademark">OpenStack</span>® Word Mark and OpenStack logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.
	</div><div class="para">
		All other trademarks are the property of their respective owners.
	</div></div></div></div></div></div><script type="text/javascript">
                        jQuery(document).ready(function() {
                            initSwitchery();
                            jQuery('pre[class*="language-"]').each(function(i, block){hljs.highlightBlock(block);});
                        });
                    </script></body></html>
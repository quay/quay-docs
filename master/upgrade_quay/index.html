<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Upgrade Red Hat Quay</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css"/><meta name="generator" content="publican v4.3.4"/><meta name="description" content="Upgrade Red Hat Quay"/><link rel="next" href="#upgrade_overview" title="Chapter 1. Upgrade overview"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><script type="text/javascript" src="Common_Content/scripts/jquery-1.7.1.min.js"> </script><script type="text/javascript" src="Common_Content/scripts/utils.js"> </script><script type="text/javascript" src="Common_Content/scripts/highlight.js/highlight.pack.js"> </script></head><body><div id="chrometwo"><div id="main"><div xml:lang="en-US" class="book" id="idm46232706137984"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat Quay</span> <span class="productnumber">3.7</span></div><div><h1 class="title">Upgrade Red Hat Quay</h1></div><div><h2 class="subtitle">Upgrade Red Hat Quay</h2></div><div><div xml:lang="en-US" class="authorgroup"><span class="orgname">Red Hat OpenShift Documentation Team</span></div></div><div><a href="#idm46232682343568">Legal Notice</a></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				Upgrade Red Hat Quay
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="chapter"><a href="#upgrade_overview">1. Upgrade overview</a></span></li><li><span class="chapter"><a href="#operator-upgrade">2. Upgrading the Quay Operator Overview</a></span><ul><li><span class="section"><a href="#operator_lifecycle_manager">2.1. Operator Lifecycle Manager</a></span></li><li><span class="section"><a href="#upgrading_the_quay_operator">2.2. Upgrading the Quay Operator</a></span><ul><li><span class="section"><a href="#upgrading_quay">2.2.1. Upgrading Quay</a></span></li><li><span class="section"><a href="#upgrade-33-36">2.2.2. Notes on upgrading directly from 3.3.z or 3.4.z to 3.6</a></span></li><li><span class="section"><a href="#changing_the_update_channel_for_an_operator">2.2.3. Changing the update channel for an Operator</a></span></li><li><span class="section"><a href="#manually_approving_a_pending_operator_upgrade">2.2.4. Manually approving a pending Operator upgrade</a></span></li></ul></li><li><span class="section"><a href="#upgrading_a_quayregistry">2.3. Upgrading a QuayRegistry</a></span></li><li><span class="section"><a href="#enabling_features_in_quay_3_6">2.4. Enabling features in Quay 3.6</a></span><ul><li><span class="section"><a href="#console_monitoring_and_alerting">2.4.1. Console monitoring and alerting</a></span></li><li><span class="section"><a href="#oci_and_helm_support">2.4.2. OCI and Helm support</a></span></li></ul></li><li><span class="section"><a href="#upgrading_a_quayecosystem">2.5. Upgrading a QuayEcosystem</a></span><ul><li><span class="section"><a href="#reverting_quayecosystem_upgrade">2.5.1. Reverting QuayEcosystem Upgrade</a></span></li><li><span class="section"><a href="#supported_quayecosystem_configurations_for_upgrades">2.5.2. Supported QuayEcosystem Configurations for Upgrades</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#standalone_upgrade">3. Standalone upgrade</a></span><ul><li><span class="section"><a href="#accessing_images">3.1. Accessing images</a></span></li><li><span class="section"><a href="#upgrade_to_3_6_z_from_3_5_z">3.2. Upgrade to 3.6.z from 3.5.z</a></span><ul><li><span class="section"><a href="#target_images">3.2.1. Target images</a></span></li></ul></li><li><span class="section"><a href="#upgrade_to_3_6_z_from_3_4_z">3.3. Upgrade to 3.6.z from 3.4.z</a></span><ul><li><span class="section"><a href="#target_images_2">3.3.1. Target images</a></span></li></ul></li><li><span class="section"><a href="#upgrade_to_3_6_z_from_3_3_z">3.4. Upgrade to 3.6.z from 3.3.z</a></span><ul><li><span class="section"><a href="#target_images_3">3.4.1. Target images</a></span></li></ul></li><li><span class="section"><a href="#upgrade_to_3_5_7_from_3_4_z">3.5. Upgrade to 3.5.7 from 3.4.z</a></span><ul><li><span class="section"><a href="#target_images_4">3.5.1. Target images</a></span></li></ul></li><li><span class="section"><a href="#upgrade_to_3_4_6_from_3_3_z">3.6. Upgrade to 3.4.6 from 3.3.z</a></span><ul><li><span class="section"><a href="#target_images_5">3.6.1. Target images</a></span></li></ul></li><li><span class="section"><a href="#upgrade_to_3_3_4_from_3_2_z">3.7. Upgrade to 3.3.4 from 3.2.z</a></span><ul><li><span class="section"><a href="#target_images_6">3.7.1. Target images</a></span></li></ul></li><li><span class="section"><a href="#upgrade_to_3_2_2_from_3_1_z">3.8. Upgrade to 3.2.2 from 3.1.z</a></span><ul><li><span class="section"><a href="#target_images_7">3.8.1. Target images</a></span></li></ul></li><li><span class="section"><a href="#upgrade_to_3_1_3_from_3_0_z">3.9. Upgrade to 3.1.3 from 3.0.z</a></span><ul><li><span class="section"><a href="#target_images_8">3.9.1. Target images</a></span></li></ul></li><li><span class="section"><a href="#upgrade_to_3_0_5_from_2_9_5">3.10. Upgrade to 3.0.5 from 2.9.5</a></span><ul><li><span class="section"><a href="#upgrade-v3-concept">3.10.1. Overview of upgrade</a></span></li><li><span class="section"><a href="#quay-upgrade-prereq">3.10.2. Prerequisites</a></span></li><li><span class="section"><a href="#upgrade-v3-proc">3.10.3. Choosing upgrade type</a></span></li><li><span class="section"><a href="#sync-upgrade-v3">3.10.4. Running a synchronous upgrade</a></span></li><li><span class="section"><a href="#background-upgrade-v3">3.10.5. Running a background upgrade</a></span></li><li><span class="section"><a href="#target_images_9">3.10.6. Target images</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#qbo-operator-upgrade">4. Upgrade Quay Bridge Operator</a></span></li></ul></div><section class="chapter" id="upgrade_overview"><div class="titlepage"><div><div><h1 class="title">Chapter 1. Upgrade overview</h1></div></div></div><p>
			The upgrade procedure for Red Hat Quay depends on the type of installation you are using.
		</p><p>
			The Red Hat Quay Operator provides a simple method to deploy and manage a Red Hat Quay cluster. This is the preferred procedure for deploying Red Hat Quay on OpenShift.
		</p><p>
			The Red Hat Quay Operator should be upgraded using the <a class="link" href="https://docs.openshift.com/container-platform/4.7/operators/understanding/olm/olm-understanding-olm.html">Operator Lifecycle Manager (OLM)</a> as described in the section "Upgrading Quay using the Quay Operator".
		</p><p>
			The procedure for upgrading a proof-of-concept or highly available installation of Red Hat Quay and Clair is documented in the section "Standalone upgrade".
		</p></section><section class="chapter" id="operator-upgrade"><div class="titlepage"><div><div><h1 class="title">Chapter 2. Upgrading the Quay Operator Overview</h1></div></div></div><p>
			The Quay Operator follows a <span class="emphasis"><em>synchronized versioning</em></span> scheme, which means that each version of the Operator is tied to the version of Quay and the components that it manages. There is no field on the <code class="literal">QuayRegistry</code> custom resource which sets the version of Quay to deploy; the Operator only knows how to deploy a single version of all components. This scheme was chosen to ensure that all components work well together and to reduce the complexity of the Operator needing to know how to manage the lifecycles of many different versions of Quay on Kubernetes.
		</p><section class="section" id="operator_lifecycle_manager"><div class="titlepage"><div><div><h2 class="title">2.1. Operator Lifecycle Manager</h2></div></div></div><p>
				The Quay Operator should be installed and upgraded using the <a class="link" href="https://docs.openshift.com/container-platform/3.7/operators/understanding/olm/olm-understanding-olm.html">Operator Lifecycle Manager (OLM)</a>. When creating a <code class="literal">Subscription</code> with the default <code class="literal">approvalStrategy: Automatic</code>, OLM will automatically upgrade the Quay Operator whenever a new version becomes available.
			</p><div class="admonition warning"><div class="admonition_header">Warning</div><div><p>
					When the Quay Operator is installed via Operator Lifecycle Manager, it may be configured to support automatic or manual upgrades. This option is shown on the <span class="strong strong"><strong>Operator Hub</strong></span> page for the Quay Operator during installation. It can also be found in the Quay Operator <code class="literal">Subscription</code> object via the <code class="literal">approvalStrategy</code> field. Choosing <code class="literal">Automatic</code> means that your Quay Operator will automatically be upgraded whenever a new Operator version is released. If this is not desirable, then the <code class="literal">Manual</code> approval strategy should be selected.
				</p></div></div></section><section class="section" id="upgrading_the_quay_operator"><div class="titlepage"><div><div><h2 class="title">2.2. Upgrading the Quay Operator</h2></div></div></div><p>
				The standard approach for upgrading installed Operators on OpenShift is documented at <a class="link" href="https://docs.openshift.com/container-platform/4.7/operators/admin/olm-upgrading-operators.html">Upgrading installed Operators</a>.
			</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					In general, Red Hat Quay only supports upgrading from one minor version to the next, for example, 3.4 → 3.5. However, for 3.6, multiple upgrade paths are supported:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							3.3.z → 3.6
						</li><li class="listitem">
							3.4.z → 3.6
						</li><li class="listitem">
							3.5.z → 3.6
						</li></ul></div></div></div><p>
				For users on standalone deployments of Quay wanting to upgrade to 3.6, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#standalone_upgrade">Standalone upgrade</a> guide.
			</p><section class="section" id="upgrading_quay"><div class="titlepage"><div><div><h3 class="title">2.2.1. Upgrading Quay</h3></div></div></div><p>
					To update Quay from one minor version to the next, for example, 3.4 → 3.5, you need to change the update channel for the Quay Operator.
				</p><p>
					For <code class="literal">z</code> stream upgrades, for example, 3.4.2 → 3.4.3, updates are released in the major-minor channel that the user initially selected during install. The procedure to perform a <code class="literal">z</code> stream upgrade depends on the <code class="literal">approvalStrategy</code> as outlined above. If the approval strategy is set to <code class="literal">Automatic</code>, the Quay Operator will upgrade automatically to the newest <code class="literal">z</code> stream. This results in automatic, rolling Quay updates to newer <code class="literal">z</code> streams with little to no downtime. Otherwise, the update must be manually approved before installation can begin.
				</p></section><section class="section" id="upgrade-33-36"><div class="titlepage"><div><div><h3 class="title">2.2.2. Notes on upgrading directly from 3.3.z or 3.4.z to 3.6</h3></div></div></div><section class="section" id="upgrading_with_edge_routing_enabled"><div class="titlepage"><div><div><h4 class="title">2.2.2.1. Upgrading with edge routing enabled</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
								Previously, when running a 3.3.z version of Red Hat Quay with edge routing enabled, users were unable to upgrade to 3.4.z versions of Red Hat Quay. This has been resolved with the release of Red Hat Quay 3.6.
							</li><li class="listitem"><p class="simpara">
								When upgrading from 3.3.z to 3.6, if <code class="literal">tls.termination</code> is set to <code class="literal">none</code> in your Red Hat Quay 3.3.z deployment, it will change to HTTPS with TLS edge termination and use the default cluster wildcard certificate. For example:
							</p><pre class="programlisting language-yaml">apiVersion: redhatcop.redhat.io/v1alpha1
kind: QuayEcosystem
metadata:
  name: quay33
spec:
  quay:
    imagePullSecretName: redhat-pull-secret
    enableRepoMirroring: true
    image: quay.io/quay/quay:v3.3.4-2
    ...
    externalAccess:
      hostname: quayv33.apps.devcluster.openshift.com
      tls:
        termination: none
    database:
...</pre></li></ul></div></section><section class="section" id="upgrading_with_custom_tls_certificate_key_pairs_without_subject_alternative_names"><div class="titlepage"><div><div><h4 class="title">2.2.2.2. Upgrading with custom TLS certificate/key pairs without Subject Alternative Names</h4></div></div></div><p>
						There is an issue for customers using their own TLS certificate/key pairs without Subject Alternative Names (SANs) when upgrading from Red Hat Quay 3.3.4 to Red Hat Quay 3.6 directly. During the upgrade to Red Hat Quay 3.6, the deployment is blocked, with the error message from the Quay Operator pod logs indicating that the Quay TLS certificate must have SANs.
					</p><p>
						If possible, you should regenerate your TLS certificates with the correct hostname in the SANs. A possible workaround involves defining an environment variable in the <code class="literal">quay-app</code>, <code class="literal">quay-upgrade</code> and <code class="literal">quay-config-editor</code> pods after upgrade to enable CommonName matching:
					</p><pre class="screen"> GODEBUG=x509ignoreCN=0</pre><p>
						The <code class="literal">GODEBUG=x509ignoreCN=0</code> flag enables the legacy behavior of treating the CommonName field on X.509 certificates as a host name when no SANs are present. However, this workaround is not recommended, as it will not persist across a redeployment.
					</p></section><section class="section" id="configuring_clair_v4_when_upgrading_from_3_3_z_or_3_4_z_to_3_6_using_the_quay_operator"><div class="titlepage"><div><div><h4 class="title">2.2.2.3. Configuring Clair v4 when upgrading from 3.3.z or 3.4.z to 3.6 using the Quay Operator</h4></div></div></div><p>
						To set up Clair v4 on a new Red Hat Quay deployment on OpenShift, it is highly recommended to use the Quay Operator. By default, the Quay Operator will install or upgrade a Clair deployment along with your Red Hat Quay deployment and configure Clair security scanning automatically.
					</p><p>
						For instructions on setting up Clair v4 on OpenShift, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/manage_red_hat_quay/index#clair-openshift">Setting Up Clair on a Red Hat Quay OpenShift deployment</a>.
					</p></section></section><section class="section" id="changing_the_update_channel_for_an_operator"><div class="titlepage"><div><div><h3 class="title">2.2.3. Changing the update channel for an Operator</h3></div></div></div><p>
					The subscription of an installed Operator specifies an update channel, which is used to track and receive updates for the Operator. To upgrade the Quay Operator to start tracking and receiving updates from a newer channel, change the update channel in the <span class="strong strong"><strong>Subscription</strong></span> tab for the installed Quay Operator. For subscriptions with an <code class="literal">Automatic</code> approval strategy, the upgrade begins automatically and can be monitored on the page that lists the Installed Operators.
				</p></section><section class="section" id="manually_approving_a_pending_operator_upgrade"><div class="titlepage"><div><div><h3 class="title">2.2.4. Manually approving a pending Operator upgrade</h3></div></div></div><p>
					If an installed Operator has the approval strategy in its subscription set to <code class="literal">Manual</code>, when new updates are released in its current update channel, the update must be manually approved before installation can begin. If the Quay Operator has a pending upgrade, this status will be displayed in the list of Installed Operators. In the <code class="literal">Subscription</code> tab for the Quay Operator, you can preview the install plan and review the resources that are listed as available for upgrade. If satisfied, click <code class="literal">Approve</code> and return to the page that lists Installed Operators to monitor the progress of the upgrade.
				</p><p>
					The following image shows the <span class="strong strong"><strong>Subscription</strong></span> tab in the UI, including the update <code class="literal">Channel</code>, the <code class="literal">Approval</code> strategy, the <code class="literal">Upgrade status</code> and the <code class="literal">InstallPlan</code>:
				</p><p>
					<span class="inlinemediaobject"><img src="images/update-channel-approval-strategy.png" alt="Subscription tab including upgrade Channel and Approval strategy"/></span>
				</p><p>
					The list of Installed Operators provides a high-level summary of the current Quay installation:
				</p><p>
					<span class="inlinemediaobject"><img src="images/installed-operators-list.png" alt="Installed Operators"/></span>
				</p></section></section><section class="section" id="upgrading_a_quayregistry"><div class="titlepage"><div><div><h2 class="title">2.3. Upgrading a QuayRegistry</h2></div></div></div><p>
				When the Quay Operator starts, it immediately looks for any <code class="literal">QuayRegistries</code> it can find in the namespace(s) it is configured to watch. When it finds one, the following logic is used:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						If <code class="literal">status.currentVersion</code> is unset, reconcile as normal.
					</li><li class="listitem">
						If <code class="literal">status.currentVersion</code> equals the Operator version, reconcile as normal.
					</li><li class="listitem">
						If <code class="literal">status.currentVersion</code> does not equal the Operator version, check if it can be upgraded. If it can, perform upgrade tasks and set the <code class="literal">status.currentVersion</code> to the Operator’s version once complete. If it cannot be upgraded, return an error and leave the <code class="literal">QuayRegistry</code> and its deployed Kubernetes objects alone.
					</li></ul></div></section><section class="section" id="enabling_features_in_quay_3_6"><div class="titlepage"><div><div><h2 class="title">2.4. Enabling features in Quay 3.6</h2></div></div></div><section class="section" id="console_monitoring_and_alerting"><div class="titlepage"><div><div><h3 class="title">2.4.1. Console monitoring and alerting</h3></div></div></div><p>
					The support for monitoring Quay 3.6 in the OpenShift console requires that the Operator is installed in all namespaces. If you previously installed the Operator in a specific namespace, delete the Operator itself and reinstall it for all namespaces once the upgrade has taken place.
				</p></section><section class="section" id="oci_and_helm_support"><div class="titlepage"><div><div><h3 class="title">2.4.2. OCI and Helm support</h3></div></div></div><p>
					Support for Helm and some OCI artifacts is now enabled by default in Red Hat Quay 3.7. If you want to explicitly enable the feature, for example, if you are upgrading from a version where it is not enabled by default, you need to reconfigure your Quay deployment to enable the use of OCI artifacts using the following properties:
				</p><pre class="programlisting language-yaml">FEATURE_GENERAL_OCI_SUPPORT: true</pre></section></section><section class="section" id="upgrading_a_quayecosystem"><div class="titlepage"><div><div><h2 class="title">2.5. Upgrading a QuayEcosystem</h2></div></div></div><p>
				Upgrades are supported from previous versions of the Operator which used the <code class="literal">QuayEcosystem</code> API for a limited set of configurations. To ensure that migrations do not happen unexpectedly, a special label needs to be applied to the <code class="literal">QuayEcosystem</code> for it to be migrated. A new <code class="literal">QuayRegistry</code> will be created for the Operator to manage, but the old <code class="literal">QuayEcosystem</code> will remain until manually deleted to ensure that you can roll back and still access Quay in case anything goes wrong. To migrate an existing <code class="literal">QuayEcosystem</code> to a new <code class="literal">QuayRegistry</code>, follow these steps:
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
						Add <code class="literal">"quay-operator/migrate": "true"</code> to the <code class="literal">metadata.labels</code> of the <code class="literal">QuayEcosystem</code>.
					</p><pre class="screen">$ oc edit quayecosystem &lt;quayecosystemname&gt;</pre><pre class="programlisting language-yaml">metadata:
  labels:
    quay-operator/migrate: "true"</pre></li><li class="listitem">
						Wait for a <code class="literal">QuayRegistry</code> to be created with the same <code class="literal">metadata.name</code> as your <code class="literal">QuayEcosystem</code>. The <code class="literal">QuayEcosystem</code> will be marked with the label <code class="literal">"quay-operator/migration-complete": "true"</code>.
					</li><li class="listitem">
						Once the <code class="literal">status.registryEndpoint</code> of the new <code class="literal">QuayRegistry</code> is set, access Quay and confirm all data and settings were migrated successfully.
					</li><li class="listitem">
						When you are confident everything worked correctly, you may delete the <code class="literal">QuayEcosystem</code> and Kubernetes garbage collection will clean up all old resources.
					</li></ol></div><section class="section" id="reverting_quayecosystem_upgrade"><div class="titlepage"><div><div><h3 class="title">2.5.1. Reverting QuayEcosystem Upgrade</h3></div></div></div><p>
					If something goes wrong during the automatic upgrade from <code class="literal">QuayEcosystem</code> to <code class="literal">QuayRegistry</code>, follow these steps to revert back to using the <code class="literal">QuayEcosystem</code>:
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Delete the <code class="literal">QuayRegistry</code> using either the UI or <code class="literal">kubectl</code>:
						</p><pre class="programlisting language-sh">$ kubectl delete -n &lt;namespace&gt; quayregistry &lt;quayecosystem-name&gt;</pre></li><li class="listitem">
							If external access was provided using a <code class="literal">Route</code>, change the <code class="literal">Route</code> to point back to the original <code class="literal">Service</code> using the UI or <code class="literal">kubectl</code>.
						</li></ol></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
						If your <code class="literal">QuayEcosystem</code> was managing the Postgres database, the upgrade process will migrate your data to a new Postgres database managed by the upgraded Operator. Your old database will not be changed or removed but Quay will no longer use it once the migration is complete. If there are issues during the data migration, the upgrade process will exit and it is recommended that you continue with your database as an unmanaged component.
					</p></div></div></section><section class="section" id="supported_quayecosystem_configurations_for_upgrades"><div class="titlepage"><div><div><h3 class="title">2.5.2. Supported QuayEcosystem Configurations for Upgrades</h3></div></div></div><p>
					The Quay Operator will report errors in its logs and in <code class="literal">status.conditions</code> if migrating a <code class="literal">QuayEcosystem</code> component fails or is unsupported. All unmanaged components should migrate successfully because no Kubernetes resources need to be adopted and all the necessary values are already provided in Quay’s <code class="literal">config.yaml</code>.
				</p><p>
					<span class="strong strong"><strong>Database</strong></span>
				</p><p>
					Ephemeral database not supported (<code class="literal">volumeSize</code> field must be set).
				</p><p>
					<span class="strong strong"><strong>Redis</strong></span>
				</p><p>
					Nothing special needed.
				</p><p>
					<span class="strong strong"><strong>External Access</strong></span>
				</p><p>
					Only passthrough <code class="literal">Route</code> access is supported for automatic migration. Manual migration required for other methods.
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<code class="literal">LoadBalancer</code> without custom hostname: After the <code class="literal">QuayEcosystem</code> is marked with label <code class="literal">"quay-operator/migration-complete": "true"</code>, delete the <code class="literal">metadata.ownerReferences</code> field from existing <code class="literal">Service</code> <span class="emphasis"><em>before</em></span> deleting the <code class="literal">QuayEcosystem</code> to prevent Kubernetes from garbage collecting the <code class="literal">Service</code> and removing the load balancer. A new <code class="literal">Service</code> will be created with <code class="literal">metadata.name</code> format <code class="literal">&lt;QuayEcosystem-name&gt;-quay-app</code>. Edit the <code class="literal">spec.selector</code> of the existing <code class="literal">Service</code> to match the <code class="literal">spec.selector</code> of the new <code class="literal">Service</code> so traffic to the old load balancer endpoint will now be directed to the new pods. You are now responsible for the old <code class="literal">Service</code>; the Quay Operator will not manage it.
						</li><li class="listitem">
							<code class="literal">LoadBalancer</code>/<code class="literal">NodePort</code>/<code class="literal">Ingress</code> with custom hostname: A new <code class="literal">Service</code> of type <code class="literal">LoadBalancer</code> will be created with <code class="literal">metadata.name</code> format <code class="literal">&lt;QuayEcosystem-name&gt;-quay-app</code>. Change your DNS settings to point to the <code class="literal">status.loadBalancer</code> endpoint provided by the new <code class="literal">Service</code>.
						</li></ul></div><p>
					<span class="strong strong"><strong>Clair</strong></span>
				</p><p>
					Nothing special needed.
				</p><p>
					<span class="strong strong"><strong>Object Storage</strong></span>
				</p><p>
					<code class="literal">QuayEcosystem</code> did not have a managed object storage component, so object storage will always be marked as unmanaged. Local storage is not supported.
				</p><p>
					<span class="strong strong"><strong>Repository Mirroring</strong></span>
				</p><p>
					Nothing special needed.
				</p></section></section></section><section class="chapter" id="standalone_upgrade"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Standalone upgrade</h1></div></div></div><p>
			In general, Red Hat Quay supports upgrades from a prior (N-1) minor version only. For example, upgrading directly from Red Hat Quay 3.0.5 to the latest version of 3.5 is not supported. Instead, users would have to upgrade as follows:
		</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
					3.0.5 → 3.1.3
				</li><li class="listitem">
					3.1.3 → 3.2.2
				</li><li class="listitem">
					3.2.2 → 3.3.4
				</li><li class="listitem">
					3.3.4 → 3.4.z
				</li><li class="listitem">
					3.4.z → 3.5.z
				</li></ol></div><p>
			This is required to ensure that any necessary database migrations are done correctly and in the right order during the upgrade.
		</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				Red Hat Quay 3.6 supports direct, single-step upgrade from 3.3.z and from 3.4.z. This exception to the normal, prior minor version-only, upgrade simplifies the upgrade procedure for customers on older releases.
			</p></div></div><p>
			For users wanting to upgrade via the Quay Operator, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrading_quay_by_upgrading_the_quay_operator">Upgrading Quay by upgrading the Quay Operator</a>.
		</p><p>
			This document describes the steps needed to perform each individual upgrade. Determine your current version and then follow the steps in sequential order, starting with your current version and working up to your desired target version.
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_6_z_from_3_5_z">Upgrade to 3.6.z from 3.5.z</a>
				</li><li class="listitem">
					<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_6_z_from_3_4_z">Upgrade to 3.6.z from 3.4.z</a>
				</li><li class="listitem">
					<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_6_z_from_3_3_z">Upgrade to 3.6.z from 3.3.z</a>
				</li><li class="listitem">
					<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_5_7_from_3_4_z">Upgrade to 3.5.z from 3.4.z</a>
				</li><li class="listitem">
					<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_4_6_from_3_3_z">Upgrade to 3.4.z from 3.3.4</a>
				</li><li class="listitem">
					<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_3_4_from_3_2_z">Upgrade to 3.3.4 from 3.2.2</a>
				</li><li class="listitem">
					<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_2_2_from_3_1_z">Upgrade to 3.2.2 from 3.1.3</a>
				</li><li class="listitem">
					<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_1_3_from_3_0_z">Upgrade to 3.1.3 from 3.0.5</a>
				</li><li class="listitem">
					<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_0_5_from_2_9_5">Upgrade to 3.0.5 from 2.9.5</a>
				</li></ul></div><p>
			See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3/html-single/red_hat_quay_release_notes/index">Red Hat Quay Release Notes</a> for information on features for individual releases.
		</p><p>
			The general procedure for a manual upgrade consists of the following steps:
		</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
					Stop the Quay and Clair containers.
				</li><li class="listitem">
					Backup the database and image storage (optional but recommended).
				</li><li class="listitem">
					Start Clair using the new version of the image.
				</li><li class="listitem">
					Wait until Clair is ready to accept connections before starting the new version of Quay.
				</li></ol></div><section class="section" id="accessing_images"><div class="titlepage"><div><div><h2 class="title">3.1. Accessing images</h2></div></div></div><p>
				Images for Quay 3.4.0 and later are available from <a class="link" href="https://registry.redhat.io">registry.redhat.io</a> and <a class="link" href="https://registry.access.redhat.com">registry.access.redhat.com</a>, with authentication set up as described in <a class="link" href="https://access.redhat.com/RegistryAuthentication">Red Hat Container Registry Authentication</a>.
			</p><p>
				Images for Quay 3.3.4 and earlier are available from <a class="link" href="https://quay.io">quay.io</a>, with authentication set up as described in <a class="link" href="https://access.redhat.com/solutions/3533201">Accessing Red Hat Quay without a CoreOS login</a>.
			</p></section><section class="section" id="upgrade_to_3_6_z_from_3_5_z"><div class="titlepage"><div><div><h2 class="title">3.2. Upgrade to 3.6.z from 3.5.z</h2></div></div></div><section class="section" id="target_images"><div class="titlepage"><div><div><h3 class="title">3.2.1. Target images</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay:</strong></span> registry.redhat.io/quay/quay-rhel8:v3.7.0
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair:</strong></span> registry.redhat.io/quay/clair-rhel8:v3.7.0
						</li><li class="listitem">
							<span class="strong strong"><strong>PostgreSQL:</strong></span> registry.redhat.io/rhel8/postgresql-10:1
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis:</strong></span> registry.redhat.io/rhel8/redis-5:1
						</li></ul></div></section></section><section class="section" id="upgrade_to_3_6_z_from_3_4_z"><div class="titlepage"><div><div><h2 class="title">3.3. Upgrade to 3.6.z from 3.4.z</h2></div></div></div><p>
				Upgrading to Red Hat Quay 3.6 from 3.4.z requires a database migration which does not support downgrading back to a prior version of Red Hat Quay. Please back up your database before performing this migration.
			</p><p>
				Users will also need to configure a completely new Clair v4 instance to replace the old Clair v2 when upgrading from 3.4.z. For instructions on configuring Clair v4, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/manage_red_hat_quay/index#clair-standalone">Setting up Clair on a non-OpenShift Red Hat Quay deployment</a>.
			</p><section class="section" id="target_images_2"><div class="titlepage"><div><div><h3 class="title">3.3.1. Target images</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay:</strong></span> registry.redhat.io/quay/quay-rhel8:v3.7.0
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair:</strong></span> registry.redhat.io/quay/clair-rhel8:v3.7.0
						</li><li class="listitem">
							<span class="strong strong"><strong>PostgreSQL:</strong></span> registry.redhat.io/rhel8/postgresql-10:1
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis:</strong></span> registry.redhat.io/rhel8/redis-5:1
						</li></ul></div></section></section><section class="section" id="upgrade_to_3_6_z_from_3_3_z"><div class="titlepage"><div><div><h2 class="title">3.4. Upgrade to 3.6.z from 3.3.z</h2></div></div></div><p>
				Upgrading to Red Hat Quay 3.6.z from 3.3.z requires a database migration which does not support downgrading back to a prior version of Red Hat Quay. Please back up your database before performing this migration.
			</p><p>
				Users will also need to configure a completely new Clair v4 instance to replace the old Clair v2 when upgrading from 3.3.z. For instructions on configuring Clair v4, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/manage_red_hat_quay/index#clair-standalone">Setting up Clair on a non-OpenShift Red Hat Quay deployment</a>.
			</p><section class="section" id="target_images_3"><div class="titlepage"><div><div><h3 class="title">3.4.1. Target images</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay:</strong></span> registry.redhat.io/quay/quay-rhel8:v3.7.0
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair:</strong></span> registry.redhat.io/quay/clair-rhel8:v3.7.0
						</li><li class="listitem">
							<span class="strong strong"><strong>PostgreSQL:</strong></span> registry.redhat.io/rhel8/postgresql-10:1
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis:</strong></span> registry.redhat.io/rhel8/redis-5:1
						</li></ul></div></section></section><section class="section" id="upgrade_to_3_5_7_from_3_4_z"><div class="titlepage"><div><div><h2 class="title">3.5. Upgrade to 3.5.7 from 3.4.z</h2></div></div></div><section class="section" id="target_images_4"><div class="titlepage"><div><div><h3 class="title">3.5.1. Target images</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay:</strong></span> registry.redhat.io/quay/quay-rhel8:v3.5.7
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair:</strong></span> registry.redhat.io/quay/clair-rhel8:v3.5.7
						</li><li class="listitem">
							<span class="strong strong"><strong>PostgreSQL:</strong></span> registry.redhat.io/rhel8/postgresql-10:1
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis:</strong></span> registry.redhat.io/rhel8/redis-5:1
						</li></ul></div></section></section><section class="section" id="upgrade_to_3_4_6_from_3_3_z"><div class="titlepage"><div><div><h2 class="title">3.6. Upgrade to 3.4.6 from 3.3.z</h2></div></div></div><p>
				Upgrading to Quay 3.4 requires a database migration which does not support downgrading back to a prior version of Quay. Please back up your database before performing this migration.
			</p><section class="section" id="target_images_5"><div class="titlepage"><div><div><h3 class="title">3.6.1. Target images</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay:</strong></span> registry.redhat.io/quay/quay-rhel8:v3.4.6
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair:</strong></span> registry.redhat.io/quay/clair-rhel8:v3.4.6
						</li><li class="listitem">
							<span class="strong strong"><strong>PostgreSQL:</strong></span> registry.redhat.io/rhel8/postgresql-10:1
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis:</strong></span> registry.redhat.io/rhel8/redis-5:1
						</li></ul></div></section></section><section class="section" id="upgrade_to_3_3_4_from_3_2_z"><div class="titlepage"><div><div><h2 class="title">3.7. Upgrade to 3.3.4 from 3.2.z</h2></div></div></div><section class="section" id="target_images_6"><div class="titlepage"><div><div><h3 class="title">3.7.1. Target images</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay:</strong></span> quay.io/redhat/quay:v3.3.4
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair:</strong></span> quay.io/redhat/clair-jwt:v3.3.4
						</li><li class="listitem">
							<span class="strong strong"><strong>PostgreSQL:</strong></span> rhscl/postgresql-96-rhel7
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis:</strong></span> registry.access.redhat.com/rhscl/redis-32-rhel7
						</li></ul></div></section></section><section class="section" id="upgrade_to_3_2_2_from_3_1_z"><div class="titlepage"><div><div><h2 class="title">3.8. Upgrade to 3.2.2 from 3.1.z</h2></div></div></div><p>
				Once your cluster is running any Red Hat Quay 3.1.z version, to upgrade your cluster to 3.2.2 you must bring down your entire cluster and make a small change to the configuration before bringing it back up with the 3.2.2 version.
			</p><div class="admonition warning"><div class="admonition_header">Warning</div><div><p>
					Once you set the value of DATABASE_SECRET_KEY in this procedure, do not ever change it. If you do so, then existing robot accounts, API tokens, etc. cannot be used anymore. You would have to create a new robot account and API tokens to use with Quay.
				</p></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
						Take all hosts in the Red Hat Quay cluster out of service.
					</li><li class="listitem"><p class="simpara">
						Generate some random data to use as a database secret key. For example:
					</p><pre class="screen">$ openssl rand -hex 48
2d023adb9c477305348490aa0fd9c</pre></li><li class="listitem"><p class="simpara">
						Add a new DATABASE_SECRET_KEY field to your <code class="literal">config.yaml</code> file. For example:
					</p><pre class="screen">DATABASE_SECRET_KEY: "2d023adb9c477305348490aa0fd9c"</pre><div class="admonition note"><div class="admonition_header">Note</div><div><p>
							For an OpenShift installation, the <code class="literal">config.yaml</code> file is stored as a secret.
						</p></div></div></li><li class="listitem">
						Bring up one <code class="literal">Quay</code> container to complete the migration to 3.2.2.
					</li><li class="listitem">
						Once the migration is done, make sure the same <code class="literal">config.yaml</code> is available on all nodes and bring up the new quay 3.2.2 service on those nodes.
					</li><li class="listitem">
						Start 3.0.z versions of quay-builder and Clair to replace any instances of those containers you want to return to your cluster.
					</li></ol></div><section class="section" id="target_images_7"><div class="titlepage"><div><div><h3 class="title">3.8.1. Target images</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay:</strong></span> quay.io/redhat/quay:v3.2.2
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair:</strong></span> quay.io/redhat/clair-jwt:v3.2.2
						</li><li class="listitem">
							<span class="strong strong"><strong>PostgreSQL:</strong></span> rhscl/postgresql-96-rhel7
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis:</strong></span> registry.access.redhat.com/rhscl/redis-32-rhel7
						</li></ul></div></section></section><section class="section" id="upgrade_to_3_1_3_from_3_0_z"><div class="titlepage"><div><div><h2 class="title">3.9. Upgrade to 3.1.3 from 3.0.z</h2></div></div></div><section class="section" id="target_images_8"><div class="titlepage"><div><div><h3 class="title">3.9.1. Target images</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay:</strong></span> quay.io/redhat/quay:v3.1.3
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair:</strong></span> quay.io/redhat/clair-jwt:v3.1.3
						</li><li class="listitem">
							<span class="strong strong"><strong>PostgreSQL:</strong></span> rhscl/postgresql-96-rhel7
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis:</strong></span> registry.access.redhat.com/rhscl/redis-32-rhel7
						</li></ul></div></section></section><section class="section" id="upgrade_to_3_0_5_from_2_9_5"><div class="titlepage"><div><div><h2 class="title">3.10. Upgrade to 3.0.5 from 2.9.5</h2></div></div></div><p>
				For the 2.9.5 to 3.0.5 upgrade, you can either do the whole upgrade with Red Hat Quay down (synchronous upgrade) or only bring down Red Hat Quay for a few minutes and have the bulk of the upgrade continue with Red Hat Quay running (background upgrade).
			</p><p>
				A background upgrade could take longer to run the upgrade depending on how many tags need to be processed. However, there is less total downtime. The downside of a background upgrade is that you will not have access to the latest features until the upgrade completes. The cluster runs from the Quay v3 container in v2 compatibility mode until the upgrade is complete.
			</p><section class="section" id="upgrade-v3-concept"><div class="titlepage"><div><div><h3 class="title">3.10.1. Overview of upgrade</h3></div></div></div><p>
					Follow the procedure below if you are starting with a Red Hat Quay 2.y.z cluster. Before upgrading to the latest Red Hat Quay 3.x version, you must first migrate that cluster to 3.0.5, as described <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.7/html-single/upgrade_red_hat_quay/index#upgrade_to_3_0_5_from_2_9_5">here</a>. Once your cluster is running 3.0.5, you can then upgrade to the latest 3.x version by sequentially upgrading to each minor version in turn. For example:
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
							3.0.5 → 3.1.3
						</li><li class="listitem">
							3.1.3 → 3.2.2
						</li><li class="listitem">
							3.2.2 → 3.3.4
						</li><li class="listitem">
							3.3.4 → 3.4.z
						</li></ol></div><p>
					Before beginning your Red Hat Quay 2.y.z to 3.0 upgrade, please note the following:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Synchronous upgrade</strong></span>: For a synchronous upgrade, expect less than one hour of total downtime for small installations. Consider a small installation to contain a few thousand container image tags or fewer. For that size installation, you could probably get by with just a couple hours of scheduled downtime. The entire Red Hat Quay service is down for the duration, so if you were to try a synchronous upgrade on a registry with millions of tags, you could potentially be down for several days.
						</li><li class="listitem">
							<span class="strong strong"><strong>Background upgrade</strong></span>: For a background upgrade (also called a compatibility mode upgrade), after a short shutdown your Red Hat Quay cluster upgrade runs in the background. For large Red Hat Quay registries, this could take weeks to complete, but the cluster continues to operate in v2 mode for the duration of the upgrade. As a point of reference, one Red Hat Quay v3 upgrade took four days to process approximately 30 million tags across six machines.
						</li><li class="listitem">
							<span class="strong strong"><strong>Full features on completion</strong></span>: Before you have access to features associated with Docker version 2, schema 2 changes (such as support for containers of different architectures), the entire migration must complete. Other v3 features are immediately available when you switch over.
						</li><li class="listitem">
							<span class="strong strong"><strong>Upgrade complete</strong></span>: When the upgrade is complete, you need to set <span class="strong strong"><strong>V3_UPGRADE_MODE: complete</strong></span> in the Red Hat Quay <code class="literal">config.yaml</code> file for the new features to be available. All new Red Hat Quay v3 installations automatically have that set.
						</li></ul></div></section><section class="section" id="quay-upgrade-prereq"><div class="titlepage"><div><div><h3 class="title">3.10.2. Prerequisites</h3></div></div></div><p>
					To assure the best results, we recommend the following prerequisites:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Back up your Red Hat Quay database before starting the upgrade (doing regular backups is a general best practice). A good time to do this is right after you have taken down the Red Hat Quay cluster to do the upgrade.
						</li><li class="listitem">
							Back up your storage (also a general best practice).
						</li><li class="listitem"><p class="simpara">
							Upgrade your current Red Hat Quay 2.y.z setup to the latest 2.9.z version (currently 2.9.5) before starting the v3 upgrade. To do that:
						</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
									While the Red Hat Quay cluster is still running, take one node and change the <code class="literal">Quay</code> container on that system to a <code class="literal">Quay</code> container that is running the latest 2.9.z version.
								</li><li class="listitem">
									Wait for all the database migrations to run, bringing the database up to the latest 2.9.z version. This should only take a few minutes to a half an hour.
								</li><li class="listitem">
									Once that is done, replace the <code class="literal">Quay</code> container on all the existing nodes with the same latest 2.9.z version. With the entire Red Hat Quay cluster on the new version, you can proceed to the v3 upgrade.
								</li></ul></div></li></ul></div></section><section class="section" id="upgrade-v3-proc"><div class="titlepage"><div><div><h3 class="title">3.10.3. Choosing upgrade type</h3></div></div></div><p>
					Choose between a synchronous upgrade (complete the upgrade in downtime) and a background upgrade (complete the upgrade while Red Hat Quay is still running). Both of these major-release upgrades require that the Red Hat Quay cluster be down for at least a short period of time.
				</p><p>
					Regardless of which upgrade type you choose, during the time that the Red Hat Quay cluster is down, if you are using builder and Clair images, you need to also upgrade to those new images:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Builder</strong></span>: quay.io/redhat/quay-builder:v3.0.5
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair</strong></span>: quay.io/redhat/clair-jwt:v3.0.5
						</li></ul></div><p>
					Both of those images are available from the registry.redhat.io/quay repository.
				</p></section><section class="section" id="sync-upgrade-v3"><div class="titlepage"><div><div><h3 class="title">3.10.4. Running a synchronous upgrade</h3></div></div></div><p>
					To run a synchronous upgrade, where your whole cluster is down for the entire upgrade, do the following:
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
							Take down your entire Red Hat Quay cluster, including any quay-builder and Clair containers.
						</li><li class="listitem"><p class="simpara">
							Add the following setting to the <code class="literal">config.yaml</code> file on all nodes:
						</p><div class="informalexample"><p>
							V3_UPGRADE_MODE: complete
						</p></div></li><li class="listitem"><p class="simpara">
							Pull and start up the v3 container on a single node and wait for however long it takes to do the upgrade (it will take a few minutes). Use the following container or later:
						</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
									<span class="strong strong"><strong>Quay</strong></span>: quay.io/redhat/quay:v3.0.5
								</p><p class="simpara">
									Note that the <code class="literal">Quay</code> container comes up on ports 8080 and 8443 for Red Hat Quay 3, instead of 80 and 443, as they did for Red Hat Quay 2. Therefore, we recommend remapping 8080 and 8443 into 80 and 443, respectively, as shown in this example:
								</p></li></ul></div><pre class="screen"># docker run --restart=always -p 80:8080 -p 443:8443 \
   --sysctl net.core.somaxconn=4096 \
   --privileged=true \
   -v /mnt/quay/config:/conf/stack:Z \
   -v /mnt/quay/storage:/datastorage:Z \
   -d quay.io/redhat/quay:v3.0.5</pre></li><li class="listitem">
							After the upgrade completes, bring the Red Hat Quay 3 container up on all other nodes.
						</li><li class="listitem">
							Start 3.0.z versions of quay-builder and Clair to replace any instances of those containers you want to return to your cluster.
						</li><li class="listitem">
							Verify that Red Hat Quay is working, including pushes and pulls of containers compatible with Docker version 2, schema 2. This can include windows container images and images of different computer architectures (arm, ppc, etc.).
						</li></ol></div></section><section class="section" id="background-upgrade-v3"><div class="titlepage"><div><div><h3 class="title">3.10.5. Running a background upgrade</h3></div></div></div><p>
					To run a background upgrade, you need only bring down your cluster for a short period of time on two occasions. When you bring the cluster back up after the first downtime, the quay v3 container runs in v2 compatibility mode as it backfills the database. This background process can take hours or even days to complete. Background upgrades are recommended for large installations where downtime of more than a few hours would be a problem.
				</p><p>
					For this type of upgrade, you put Red Hat Quay into a compatibility mode, where you have a <code class="literal">Quay</code> 3 container running, but it is running on the old data model while the upgrade completes. Here’s what you do:
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Pull the Red Hat Quay 3 container to all the nodes. Use the following container or later:
						</p><div class="informalexample"><p>
							quay.io/redhat/quay:v3.0.5
						</p></div></li><li class="listitem">
							Take down your entire Red Hat Quay cluster, including any quay-builder and Clair containers.
						</li><li class="listitem"><p class="simpara">
							Edit the <code class="literal">config.yaml</code> file on each node and set the upgrade mode to background as follows:
						</p><div class="informalexample"><p>
							V3_UPGRADE_MODE: background
						</p></div></li><li class="listitem"><p class="simpara">
							Bring the Red Hat Quay 3 container up on a single node and wait for the migrations to complete (should take a few minutes maximum). Here is an example of that command:
						</p><p class="simpara">
							Note that the <code class="literal">Quay</code> container comes up on ports 8080 and 8443 for Red Hat Quay 3, instead of 80 and 443, as they did for Red Hat Quay 2. Therefore, we recommend remapping 8080 and 8443 into 80 and 443, respectively, as shown in this example:
						</p><pre class="screen"># docker run --restart=always -p 80:8080 -p 443:8443 \
   --sysctl net.core.somaxconn=4096 \
   --privileged=true \
   -v /mnt/quay/config:/conf/stack:Z \
   -v /mnt/quay/storage:/datastorage:Z \
   -d quay.io/redhat/quay:v3.0.5</pre></li><li class="listitem">
							Bring the Red Hat Quay 3 container up on all the other nodes.
						</li><li class="listitem">
							Monitor the <code class="literal">/upgradeprogress</code> API endpoint until it reports done enough to move to the next step (the status reaches 99%). For example, view <code class="literal"><a class="link" href="https://myquay.example.com/upgradeprogress">https://myquay.example.com/upgradeprogress</a></code> or use some other tool to query the API.
						</li><li class="listitem">
							Once the background process is far enough along you have to schedule another maintenance window.
						</li><li class="listitem">
							During your scheduled maintenance, take the entire Red Hat Quay cluster down.
						</li><li class="listitem"><p class="simpara">
							Edit the <code class="literal">config.yaml</code> file on each node and set the upgrade mode to <code class="literal">complete</code> as follows:
						</p><pre class="programlisting language-yaml">V3_UPGRADE_MODE: complete</pre></li><li class="listitem">
							Bring Red Hat Quay back up on one node to have it do a final check.
						</li><li class="listitem">
							Once the final check is done, bring Red Hat Quay v3 back up on all the other nodes.
						</li><li class="listitem">
							Start 3.0.z versions of quay-builder and Clair to replace any instances of those containers you want to return to your cluster.
						</li><li class="listitem">
							Verify Quay is working, including pushes and pulls of containers compatible with Docker version 2, schema 2. This can include windows container images and images of different computer architectures (arm, ppc, etc.).
						</li></ol></div></section><section class="section" id="target_images_9"><div class="titlepage"><div><div><h3 class="title">3.10.6. Target images</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay:</strong></span> quay.io/redhat/quay:v3.0.5
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair:</strong></span> quay.io/redhat/clair-jwt:v3.0.5
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis:</strong></span> registry.access.redhat.com/rhscl/redis-32-rhel7
						</li><li class="listitem">
							<span class="strong strong"><strong>PostgreSQL:</strong></span> rhscl/postgresql-96-rhel7
						</li><li class="listitem">
							<span class="strong strong"><strong>Builder:</strong></span> quay.io/redhat/quay-builder:v3.0.5
						</li></ul></div></section></section></section><section class="chapter" id="qbo-operator-upgrade"><div class="titlepage"><div><div><h1 class="title">Chapter 4. Upgrade Quay Bridge Operator</h1></div></div></div><p>
			To upgrade the Quay Bridge Operator (QBO), change the Channel Subscription update channel in the Subscription tab to the desired channel.
		</p><p>
			When upgrading QBO from version 3.5 to 3.6, a number of extra steps are required:
		</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
					You need to create a new <code class="literal">QuayIntegration</code> custom resource. This can be completed in the Web Console or from the command line.
				</p><div class="formalpara"><p class="title"><strong>upgrade-quay-integration.yaml</strong></p><p>
						
<pre class="programlisting language-yaml">- apiVersion: quay.redhat.com/v1
  kind: QuayIntegration
  metadata:
    name: example-quayintegration-new
  spec:
    clusterID: openshift <span id="CO1-1"/><span class="callout">1</span>
    credentialsSecret:
      name: quay-integration
      namespace: openshift-operators
    insecureRegistry: false
    quayHostname: https://registry-quay-quay35.router-default.apps.cluster.openshift.com</pre>
					</p></div><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO1-1"><span class="callout">1</span></a> </dt><dd><div class="para">
							Make sure that the <code class="literal">clusterID</code> matches the value for the existing <code class="literal">QuayIntegration</code> resource.
						</div></dd></dl></div></li><li class="listitem"><p class="simpara">
					Create the new <code class="literal">QuayIntegration</code> custom resource:
				</p><pre class="programlisting language-bash">$ oc create -f upgrade-quay-integration.yaml</pre></li><li class="listitem">
					Delete the old <code class="literal">QuayIntegration</code> custom resource.
				</li><li class="listitem"><p class="simpara">
					Delete the old <code class="literal">mutatingwebhookconfigurations</code>:
				</p><pre class="programlisting language-bash">$ oc delete mutatingwebhookconfigurations.admissionregistration.k8s.io quay-bridge-operator</pre></li></ol></div></section><div><div xml:lang="en-US" class="legalnotice" id="idm46232682343568"><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"/>© 2022 Red Hat, Inc.
	</div><div class="para">
		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). An explanation of CC-BY-SA is available at <a class="uri" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>. In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
	</div><div class="para">
		Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.
	</div><div class="para">
		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Linux</span>® is the registered trademark of Linus Torvalds in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Java</span>® is a registered trademark of Oracle and/or its affiliates.
	</div><div class="para">
		<span class="trademark">XFS</span>® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries.
	</div><div class="para">
		<span class="trademark">MySQL</span>® is a registered trademark of MySQL AB in the United States, the European Union and other countries.
	</div><div class="para">
		<span class="trademark">Node.js</span>® is an official trademark of Joyent. Red Hat is not formally related to or endorsed by the official Joyent Node.js open source or commercial project.
	</div><div class="para">
		The <span class="trademark">OpenStack</span>® Word Mark and OpenStack logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.
	</div><div class="para">
		All other trademarks are the property of their respective owners.
	</div></div></div></div></div></div><script type="text/javascript">
                        jQuery(document).ready(function() {
                            initSwitchery();
                            jQuery('pre[class*="language-"]').each(function(i, block){hljs.highlightBlock(block);});
                        });
                    </script></body></html>
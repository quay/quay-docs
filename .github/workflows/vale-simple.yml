name: Vale Linting

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  vale:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Vale
        run: |
          # Download and install latest Vale
          VALE_VERSION="3.13.0"
          wget -q "https://github.com/errata-ai/vale/releases/download/v${VALE_VERSION}/vale_${VALE_VERSION}_Linux_64-bit.tar.gz"
          tar -xzf "vale_${VALE_VERSION}_Linux_64-bit.tar.gz" -C /usr/local/bin
          chmod +x /usr/local/bin/vale
          vale --version

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.adoc
            **/*.md

      - name: Verify Vale configuration
        working-directory: ${{ github.workspace }}
        run: |
          echo "Current directory: $(pwd)"
          echo "Checking if .vale.ini exists:"
          ls -la .vale.ini || echo ".vale.ini not found in root"
          echo "Checking Vale version:"
          vale --version
          echo "Checking Vale configuration..."
          vale ls-config || echo "Could not list config"
          echo "Syncing Vale styles (this downloads the package)..."
          vale sync || echo "Vale sync completed (may show warnings)"
          echo "Verifying styles were downloaded:"
          ls -la .vale/styles/ || echo "Styles directory not found"

      - name: Run Vale and post PR comments
        uses: actions/github-script@v7
        if: steps.changed-files.outputs.any_changed == 'true'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            
            // Get changed files
            const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ').filter(f => f && (f.endsWith('.adoc') || f.endsWith('.md')));
            
            if (changedFiles.length === 0) {
              console.log('No changed files to check');
              return;
            }
            
            console.log(`Checking files: ${changedFiles.join(', ')}`);
            
            // Verify Vale can see the config
            try {
              const configOutput = execSync('vale ls-config', { encoding: 'utf-8' });
              console.log('Vale configuration:');
              console.log(configOutput);
            } catch (error) {
              console.log('Warning: Could not get Vale config:', error.message);
            }
            
            // Run Vale and get JSON output
            // Ensure we're in the workspace directory
            process.chdir(process.env.GITHUB_WORKSPACE || '.');
            
            let valeResults = {};
            try {
              // First try to get output from stdout
              const valeOutput = execSync(`vale --output=JSON ${changedFiles.join(' ')}`, {
                encoding: 'utf-8',
                maxBuffer: 10 * 1024 * 1024,
                stdio: ['pipe', 'pipe', 'pipe'],
                cwd: process.env.GITHUB_WORKSPACE
              });
              console.log('Vale stdout:', valeOutput);
              if (valeOutput && valeOutput.trim()) {
                valeResults = JSON.parse(valeOutput);
              } else {
                console.log('Vale returned empty output - no issues found');
                return;
              }
            } catch (error) {
              // Vale returns non-zero exit code when issues are found, but still outputs JSON
              console.log('Vale exit code:', error.status);
              console.log('Vale stdout:', error.stdout);
              console.log('Vale stderr:', error.stderr);
              
              const output = error.stdout || error.stderr || '';
              try {
                if (output && output.trim()) {
                  valeResults = JSON.parse(output);
                } else {
                  console.log('No Vale output to parse - this might mean no issues were found');
                  console.log('Testing Vale with a simple command to verify it works:');
                  try {
                    const testOutput = execSync('vale --help', { encoding: 'utf-8' });
                    console.log('Vale is working, but found no issues in changed files');
                  } catch (testError) {
                    console.log('Vale test failed:', testError.message);
                  }
                  return;
                }
              } catch (parseError) {
                console.log('Could not parse Vale output as JSON');
                console.log('Raw output:', output);
                console.log('Parse error:', parseError.message);
                return;
              }
            }
            
            console.log('Vale results:', JSON.stringify(valeResults, null, 2));
            console.log('Number of files with issues:', Object.keys(valeResults).length);
            
            // Post comments for each file with issues
            let commentCount = 0;
            for (const [file, alerts] of Object.entries(valeResults)) {
              if (!alerts || alerts.length === 0) continue;
              
              // Read file to get line content
              let fileContent = [];
              try {
                fileContent = fs.readFileSync(file, 'utf-8').split('\n');
              } catch (error) {
                console.log(`Could not read file ${file}: ${error.message}`);
                continue;
              }
              
              // Group alerts by line number
              const alertsByLine = {};
              alerts.forEach(alert => {
                const line = alert.Line || 1;
                if (!alertsByLine[line]) {
                  alertsByLine[line] = [];
                }
                alertsByLine[line].push(alert);
              });
              
              // Post comment for each line with issues
              for (const [lineNum, lineAlerts] of Object.entries(alertsByLine)) {
                const line = parseInt(lineNum);
                const severity = lineAlerts[0].Severity || 'warning';
                const check = lineAlerts[0].Check || '';
                
                const body = lineAlerts.map(alert => {
                  const message = alert.Message || '';
                  const link = alert.Link ? `\n\n[Learn more](${alert.Link})` : '';
                  return `**${alert.Severity || 'warning'}**: ${message}${link}`;
                }).join('\n\n---\n\n') + `\n\n*Rule: \`${check}\`*`;
                
                try {
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.issue.number,
                    commit_id: context.payload.pull_request.head.sha,
                    path: file,
                    line: line,
                    body: body
                  });
                  commentCount++;
                } catch (error) {
                  console.log(`Error posting comment for ${file}:${line}: ${error.message}`);
                }
              }
            }
            
            console.log(`Posted ${commentCount} comment(s) on the PR`);


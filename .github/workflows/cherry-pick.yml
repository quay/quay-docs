name: Cherry Pick on Comment

on:
  issue_comment:
    types: [created]

jobs:
  cherry_pick:
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/cherry-pick') }}
    steps:
      - name: Extract branch name from comment
        id: extract_branch
        run: |
          echo "branch=$(echo "${{ github.event.comment.body }}" | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Checkout the pull request branch
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Get the last commit SHA from pull request
        id: get_sha
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Checkout the target branch
        run: |
          git fetch origin ${{ steps.extract_branch.outputs.branch }}
          git checkout ${{ steps.extract_branch.outputs.branch }}

      - name: Cherry pick the commit
        run: git cherry-pick ${{ steps.get_sha.outputs.sha }}

      - name: Push the changes
        env:
          GH_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: git push https://${GH_PAT}@github.com/${{ github.repository }} HEAD:${{ steps.extract_branch.outputs.branch }}
